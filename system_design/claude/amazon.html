<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Design: Amazon</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #0f0f0f; color: #e0e0e0; line-height: 1.7; }
h1 { color: #ff9900; border-bottom: 3px solid #ff9900; padding-bottom: 10px; font-size: 2.2em; }
h2 { color: #ffaa33; margin-top: 40px; font-size: 1.6em; border-left: 4px solid #ffaa33; padding-left: 12px; }
h3 { color: #ffcc66; font-size: 1.3em; }
h4 { color: #ffdd88; }
.section { background: #1a1a2e; border-radius: 10px; padding: 25px; margin: 20px 0; border: 1px solid #333; }
.diagram-container { background: #0d1117; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center; overflow-x: auto; }
.example { background: #1e293b; border-left: 4px solid #f59e0b; padding: 15px 20px; margin: 15px 0; border-radius: 0 8px 8px 0; }
.example strong { color: #f59e0b; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; }
th { background: #2a2a4a; color: #ffaa33; padding: 12px; text-align: left; border: 1px solid #444; }
td { padding: 10px 12px; border: 1px solid #333; }
tr:nth-child(even) { background: #1a1a2e; }
tr:nth-child(odd) { background: #151528; }
code { background: #2d2d4d; padding: 2px 8px; border-radius: 4px; color: #ff79c6; font-size: 0.95em; }
.tag { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; margin: 2px; }
.tag-pk { background: #4a1a6b; color: #d4a5ff; }
.tag-fk { background: #1a4a3b; color: #a5ffd4; }
.tag-idx { background: #4a3a1a; color: #ffd4a5; }
ul { padding-left: 25px; }
li { margin: 5px 0; }
.tradeoff { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
.pro { background: #0a2a1a; border: 1px solid #2a5a3a; padding: 15px; border-radius: 8px; }
.con { background: #2a0a1a; border: 1px solid #5a2a3a; padding: 15px; border-radius: 8px; }
</style>
</head>
<body>
<h1>System Design: Amazon (E-Commerce Platform)</h1>

<div class="section">
<h2>Functional Requirements</h2>
<ul>
<li>Product catalog with search, filtering, and category browsing</li>
<li>Shopping cart management (add/remove/update items)</li>
<li>Checkout and payment processing (multiple payment methods)</li>
<li>Order management (place, track, cancel, return orders)</li>
<li>Inventory management with real-time stock tracking</li>
<li>Product reviews and ratings</li>
<li>Personalized recommendations ("Customers who bought this also bought...")</li>
<li>Seller/marketplace support (third-party sellers)</li>
</ul>
</div>

<div class="section">
<h2>Non-Functional Requirements</h2>
<ul>
<li><strong>High Availability:</strong> 99.99% — every minute of downtime = millions in lost revenue</li>
<li><strong>Low Latency:</strong> Product pages in &lt;200ms, search in &lt;300ms</li>
<li><strong>Scalability:</strong> Hundreds of millions of products, millions of concurrent users, peak events like Prime Day (10x normal traffic)</li>
<li><strong>Consistency:</strong> Strong consistency for inventory and orders (prevent overselling). Eventual consistency OK for reviews, recommendations</li>
<li><strong>Durability:</strong> Order and payment data must never be lost</li>
</ul>
</div>

<!-- Flow 1: Product Search & Browse -->
<div class="section">
<h2>Flow 1: Product Search & Browse</h2>
<div class="diagram-container">
<svg viewBox="0 0 1100 420" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="arrow1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ff9900"/></marker></defs>
<rect x="20" y="170" width="120" height="60" rx="10" fill="#2a9d8f" stroke="#4ad4c0" stroke-width="2"/><text x="80" y="205" text-anchor="middle" fill="white" font-size="13">User</text>
<rect x="190" y="170" width="120" height="60" rx="10" fill="#888" stroke="#aaa" stroke-width="2"/><text x="250" y="205" text-anchor="middle" fill="white" font-size="13">CDN</text>
<rect x="360" y="170" width="140" height="60" rx="10" fill="#e76f51" stroke="#ff9a76" stroke-width="2"/><text x="430" y="198" text-anchor="middle" fill="white" font-size="12">API Gateway /</text><text x="430" y="215" text-anchor="middle" fill="white" font-size="12">Load Balancer</text>
<rect x="560" y="90" width="140" height="50" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="630" y="120" text-anchor="middle" fill="white" font-size="12">Search Service</text>
<rect x="560" y="200" width="140" height="50" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="630" y="230" text-anchor="middle" fill="white" font-size="12">Catalog Service</text>
<rect x="560" y="310" width="140" height="50" rx="8" fill="#8338ec" stroke="#b06efd" stroke-width="2"/><text x="630" y="340" text-anchor="middle" fill="white" font-size="12">Recommendation</text>
<rect x="780" y="90" width="130" height="50" rx="8" fill="#d4a017" stroke="#f0c040" stroke-width="2"/><text x="845" y="120" text-anchor="middle" fill="white" font-size="12">Elasticsearch</text>
<rect x="780" y="200" width="130" height="50" rx="8" fill="#c0392b" stroke="#e74c3c" stroke-width="2"/><text x="845" y="228" text-anchor="middle" fill="white" font-size="11">Product Cache</text><text x="845" y="242" text-anchor="middle" fill="white" font-size="10">(Redis)</text>
<ellipse cx="845" cy="335" rx="65" ry="25" fill="#6b2fa0" stroke="#9d5fd0" stroke-width="2"/><text x="845" y="340" text-anchor="middle" fill="white" font-size="11">Product DB</text>
<line x1="140" y1="200" x2="188" y2="200" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow1)"/>
<line x1="310" y1="200" x2="358" y2="200" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow1)"/>
<line x1="500" y1="188" x2="558" y2="120" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow1)"/>
<line x1="500" y1="200" x2="558" y2="225" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow1)"/>
<line x1="500" y1="215" x2="558" y2="330" stroke="#ff9900" stroke-width="1.5" marker-end="url(#arrow1)"/>
<line x1="700" y1="115" x2="778" y2="115" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow1)"/>
<line x1="700" y1="225" x2="778" y2="225" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow1)"/>
<line x1="845" y1="250" x2="845" y2="308" stroke="#ff6b6b" stroke-width="1.5" stroke-dasharray="5,5" marker-end="url(#arrow1)"/>
<text x="550" y="30" text-anchor="middle" fill="#aaa" font-size="16" font-weight="bold">Amazon: Product Search & Browse Flow</text>
</svg>
</div>

<h3>Step-by-Step</h3>
<ol>
<li><strong>User searches "wireless earbuds"</strong> → <code>GET /v1/search?q=wireless+earbuds&page=1&sort=relevance</code></li>
<li><strong>CDN:</strong> Static product images and assets cached. Search results NOT cached (personalized)</li>
<li><strong>Search Service:</strong> Queries Elasticsearch with full-text search + filters (price range, brand, ratings, Prime eligible)</li>
<li><strong>Elasticsearch:</strong> Returns ranked product IDs using BM25 + custom scoring (sales velocity, review rating, conversion rate)</li>
<li><strong>Catalog Service:</strong> Hydrates product IDs with full details (title, price, images, availability). Checks Redis cache first, falls back to Product DB</li>
<li><strong>Recommendation Service:</strong> Adds "Sponsored products" and "Customers also viewed" based on collaborative filtering</li>
</ol>

<div class="example">
<strong>Example:</strong> User searches "wireless earbuds under $50". Search Service sends to Elasticsearch: <code>{ query: "wireless earbuds", filter: { price: { lte: 5000 } }, sort: { relevance: "desc" } }</code>. Returns 500 matching products. Top 48 hydrated from Product Cache (Redis hit: 43, DB miss: 5). Recommendation engine adds 4 sponsored products. Response returned in ~180ms.
</div>

<h3>Deep Dive: Search Service</h3>
<ul>
<li><strong>Protocol:</strong> HTTPS REST</li>
<li><strong>Elasticsearch config:</strong> 100s of shards, replicated across AZs. Each product document: ~2KB (title, description, attributes, category hierarchy)</li>
<li><strong>Custom scoring:</strong> <code>score = BM25_relevance * 0.4 + sales_velocity * 0.25 + avg_rating * 0.15 + conversion_rate * 0.1 + prime_eligible * 0.1</code></li>
<li><strong>Faceted search:</strong> Elasticsearch aggregations for filters (brand counts, price ranges, star ratings). Computed in same query</li>
</ul>
</div>

<!-- Flow 2: Checkout & Order -->
<div class="section">
<h2>Flow 2: Checkout & Order Placement</h2>
<div class="diagram-container">
<svg viewBox="0 0 1150 500" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="arrow2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffaa00"/></marker></defs>
<rect x="20" y="200" width="110" height="60" rx="10" fill="#2a9d8f" stroke="#4ad4c0" stroke-width="2"/><text x="75" y="235" text-anchor="middle" fill="white" font-size="13">User</text>
<rect x="170" y="200" width="130" height="60" rx="10" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="235" y="235" text-anchor="middle" fill="white" font-size="13">Order Service</text>
<rect x="350" y="100" width="140" height="50" rx="8" fill="#d4a017" stroke="#f0c040" stroke-width="2"/><text x="420" y="130" text-anchor="middle" fill="white" font-size="12">Inventory Svc</text>
<rect x="350" y="200" width="140" height="50" rx="8" fill="#c77dba" stroke="#e0a5d8" stroke-width="2"/><text x="420" y="230" text-anchor="middle" fill="white" font-size="12">Payment Svc</text>
<rect x="350" y="300" width="140" height="50" rx="8" fill="#8338ec" stroke="#b06efd" stroke-width="2"/><text x="420" y="330" text-anchor="middle" fill="white" font-size="12">Pricing/Tax Svc</text>
<rect x="350" y="400" width="140" height="50" rx="8" fill="#e76f51" stroke="#ff9a76" stroke-width="2"/><text x="420" y="430" text-anchor="middle" fill="white" font-size="12">Shipping Svc</text>
<rect x="560" y="100" width="130" height="50" rx="8" fill="#1e6091" stroke="#3a8cbf" stroke-width="2"/><text x="625" y="130" text-anchor="middle" fill="white" font-size="12">Warehouse DB</text>
<rect x="560" y="200" width="130" height="50" rx="8" fill="#1e6091" stroke="#3a8cbf" stroke-width="2"/><text x="625" y="228" text-anchor="middle" fill="white" font-size="11">Payment Gateway</text><text x="625" y="243" text-anchor="middle" fill="white" font-size="10">(Stripe/Internal)</text>
<rect x="560" y="300" width="130" height="50" rx="8" fill="#8338ec" stroke="#b06efd" stroke-width="2"/><text x="625" y="330" text-anchor="middle" fill="white" font-size="12">Kafka</text>
<rect x="770" y="200" width="140" height="50" rx="8" fill="#c77dba" stroke="#e0a5d8" stroke-width="2"/><text x="840" y="230" text-anchor="middle" fill="white" font-size="12">Notification Svc</text>
<rect x="770" y="300" width="140" height="50" rx="8" fill="#d4a017" stroke="#f0c040" stroke-width="2"/><text x="840" y="330" text-anchor="middle" fill="white" font-size="12">Fulfillment Svc</text>
<ellipse cx="840" cy="125" rx="65" ry="25" fill="#6b2fa0" stroke="#9d5fd0" stroke-width="2"/><text x="840" y="130" text-anchor="middle" fill="white" font-size="11">Order DB</text>
<line x1="130" y1="230" x2="168" y2="230" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="300" y1="215" x2="348" y2="130" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="300" y1="230" x2="348" y2="225" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="300" y1="240" x2="348" y2="320" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow2)"/>
<line x1="300" y1="250" x2="348" y2="420" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow2)"/>
<line x1="490" y1="125" x2="558" y2="125" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="490" y1="225" x2="558" y2="225" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="490" y1="330" x2="558" y2="325" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="690" y1="325" x2="768" y2="225" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow2)"/>
<line x1="690" y1="325" x2="768" y2="325" stroke="#ffaa00" stroke-width="2" marker-end="url(#arrow2)"/>
<line x1="690" y1="115" x2="773" y2="118" stroke="#ff6b6b" stroke-width="1.5" marker-end="url(#arrow2)"/>
<text x="560" y="30" text-anchor="middle" fill="#aaa" font-size="16" font-weight="bold">Amazon: Checkout & Order Placement Flow</text>
</svg>
</div>

<h3>Step-by-Step (Saga Pattern)</h3>
<ol>
<li><strong>User clicks "Place Order"</strong> → Order Service creates order with status "pending"</li>
<li><strong>Step 1 — Reserve Inventory:</strong> Inventory Service does <code>UPDATE inventory SET reserved = reserved + qty WHERE product_id = X AND available - reserved >= qty</code> (optimistic lock)</li>
<li><strong>Step 2 — Calculate Price + Tax:</strong> Pricing Service calculates subtotal, applicable discounts/coupons, sales tax (varies by state/country)</li>
<li><strong>Step 3 — Process Payment:</strong> Payment Service charges customer's card via payment gateway. Idempotency key = order_id</li>
<li><strong>Step 4 — Confirm Order:</strong> If payment succeeds → order status "confirmed". If fails → compensating action: release inventory reservation</li>
<li><strong>Step 5 — Publish event:</strong> "order.confirmed" to Kafka → Notification Service emails customer, Fulfillment Service begins warehouse picking</li>
<li><strong>Shipping Service:</strong> Calculates delivery date based on warehouse proximity, shipping method (Prime 1-day, 2-day, standard)</li>
</ol>

<div class="example">
<strong>Example:</strong> User orders 2x "Sony WH-1000XM5" ($348 each). Order Service creates order #ORD-789. Inventory Service reserves 2 units at warehouse SEA-3 (closest to user in Seattle). Price: $696 + $62.64 tax = $758.64. Payment Service charges Visa ending 4242 via internal payment gateway. Payment succeeds → order status "confirmed" → Kafka event → email confirmation → Fulfillment Service starts pick/pack at SEA-3 → estimated delivery: tomorrow by 9PM (Prime member). If payment had failed → inventory reservation released within 5 seconds (compensating transaction).
</div>

<h3>Deep Dive: Inventory Service</h3>
<ul>
<li><strong>Challenge:</strong> Prevent overselling during flash sales (100K users buying same product simultaneously)</li>
<li><strong>Solution:</strong> Pessimistic locking on hot items (SELECT FOR UPDATE). For normal items, optimistic locking (version column with CAS)</li>
<li><strong>Distributed inventory:</strong> Stock tracked per-warehouse. "Reserve closest warehouse" strategy minimizes shipping distance/cost</li>
<li><strong>Redis counter:</strong> For hot items, maintain real-time available count in Redis. Decrement atomically. If Redis says 0, reject immediately without hitting DB</li>
</ul>

<h3>Deep Dive: Saga Pattern (Distributed Transaction)</h3>
<ul>
<li><strong>Why Saga:</strong> Order placement spans 4 services (inventory, pricing, payment, fulfillment). Traditional 2PC too slow and locks resources</li>
<li><strong>Orchestrator:</strong> Order Service acts as saga orchestrator. Calls each service sequentially. On failure, executes compensating actions in reverse order</li>
<li><strong>Compensating actions:</strong> Payment failed → release inventory. Inventory failed → cancel order. Each step is idempotent</li>
</ul>
</div>

<!-- Combined Architecture -->
<div class="section">
<h2>Combined Overall Architecture</h2>
<div class="diagram-container">
<svg viewBox="0 0 1200 650" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="arrow3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ff9900"/></marker></defs>
<rect x="20" y="280" width="100" height="60" rx="10" fill="#2a9d8f" stroke="#4ad4c0" stroke-width="2"/><text x="70" y="315" text-anchor="middle" fill="white" font-size="12">Clients</text>
<rect x="160" y="280" width="110" height="50" rx="8" fill="#888" stroke="#aaa" stroke-width="2"/><text x="215" y="310" text-anchor="middle" fill="white" font-size="12">CDN</text>
<rect x="160" y="370" width="110" height="50" rx="8" fill="#e76f51" stroke="#ff9a76" stroke-width="2"/><text x="215" y="400" text-anchor="middle" fill="white" font-size="12">API Gateway</text>
<rect x="330" y="60" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="85" text-anchor="middle" fill="white" font-size="11">Search Svc</text>
<rect x="330" y="130" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="155" text-anchor="middle" fill="white" font-size="11">Catalog Svc</text>
<rect x="330" y="200" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="225" text-anchor="middle" fill="white" font-size="11">Cart Svc</text>
<rect x="330" y="270" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="295" text-anchor="middle" fill="white" font-size="11">Order Svc</text>
<rect x="330" y="340" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="365" text-anchor="middle" fill="white" font-size="11">Inventory Svc</text>
<rect x="330" y="410" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="435" text-anchor="middle" fill="white" font-size="11">Payment Svc</text>
<rect x="330" y="480" width="120" height="40" rx="8" fill="#457b9d" stroke="#6db5d9" stroke-width="2"/><text x="390" y="505" text-anchor="middle" fill="white" font-size="11">Review Svc</text>
<rect x="330" y="550" width="120" height="40" rx="8" fill="#8338ec" stroke="#b06efd" stroke-width="2"/><text x="390" y="575" text-anchor="middle" fill="white" font-size="11">Recommend Svc</text>
<rect x="530" y="60" width="120" height="40" rx="8" fill="#d4a017" stroke="#f0c040" stroke-width="2"/><text x="590" y="85" text-anchor="middle" fill="white" font-size="11">Elasticsearch</text>
<rect x="530" y="130" width="120" height="40" rx="8" fill="#c0392b" stroke="#e74c3c" stroke-width="2"/><text x="590" y="155" text-anchor="middle" fill="white" font-size="11">Product Cache</text>
<rect x="530" y="200" width="120" height="40" rx="8" fill="#c0392b" stroke="#e74c3c" stroke-width="2"/><text x="590" y="225" text-anchor="middle" fill="white" font-size="11">Cart Cache</text>
<rect x="530" y="340" width="120" height="40" rx="8" fill="#8338ec" stroke="#b06efd" stroke-width="2"/><text x="590" y="365" text-anchor="middle" fill="white" font-size="11">Kafka Bus</text>
<ellipse cx="740" cy="80" rx="60" ry="22" fill="#6b2fa0" stroke="#9d5fd0" stroke-width="2"/><text x="740" y="85" text-anchor="middle" fill="white" font-size="10">Product DB</text>
<ellipse cx="740" cy="155" rx="60" ry="22" fill="#6b2fa0" stroke="#9d5fd0" stroke-width="2"/><text x="740" y="160" text-anchor="middle" fill="white" font-size="10">Order DB</text>
<ellipse cx="740" cy="230" rx="60" ry="22" fill="#6b2fa0" stroke="#9d5fd0" stroke-width="2"/><text x="740" y="235" text-anchor="middle" fill="white" font-size="10">Inventory DB</text>
<ellipse cx="740" cy="305" rx="60" ry="22" fill="#6b2fa0" stroke="#9d5fd0" stroke-width="2"/><text x="740" y="310" text-anchor="middle" fill="white" font-size="10">Review DB</text>
<rect x="530" y="430" width="120" height="40" rx="8" fill="#c77dba" stroke="#e0a5d8" stroke-width="2"/><text x="590" y="455" text-anchor="middle" fill="white" font-size="11">Fulfillment</text>
<rect x="530" y="500" width="120" height="40" rx="8" fill="#c77dba" stroke="#e0a5d8" stroke-width="2"/><text x="590" y="525" text-anchor="middle" fill="white" font-size="11">Notification</text>
<rect x="530" y="570" width="120" height="40" rx="8" fill="#d4a017" stroke="#f0c040" stroke-width="2"/><text x="590" y="595" text-anchor="middle" fill="white" font-size="11">ML Features</text>
<rect x="870" y="70" width="100" height="40" rx="8" fill="#888" stroke="#aaa" stroke-width="2"/><text x="920" y="95" text-anchor="middle" fill="white" font-size="11">S3 (Media)</text>
<line x1="120" y1="300" x2="158" y2="300" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow3)"/>
<line x1="120" y1="320" x2="158" y2="390" stroke="#ff9900" stroke-width="2" marker-end="url(#arrow3)"/>
<line x1="270" y1="395" x2="328" y2="80" stroke="#ff9900" stroke-width="1" marker-end="url(#arrow3)"/>
<line x1="270" y1="395" x2="328" y2="150" stroke="#ff9900" stroke-width="1" marker-end="url(#arrow3)"/>
<line x1="270" y1="395" x2="328" y2="220" stroke="#ff9900" stroke-width="1" marker-end="url(#arrow3)"/>
<line x1="270" y1="395" x2="328" y2="290" stroke="#ff9900" stroke-width="1" marker-end="url(#arrow3)"/>
<line x1="450" y1="80" x2="528" y2="80" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow3)"/>
<line x1="450" y1="150" x2="528" y2="150" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow3)"/>
<line x1="450" y1="220" x2="528" y2="220" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow3)"/>
<line x1="450" y1="290" x2="528" y2="355" stroke="#ffaa00" stroke-width="1.5" marker-end="url(#arrow3)"/>
<line x1="650" y1="80" x2="678" y2="80" stroke="#ff6b6b" stroke-width="1.5" marker-end="url(#arrow3)"/>
<line x1="650" y1="360" x2="678" y2="155" stroke="#ff6b6b" stroke-width="1" marker-end="url(#arrow3)"/>
<line x1="650" y1="360" x2="678" y2="230" stroke="#ff6b6b" stroke-width="1" marker-end="url(#arrow3)"/>
<text x="600" y="25" text-anchor="middle" fill="#aaa" font-size="16" font-weight="bold">Amazon: Combined Overall Architecture</text>
</svg>
</div>

<div class="example">
<strong>Example — Full purchase journey:</strong> User searches "laptop stand" → Elasticsearch returns 200 results → Product Cache hydrates top 48 → Recommendation Service adds "frequently bought together: USB hub" → User adds laptop stand to cart (Cart Service → Redis) → Checkout → Order Service orchestrates saga: Inventory reserves 1 unit at warehouse ORD-1 → Payment charges $29.99 + $2.40 tax → Order confirmed → Kafka event → email sent → Fulfillment starts pick/pack → UPS label generated → Tracking number emailed → Delivered next day.
</div>
</div>

<!-- Database Schema -->
<div class="section">
<h2>Database Schema</h2>

<h3>SQL — PostgreSQL/Aurora (Orders, Users — ACID required)</h3>
<table>
<tr><th>Table</th><th>Column</th><th>Type</th><th>Details</th></tr>
<tr><td rowspan="7"><strong>orders</strong></td><td>order_id</td><td>VARCHAR(20)</td><td><span class="tag tag-pk">PK</span></td></tr>
<tr><td>user_id</td><td>BIGINT</td><td><span class="tag tag-fk">FK → users</span> <span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>status</td><td>ENUM</td><td>pending, confirmed, shipped, delivered, canceled, returned</td></tr>
<tr><td>total_amount</td><td>BIGINT</td><td>In cents</td></tr>
<tr><td>shipping_address_id</td><td>BIGINT</td><td><span class="tag tag-fk">FK → addresses</span></td></tr>
<tr><td>idempotency_key</td><td>VARCHAR(64)</td><td><span class="tag tag-idx">UNIQUE INDEX</span></td></tr>
<tr><td>created_at</td><td>TIMESTAMP</td><td><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td rowspan="5"><strong>order_items</strong></td><td>order_item_id</td><td>BIGSERIAL</td><td><span class="tag tag-pk">PK</span></td></tr>
<tr><td>order_id</td><td>VARCHAR(20)</td><td><span class="tag tag-fk">FK → orders</span> <span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>product_id</td><td>BIGINT</td><td><span class="tag tag-fk">FK → products</span></td></tr>
<tr><td>quantity</td><td>INT</td><td></td></tr>
<tr><td>unit_price</td><td>BIGINT</td><td>Price at time of purchase (snapshot)</td></tr>
<tr><td rowspan="5"><strong>inventory</strong></td><td>product_id</td><td>BIGINT</td><td><span class="tag tag-pk">PK (composite)</span></td></tr>
<tr><td>warehouse_id</td><td>VARCHAR(10)</td><td><span class="tag tag-pk">PK (composite)</span></td></tr>
<tr><td>available_qty</td><td>INT</td><td></td></tr>
<tr><td>reserved_qty</td><td>INT</td><td></td></tr>
<tr><td>version</td><td>BIGINT</td><td>Optimistic locking</td></tr>
</table>

<h3>NoSQL — DynamoDB (Products, Reviews — high read throughput)</h3>
<table>
<tr><th>Table</th><th>Column</th><th>Type</th><th>Details</th></tr>
<tr><td rowspan="8"><strong>products</strong></td><td>product_id</td><td>BIGINT</td><td><span class="tag tag-pk">Partition Key</span></td></tr>
<tr><td>title</td><td>STRING</td><td></td></tr>
<tr><td>description</td><td>STRING</td><td></td></tr>
<tr><td>price</td><td>NUMBER</td><td>In cents</td></tr>
<tr><td>category_path</td><td>STRING</td><td>"Electronics > Audio > Headphones"</td></tr>
<tr><td>seller_id</td><td>BIGINT</td><td><span class="tag tag-idx">GSI</span></td></tr>
<tr><td>avg_rating</td><td>NUMBER</td><td>Denormalized (1.0-5.0)</td></tr>
<tr><td>image_urls</td><td>LIST</td><td>CDN URLs</td></tr>
<tr><td rowspan="6"><strong>reviews</strong></td><td>product_id</td><td>BIGINT</td><td><span class="tag tag-pk">Partition Key</span></td></tr>
<tr><td>review_id</td><td>STRING</td><td><span class="tag tag-pk">Sort Key</span></td></tr>
<tr><td>user_id</td><td>BIGINT</td><td></td></tr>
<tr><td>rating</td><td>NUMBER</td><td>1-5</td></tr>
<tr><td>review_text</td><td>STRING</td><td></td></tr>
<tr><td>helpful_votes</td><td>NUMBER</td><td></td></tr>
</table>

<h3>Cart — Redis</h3>
<table>
<tr><th>Key</th><th>Type</th><th>Value</th></tr>
<tr><td><code>cart:{user_id}</code></td><td>Hash</td><td>product_id → {qty, price, seller_id}</td></tr>
</table>

<h4>Sharding Strategy</h4>
<ul>
<li><strong>orders:</strong> Shard by <code>user_id</code> — "my orders" query is shard-local. order_id uses Snowflake (time-sortable)</li>
<li><strong>inventory:</strong> Shard by <code>product_id</code> — inventory checks for a specific product hit one shard</li>
<li><strong>products (DynamoDB):</strong> Partition by <code>product_id</code> — even distribution. GSI on <code>seller_id</code> for seller dashboard</li>
<li><strong>reviews:</strong> Partition by <code>product_id</code> — all reviews for a product co-located (optimal for product page display)</li>
</ul>

<h3>Denormalization</h3>
<ul>
<li><code>products.avg_rating</code> — denormalized from reviews. Updated async via Kafka consumer when new review submitted</li>
<li><code>order_items.unit_price</code> — snapshot of price at purchase time (price may change later, order must reflect original price)</li>
<li>Elasticsearch documents duplicate product data (title, price, rating) for search — avoids joins during search queries</li>
</ul>

<h3>Indexes</h3>
<ul>
<li><code>orders.user_id</code> — B-tree index for "my orders" listing (ORDER BY created_at DESC)</li>
<li><code>orders.idempotency_key</code> — Unique index to prevent duplicate order placement on retry</li>
<li><code>inventory(product_id, warehouse_id)</code> — Composite PK for per-warehouse stock lookup</li>
<li><code>products.seller_id</code> — DynamoDB GSI for seller product management dashboard</li>
</ul>
</div>

<!-- Cache -->
<div class="section">
<h2>Cache Deep Dive</h2>
<table>
<tr><th>Cache</th><th>Strategy</th><th>Eviction</th><th>TTL</th><th>Purpose</th></tr>
<tr><td>Product Cache (Redis)</td><td>Read-through</td><td>LRU</td><td>1 hour</td><td>Product details for catalog pages</td></tr>
<tr><td>Cart (Redis)</td><td>Write-through</td><td>TTL</td><td>30 days</td><td>Shopping cart persistence</td></tr>
<tr><td>Session (Redis)</td><td>Write-through</td><td>TTL</td><td>24 hours</td><td>User auth sessions</td></tr>
<tr><td>Inventory Hot (Redis)</td><td>Write-through</td><td>None</td><td>Real-time sync</td><td>Fast stock check for popular items</td></tr>
<tr><td>Search Cache (Redis)</td><td>Read-through</td><td>LRU</td><td>5 min</td><td>Common search query results</td></tr>
</table>

<h3>CDN Deep Dive</h3>
<ul>
<li><strong>What's cached:</strong> Product images (multiple sizes: thumbnail, gallery, zoom), static assets, JS/CSS bundles</li>
<li><strong>Strategy:</strong> Push-based for popular products. Pull-based for long-tail</li>
<li><strong>Image optimization:</strong> WebP format for supported browsers (30% smaller). Lazy loading for below-fold images</li>
<li><strong>TTL:</strong> Product images: 365 days (immutable, URL includes hash). HTML pages: NOT cached (dynamic pricing, personalization)</li>
<li><strong>Edge computing:</strong> Some personalization logic (A/B tests, geo-pricing) runs at CDN edge via Lambda@Edge</li>
</ul>
</div>

<!-- Scaling -->
<div class="section">
<h2>Scaling Considerations</h2>
<ul>
<li><strong>Prime Day handling:</strong> Pre-warm all caches 24 hours before. Auto-scale all services to 3-5x normal capacity. Inventory pre-allocated to multiple warehouses. Circuit breakers on non-essential services (recommendations can degrade gracefully)</li>
<li><strong>Database scaling:</strong> Aurora with read replicas for order queries. DynamoDB auto-scaling for product reads. Elasticsearch horizontal scaling (add shards)</li>
<li><strong>Cart durability:</strong> Redis with AOF persistence + async replication. If Redis node fails, cart data recovered from AOF log. For logged-in users, cart also periodically snapshot to DynamoDB</li>
<li><strong>Microservices independence:</strong> Each service owns its database (database-per-service pattern). No shared DB. Communication via REST/gRPC + Kafka events</li>
</ul>
</div>

<!-- Tradeoffs -->
<div class="section">
<h2>Tradeoffs & Deep Dives</h2>
<div class="tradeoff">
<div class="pro"><h4>✅ Saga Pattern</h4><ul><li>No distributed locks — each service manages its own transactions</li><li>Better availability — partial failures don't block entire system</li><li>Compensating transactions handle rollback</li></ul></div>
<div class="con"><h4>❌ Saga Downsides</h4><ul><li>Complexity: must implement compensating transaction for every step</li><li>Eventual consistency: brief window where inventory reserved but payment pending</li><li>Debugging distributed failures is harder than single DB transaction</li></ul></div>
</div>

<h3>Message Queue (Kafka) Deep Dive</h3>
<ul>
<li><strong>Topics:</strong> order-events, inventory-events, payment-events, review-events, user-activity</li>
<li><strong>Partitioning:</strong> order-events by order_id, inventory-events by product_id</li>
<li><strong>Consumers:</strong> Notification Service, Fulfillment Service, Analytics, Search Indexer (for real-time Elasticsearch updates)</li>
<li><strong>Exactly-once:</strong> Kafka transactions + idempotent producers to prevent duplicate order processing</li>
</ul>
</div>

<!-- Alternatives -->
<div class="section">
<h2>Alternative Approaches</h2>
<ul>
<li><strong>2-Phase Commit (2PC):</strong> Instead of Saga. Stronger consistency guarantee but: coordinator is single point of failure, locks held during entire transaction (reduces throughput), doesn't scale well across services</li>
<li><strong>CQRS for Orders:</strong> Separate write model (PostgreSQL for order placement) from read model (Elasticsearch for order search/analytics). Write path optimized for consistency, read path optimized for query flexibility</li>
<li><strong>GraphQL instead of REST:</strong> Single query can fetch product + reviews + recommendations. Reduces number of API calls from client. Tradeoff: more complex caching (each query is unique)</li>
<li><strong>Event Sourcing for Inventory:</strong> Store every inventory change as event (received, reserved, shipped, returned). Derive current stock from event replay. Better audit trail, easier debugging, but requires snapshotting for read performance</li>
</ul>
</div>

<div class="section">
<h2>Additional Information</h2>
<ul>
<li><strong>Price consistency:</strong> Product price cached aggressively but cart always re-validates prices at checkout time. If price changed between add-to-cart and checkout, customer is notified</li>
<li><strong>Search ranking personalization:</strong> Same query returns different results per user. Purchase history, browse history, and demographic data influence Elasticsearch boost factors</li>
<li><strong>Warehouse selection algorithm:</strong> Minimize: shipping cost + delivery time. Consider: warehouse proximity to customer, item availability, current warehouse load, carrier rates</li>
<li><strong>Review authenticity:</strong> ML model detects fake reviews (linguistic patterns, reviewer behavior, purchase verification). Verified Purchase badge requires actual order for that product</li>
</ul>
</div>
</body>
</html>
