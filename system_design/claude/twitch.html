<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Design: Twitch</title>
<style>body{font-family:'Segoe UI',Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5;color:#333}.container{max-width:1200px;margin:0 auto;background:#fff;padding:40px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}h1{color:#1a73e8;border-bottom:3px solid #1a73e8;padding-bottom:10px}h2{color:#2c3e50;margin-top:40px;border-left:4px solid #1a73e8;padding-left:12px}h3{color:#34495e}h4{color:#555}.diagram{background:#fafafa;border:1px solid #ddd;border-radius:8px;padding:20px;margin:20px 0;overflow-x:auto}.example{background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:15px 0;border-radius:4px}.deep-dive{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin:15px 0;border-radius:4px}.tradeoff{background:#fff3e0;border-left:4px solid #ff9800;padding:15px;margin:15px 0;border-radius:4px}.alternative{background:#fce4ec;border-left:4px solid #e91e63;padding:15px;margin:15px 0;border-radius:4px}table{border-collapse:collapse;width:100%;margin:15px 0}th,td{border:1px solid #ddd;padding:10px 14px;text-align:left}th{background:#1a73e8;color:#fff}tr:nth-child(even){background:#f9f9f9}code{background:#f0f0f0;padding:2px 6px;border-radius:3px;font-size:.9em}.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.85em;margin:2px}.tag-pk{background:#ffeb3b;color:#333}.tag-fk{background:#ce93d8;color:#333}.tag-idx{background:#80cbc4;color:#333}ul,ol{line-height:1.8}svg text{font-family:'Segoe UI',Arial,sans-serif}</style>
</head>
<body>
<div class="container">
<h1>System Design: Twitch</h1>

<h2>Functional Requirements</h2>
<ol>
  <li><strong>Live streaming</strong> – Streamers broadcast live video/audio to thousands or millions of viewers.</li>
  <li><strong>Live chat</strong> – Real-time text chat alongside each stream with emotes and moderation.</li>
  <li><strong>VOD (Video on Demand)</strong> – Past broadcasts are saved and viewable as VODs.</li>
  <li><strong>Follow/subscribe</strong> – Users follow channels and subscribe (paid) for perks.</li>
  <li><strong>Stream discovery</strong> – Browse streams by game/category, recommended streams, search.</li>
  <li><strong>Clips</strong> – Viewers create short clips from live streams.</li>
  <li><strong>Donations/bits</strong> – Viewers can donate to streamers.</li>
  <li><strong>Notifications</strong> – Push notifications when followed streamers go live.</li>
</ol>

<h2>Non-Functional Requirements</h2>
<ol>
  <li><strong>Low latency video</strong> – Stream-to-viewer latency &lt;5 seconds (sub-second for competitive gaming).</li>
  <li><strong>High availability</strong> – 99.99%; any stream interruption is unacceptable.</li>
  <li><strong>Scalability</strong> – Support 100K+ concurrent streams, individual streams with 500K+ concurrent viewers.</li>
  <li><strong>Adaptive bitrate</strong> – Serve multiple video qualities (160p to 1080p60) based on viewer's bandwidth.</li>
  <li><strong>Global reach</strong> – Serve viewers worldwide with low buffering.</li>
</ol>

<h2>Flow 1: Live Video Streaming (Streamer → Viewer)</h2>
<div class="diagram">
<svg viewBox="0 0 1100 400" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="a1" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M0 0L10 5L0 10z" fill="#333"/></marker></defs>
  <rect x="10" y="150" width="100" height="55" rx="8" fill="#4caf50" stroke="#388e3c" stroke-width="2"/>
  <text x="60" y="175" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Streamer</text>
  <text x="60" y="190" text-anchor="middle" fill="#fff" font-size="9">(OBS/XSplit)</text>
  <line x1="110" y1="177" x2="180" y2="177" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <text x="145" y="167" text-anchor="middle" fill="#555" font-size="8">RTMP</text>
  <rect x="180" y="148" width="110" height="60" rx="8" fill="#2196f3" stroke="#1565c0" stroke-width="2"/>
  <text x="235" y="175" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Ingest</text>
  <text x="235" y="190" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Server</text>
  <line x1="290" y1="177" x2="370" y2="177" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <rect x="370" y="148" width="120" height="60" rx="8" fill="#673ab7" stroke="#4527a0" stroke-width="2"/>
  <text x="430" y="175" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Transcoding</text>
  <text x="430" y="190" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Service</text>
  <text x="430" y="220" text-anchor="middle" fill="#555" font-size="8">Multiple qualities</text>
  <!-- To Origin -->
  <line x1="490" y1="177" x2="570" y2="177" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <rect x="570" y="148" width="110" height="60" rx="8" fill="#ff9800" stroke="#f57c00" stroke-width="2"/>
  <text x="625" y="175" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Origin</text>
  <text x="625" y="190" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Server</text>
  <!-- To CDN -->
  <line x1="680" y1="177" x2="760" y2="177" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <text x="720" y="167" text-anchor="middle" fill="#555" font-size="8">HLS/DASH</text>
  <rect x="760" y="148" width="80" height="60" rx="8" fill="#607d8b" stroke="#37474f" stroke-width="2"/>
  <text x="800" y="183" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">CDN</text>
  <!-- To Viewers -->
  <line x1="840" y1="165" x2="910" y2="120" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <line x1="840" y1="178" x2="910" y2="178" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <line x1="840" y1="190" x2="910" y2="235" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="910" y="100" width="80" height="35" rx="6" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="950" y="122" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Viewer 1</text>
  <rect x="910" y="160" width="80" height="35" rx="6" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="950" y="182" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Viewer 2</text>
  <rect x="910" y="218" width="80" height="35" rx="6" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="950" y="240" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Viewer N</text>
  <!-- VOD Storage -->
  <line x1="625" y1="208" x2="625" y2="280" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="575" y="280" width="100" height="40" rx="6" fill="#795548" stroke="#4e342e" stroke-width="1.5"/>
  <text x="625" y="305" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">VOD Storage</text>
  <text x="625" y="335" text-anchor="middle" fill="#555" font-size="8">(S3)</text>
</svg>
</div>

<div class="example">
<h4>Example: Streamer goes live</h4>
<p>Alice opens OBS Studio, configures her stream key, and starts streaming. OBS sends the video/audio stream via <strong>RTMP (Real-Time Messaging Protocol)</strong> over TCP to the nearest <strong>Ingest Server</strong>. The Ingest Server receives the raw video and forwards it to the <strong>Transcoding Service</strong>, which encodes the stream into multiple quality levels: 1080p60 (6 Mbps), 720p60 (4.5 Mbps), 480p (1.5 Mbps), 160p (0.4 Mbps). Each quality is segmented into 2-second <strong>HLS</strong> (HTTP Live Streaming) chunks. The <strong>Origin Server</strong> packages these chunks and generates HLS manifests (.m3u8 playlists). The <strong>CDN</strong> pulls chunks from the origin and distributes to edge locations globally. Viewers' video players request the HLS manifest, select a quality based on bandwidth, and download chunks from the nearest CDN edge. Latency: ~3-5 seconds from streamer to viewer. The Origin Server also writes chunks to <strong>S3</strong> for VOD.</p>
</div>

<div class="example">
<h4>Example: Viewer switches quality</h4>
<p>Bob is watching on mobile with limited bandwidth. His player starts at 480p. He moves to a WiFi network — the player detects increased bandwidth and seamlessly switches to 1080p by requesting higher-quality chunks from the CDN. The HLS manifest lists all available quality levels.</p>
</div>

<h3>Deep Dive: Components</h3>
<div class="deep-dive">
<h4>RTMP Ingest</h4>
<p><strong>Protocol:</strong> RTMP over TCP (port 1935). RTMP is chosen because all major streaming software (OBS, XSplit, Streamlabs) supports it natively. It provides low-latency transport with TCP reliability. Alternative: SRT (Secure Reliable Transport) over UDP — lower latency but less software support.</p>
<p><strong>Why TCP for ingest:</strong> The streamer-to-server path must be reliable; dropped frames degrade video quality for all viewers. TCP's retransmission guarantees no frame loss.</p>
</div>

<div class="deep-dive">
<h4>Transcoding Service</h4>
<p>GPU-accelerated video encoding (H.264/H.265 codec). Each stream requires ~1 GPU for real-time transcoding into multiple quality levels. For a platform with 100K concurrent streams, that's ~100K GPUs (or fewer with hardware encoding like NVENC which handles multiple streams per GPU).</p>
</div>

<div class="deep-dive">
<h4>CDN (Critical for Live Streaming)</h4>
<p><strong>Why CDN is essential:</strong> A single popular stream may have 500K concurrent viewers. Serving all of them from the origin would require ~3 Tbps of bandwidth. The CDN distributes this across 200+ edge locations, each serving a fraction of viewers.</p>
<p><strong>Caching strategy:</strong> Each 2-second HLS chunk is cached at the edge for 10 seconds (just enough to serve it to all viewers requesting it). Pull-based: the edge fetches from origin on the first viewer request.</p>
<p><strong>Eviction:</strong> LRU, but chunks are naturally evicted because live stream chunks have very short TTLs.</p>
<p><strong>Protocol to viewers:</strong> HTTPS GET for HLS chunks and manifests. HTTP/2 for multiplexing multiple chunk requests.</p>
</div>

<h2>Flow 2: Live Chat</h2>
<div class="diagram">
<svg viewBox="0 0 850 280" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="a2" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M0 0L10 5L0 10z" fill="#333"/></marker></defs>
  <rect x="10" y="100" width="80" height="50" rx="8" fill="#4caf50" stroke="#388e3c" stroke-width="2"/>
  <text x="50" y="130" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">Viewer</text>
  <line x1="90" y1="125" x2="160" y2="125" stroke="#333" stroke-width="2" marker-end="url(#a2)"/>
  <text x="125" y="115" text-anchor="middle" fill="#555" font-size="8">WebSocket</text>
  <rect x="160" y="95" width="100" height="60" rx="8" fill="#e91e63" stroke="#ad1457" stroke-width="2"/>
  <text x="210" y="123" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Chat</text>
  <text x="210" y="138" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Service</text>
  <!-- Pub/Sub -->
  <line x1="260" y1="125" x2="340" y2="125" stroke="#333" stroke-width="2" marker-end="url(#a2)"/>
  <rect x="340" y="100" width="90" height="50" rx="8" fill="#9c27b0" stroke="#6a1b9a" stroke-width="2"/>
  <text x="385" y="123" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Pub/Sub</text>
  <text x="385" y="138" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">(Redis)</text>
  <!-- Fan out to chat service instances -->
  <line x1="430" y1="115" x2="510" y2="80" stroke="#333" stroke-width="1.5" marker-end="url(#a2)"/>
  <line x1="430" y1="130" x2="510" y2="130" stroke="#333" stroke-width="1.5" marker-end="url(#a2)"/>
  <line x1="430" y1="140" x2="510" y2="175" stroke="#333" stroke-width="1.5" marker-end="url(#a2)"/>
  <rect x="510" y="60" width="100" height="40" rx="6" fill="#e91e63" stroke="#ad1457" stroke-width="1.5"/>
  <text x="560" y="84" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Chat Svc (1)</text>
  <rect x="510" y="110" width="100" height="40" rx="6" fill="#e91e63" stroke="#ad1457" stroke-width="1.5"/>
  <text x="560" y="134" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Chat Svc (2)</text>
  <rect x="510" y="160" width="100" height="40" rx="6" fill="#e91e63" stroke="#ad1457" stroke-width="1.5"/>
  <text x="560" y="184" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Chat Svc (N)</text>
  <!-- To viewers -->
  <line x1="610" y1="80" x2="680" y2="80" stroke="#333" stroke-width="1" marker-end="url(#a2)"/>
  <line x1="610" y1="130" x2="680" y2="130" stroke="#333" stroke-width="1" marker-end="url(#a2)"/>
  <line x1="610" y1="180" x2="680" y2="180" stroke="#333" stroke-width="1" marker-end="url(#a2)"/>
  <text x="645" y="72" text-anchor="middle" fill="#555" font-size="7">WebSocket</text>
  <rect x="680" y="60" width="70" height="35" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
  <text x="715" y="82" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Viewers</text>
  <rect x="680" y="115" width="70" height="35" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
  <text x="715" y="137" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Viewers</text>
  <rect x="680" y="165" width="70" height="35" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
  <text x="715" y="187" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Viewers</text>
  <!-- Moderation -->
  <line x1="210" y1="155" x2="210" y2="220" stroke="#333" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#a2)"/>
  <rect x="165" y="220" width="90" height="35" rx="6" fill="#673ab7" stroke="#4527a0" stroke-width="1.5"/>
  <text x="210" y="242" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Mod Filter</text>
</svg>
</div>

<div class="example">
<h4>Example: Chat message in a 50K-viewer stream</h4>
<p>Bob types "PogChamp nice play!" in Alice's stream chat. His message is sent via <strong>WebSocket</strong> to the <strong>Chat Service</strong> instance holding his connection. The service runs the message through the <strong>Moderation Filter</strong> (banned words, spam detection, slow mode enforcement). The approved message is published to a <strong>Redis Pub/Sub</strong> channel for this stream (<code>chat:stream_alice</code>). All Chat Service instances subscribed to this channel receive the message and push it to their connected viewers via WebSocket. With 50K viewers spread across 50 Chat Service instances (~1K connections each), every viewer sees Bob's message within ~100ms.</p>
</div>

<div class="deep-dive">
<h4>WebSocket for Chat</h4>
<p><strong>Why WebSocket:</strong> Chat requires real-time bidirectional communication (viewers both send and receive messages). In a busy stream, 100+ messages/second arrive — WebSocket's persistent connection avoids the overhead of establishing a new connection for each message.</p>
<p><strong>Connection management:</strong> Viewers connect to a Chat Service instance via L4 load balancer with consistent hashing on stream_id (so all viewers of the same stream are likely on the same instance, reducing Pub/Sub overhead).</p>
</div>

<div class="deep-dive">
<h4>Redis Pub/Sub for Chat Fan-out</h4>
<p>Each stream has a Pub/Sub channel. When a message is published, Redis broadcasts to all subscribed Chat Service instances. This is more efficient than a message queue because chat messages are ephemeral — we don't need durability or replay.</p>
<p><strong>Why not Kafka:</strong> Kafka provides durability and ordering but adds latency (~5-10ms). Chat messages are fire-and-forget; if one is lost, it's not critical. Redis Pub/Sub delivers in &lt;1ms.</p>
</div>

<h2>Overall Combined Flow</h2>
<div class="diagram">
<svg viewBox="0 0 1050 350" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="a3" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M0 0L10 5L0 10z" fill="#333"/></marker></defs>
  <text x="10" y="20" fill="#1a73e8" font-size="12" font-weight="bold">VIDEO PATH</text>
  <rect x="10" y="30" width="75" height="35" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="47" y="52" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Streamer</text>
  <line x1="85" y1="47" x2="120" y2="47" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <text x="102" y="40" text-anchor="middle" fill="#555" font-size="7">RTMP</text>
  <rect x="120" y="30" width="70" height="35" rx="5" fill="#2196f3" stroke="#1565c0" stroke-width="1.5"/>
  <text x="155" y="52" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Ingest</text>
  <line x1="190" y1="47" x2="225" y2="47" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="225" y="30" width="80" height="35" rx="5" fill="#673ab7" stroke="#4527a0" stroke-width="1.5"/>
  <text x="265" y="52" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Transcode</text>
  <line x1="305" y1="47" x2="340" y2="47" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="340" y="30" width="70" height="35" rx="5" fill="#ff9800" stroke="#f57c00" stroke-width="1.5"/>
  <text x="375" y="52" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Origin</text>
  <line x1="410" y1="47" x2="445" y2="47" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="445" y="30" width="55" height="35" rx="5" fill="#607d8b" stroke="#37474f" stroke-width="1.5"/>
  <text x="472" y="52" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">CDN</text>
  <line x1="500" y1="47" x2="535" y2="47" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <text x="517" y="40" text-anchor="middle" fill="#555" font-size="7">HLS</text>
  <rect x="535" y="30" width="65" height="35" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="567" y="52" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Viewers</text>
  <line x1="375" y1="65" x2="375" y2="90" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="345" y="90" width="60" height="25" rx="4" fill="#795548" stroke="#4e342e" stroke-width="1"/>
  <text x="375" y="107" text-anchor="middle" fill="#fff" font-size="7" font-weight="bold">S3 VOD</text>
  <text x="10" y="145" fill="#1a73e8" font-size="12" font-weight="bold">CHAT PATH</text>
  <rect x="10" y="155" width="65" height="30" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="42" y="174" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Viewer</text>
  <line x1="75" y1="170" x2="110" y2="170" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <text x="92" y="163" text-anchor="middle" fill="#555" font-size="7">WS</text>
  <rect x="110" y="155" width="75" height="30" rx="5" fill="#e91e63" stroke="#ad1457" stroke-width="1.5"/>
  <text x="147" y="174" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Chat Svc</text>
  <line x1="185" y1="170" x2="220" y2="170" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="220" y="155" width="75" height="30" rx="5" fill="#673ab7" stroke="#4527a0" stroke-width="1.5"/>
  <text x="257" y="174" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Mod Filter</text>
  <line x1="295" y1="170" x2="330" y2="170" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="330" y="155" width="70" height="30" rx="5" fill="#9c27b0" stroke="#6a1b9a" stroke-width="1.5"/>
  <text x="365" y="174" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Pub/Sub</text>
  <line x1="400" y1="170" x2="435" y2="170" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="435" y="155" width="75" height="30" rx="5" fill="#e91e63" stroke="#ad1457" stroke-width="1.5"/>
  <text x="472" y="174" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">All Chat Svcs</text>
  <line x1="510" y1="170" x2="545" y2="170" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="545" y="155" width="70" height="30" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="580" y="174" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">All Viewers</text>
</svg>
</div>

<div class="example"><h4>Combined Example</h4><p><strong>Video:</strong> Streamer → RTMP → Ingest → Transcode (multi-quality) → Origin → CDN → HLS to viewers (3-5s latency). Origin also saves chunks to S3 for VOD.<br/><strong>Chat:</strong> Viewer sends message → WS → Chat Service → Mod Filter → Redis Pub/Sub → all Chat Service instances → WS push to all viewers.</p></div>

<h2>Database Schema</h2>
<h3>SQL (PostgreSQL)</h3>
<h4>1. channels</h4>
<table>
  <tr><th>Field</th><th>Type</th><th>Key</th><th>Description</th></tr>
  <tr><td>channel_id</td><td>BIGINT</td><td><span class="tag tag-pk">PK</span></td><td>Unique channel ID</td></tr>
  <tr><td>user_id</td><td>BIGINT</td><td><span class="tag tag-fk">FK → users</span></td><td>Channel owner</td></tr>
  <tr><td>stream_key</td><td>VARCHAR(64)</td><td><span class="tag tag-idx">Hash Unique</span></td><td>Authentication key for RTMP</td></tr>
  <tr><td>is_live</td><td>BOOLEAN</td><td><span class="tag tag-idx">B-tree</span></td><td>Currently streaming?</td></tr>
  <tr><td>viewer_count</td><td>INT</td><td></td><td>Denormalized current viewers</td></tr>
  <tr><td>follower_count</td><td>INT</td><td></td><td>Denormalized follower count</td></tr>
  <tr><td>category</td><td>VARCHAR(100)</td><td><span class="tag tag-idx">B-tree</span></td><td>Game/category name</td></tr>
  <tr><td>title</td><td>VARCHAR(255)</td><td></td><td>Stream title</td></tr>
</table>
<p><strong>Index:</strong> B-tree on <code>(is_live, category, viewer_count DESC)</code> for "browse live streams by category, sorted by viewers."</p>

<h3>NoSQL (Cassandra)</h3>
<h4>2. chat_messages</h4>
<table>
  <tr><th>Field</th><th>Type</th><th>Key</th><th>Description</th></tr>
  <tr><td>channel_id</td><td>BIGINT</td><td><span class="tag tag-pk">Partition Key</span></td><td>Stream channel</td></tr>
  <tr><td>message_id</td><td>TimeUUID</td><td><span class="tag tag-pk">Clustering Key</span></td><td>Chronological order</td></tr>
  <tr><td>user_id</td><td>BIGINT</td><td></td><td>Message sender</td></tr>
  <tr><td>text</td><td>TEXT</td><td></td><td>Message content</td></tr>
  <tr><td>emotes</td><td>LIST&lt;TEXT&gt;</td><td></td><td>Emote codes in message</td></tr>
</table>
<p><strong>Why NoSQL:</strong> Chat messages are extremely high-volume, write-heavy, and time-series in nature. No complex queries needed.</p>

<h4>3. vods</h4>
<table>
  <tr><th>Field</th><th>Type</th><th>Key</th><th>Description</th></tr>
  <tr><td>vod_id</td><td>BIGINT</td><td><span class="tag tag-pk">PK</span></td><td>VOD ID</td></tr>
  <tr><td>channel_id</td><td>BIGINT</td><td><span class="tag tag-fk">FK</span> <span class="tag tag-idx">B-tree</span></td><td>Channel</td></tr>
  <tr><td>s3_manifest_url</td><td>TEXT</td><td></td><td>HLS manifest in S3</td></tr>
  <tr><td>duration_seconds</td><td>INT</td><td></td><td>VOD duration</td></tr>
  <tr><td>view_count</td><td>INT</td><td></td><td>Views</td></tr>
  <tr><td>created_at</td><td>TIMESTAMP</td><td></td><td>Stream date</td></tr>
</table>

<h2>Cache Deep Dive</h2>
<div class="deep-dive">
<h4>CDN for Video</h4>
<p><strong>This is the most cache-heavy system design.</strong> Live HLS chunks are cached at CDN edge for ~10 seconds. All viewers of the same stream get served from the same edge cache. CDN hit ratio for live streams: ~99.9%. VOD content is also served via CDN with TTL = 24 hours.</p>
</div>
<div class="deep-dive">
<h4>Redis for Real-time Data</h4>
<p>Viewer counts per stream (INCR/DECR on join/leave), chat Pub/Sub channels, and browse page data (top live streams by category) are cached in Redis. Write-through for viewer counts. LRU eviction.</p>
</div>

<h2>Scaling Considerations</h2>
<ul>
  <li><strong>Ingest Servers:</strong> Geo-distributed; streamers connect to the nearest ingest point. 1 ingest server per ~1000 concurrent streamers.</li>
  <li><strong>Transcoding:</strong> GPU-based, auto-scales with number of live streams. Most expensive component.</li>
  <li><strong>CDN:</strong> Handles viewer scale inherently. No action needed per viewer.</li>
  <li><strong>Chat:</strong> Each Chat Service instance handles ~100K WebSocket connections. For a 500K-viewer stream: 5 instances, all subscribed to the same Redis Pub/Sub channel.</li>
  <li><strong>Load Balancer:</strong> L4 LB for RTMP ingest (TCP). L4 LB for WebSocket chat (sticky sessions). L7 LB for REST APIs.</li>
</ul>

<h2>Tradeoffs and Deep Dives</h2>
<div class="tradeoff"><h4>HLS vs. WebRTC</h4><p>HLS has 3-5s latency but scales to millions via CDN. WebRTC has sub-second latency but doesn't scale through CDN (peer-to-peer). Twitch uses HLS for normal streams and a low-latency HLS mode (~2s) for competitive gaming. WebRTC is used for 1-on-1 calls (like Zoom), not broadcast.</p></div>

<h2>Alternative Approaches</h2>
<div class="alternative"><h4>WebRTC-based Broadcasting</h4><p>Sub-second latency, ideal for interactive streams. Not chosen because CDN can't cache WebRTC (it's P2P), making it prohibitively expensive at 500K+ viewers.</p></div>
<div class="alternative"><h4>MPEG-DASH instead of HLS</h4><p>Open standard (HLS is Apple). Both work similarly. HLS chosen due to wider device support (iOS native).</p></div>

<h2>Additional Information</h2>
<h3>Slow Mode &amp; Chat Throttling</h3>
<p>In busy streams (100K+ viewers), chat moves too fast to read. Slow mode limits users to 1 message per N seconds. The Chat Service enforces this with a per-user rate limiter (Redis TTL key: <code>slowmode:{stream_id}:{user_id}</code>).</p>
<h3>Stream Health Monitoring</h3>
<p>The Ingest Server monitors stream bitrate, frame rate, and keyframe intervals. If the streamer's upload bandwidth drops, a warning is displayed. If the stream disconnects, a "reconnecting" screen is shown to viewers for 30 seconds before the stream is marked offline.</p>
</div>
</body>
</html>
