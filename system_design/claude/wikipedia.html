<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Design Wikipedia</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0f0f0f;color:#e0e0e0;line-height:1.7;padding:2rem}h1{font-size:2.5rem;text-align:center;background:linear-gradient(135deg,#fff,#aaa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}h2{color:#69c;font-size:1.8rem;margin:2rem 0 1rem;border-bottom:2px solid #69c;padding-bottom:.5rem}h3{color:#9cf;font-size:1.3rem;margin:1.5rem 0 .8rem}h4{color:#cdf;margin:1rem 0 .5rem}.container{max-width:1400px;margin:0 auto}.card{background:#1a1a2e;border-radius:12px;padding:1.5rem;margin:1rem 0;border:1px solid #333}.diagram-box{background:#0d1117;border-radius:12px;padding:1.5rem;margin:1rem 0;text-align:center;overflow-x:auto}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem}.tag-pk{background:#E53935;color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem}.tag-fk{background:#1E88E5;color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem}.tag-idx{background:#43A047;color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem}.tag-shard{background:#F4511E;color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem}.tradeoff-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin:1rem 0}.tradeoff-card{background:#1a1a2e;border-radius:8px;padding:1rem;border-left:4px solid}.tradeoff-card.pro{border-color:#69c}.tradeoff-card.con{border-color:#c66}code{background:#2d2d2d;padding:2px 6px;border-radius:4px;font-family:'Fira Code',monospace;font-size:.85rem}pre{background:#1e1e2e;padding:1rem;border-radius:8px;overflow-x:auto;margin:.5rem 0}ul,ol{padding-left:1.5rem;margin:.5rem 0}table{width:100%;border-collapse:collapse;margin:1rem 0}th,td{padding:.75rem;border:1px solid #333;text-align:left}th{background:#1a1a2e}svg text{font-family:'Segoe UI',system-ui,sans-serif}
</style>
</head>
<body>
<div class="container">
<h1>üìñ Design Wikipedia</h1>
<p style="text-align:center;color:#aaa;margin-bottom:2rem;">Collaborative encyclopedia with 60M+ articles in 300+ languages, edit history, version control, anti-vandalism ‚Äî 16B+ pageviews/month</p>

<h2>1. Functional Requirements</h2>
<div class="card">
<ul>
<li><strong>Article Viewing:</strong> Render articles with wikitext markup (tables, infoboxes, citations, categories, inter-wiki links)</li>
<li><strong>Editing:</strong> Edit articles with wikitext or visual editor; save edits with edit summaries, diff generation</li>
<li><strong>Version History:</strong> Complete revision history for every article; diff between any two revisions; revert to any version</li>
<li><strong>Anti-Vandalism:</strong> Automated bots (ClueBot NG), ORES ML scoring, patrolled/flagged revisions, semi-protection</li>
<li><strong>Search:</strong> Full-text search across all articles in a language with autocomplete and suggestions</li>
<li><strong>Multi-Language:</strong> 300+ language editions, each independent wiki with cross-language links (interwiki via Wikidata)</li>
<li><strong>Talk Pages:</strong> Discussion pages for each article, user talk pages for collaboration</li>
<li><strong>Media:</strong> Images, audio, video via Wikimedia Commons (100M+ free media files)</li>
</ul>
</div>

<h2>2. Non-Functional Requirements</h2>
<div class="card">
<ul>
<li><strong>Scale:</strong> 16B+ pageviews/month, 60M+ articles, 300+ language editions</li>
<li><strong>Latency:</strong> Article rendering p50 &lt;200ms (from cache), &lt;1s (cache miss with wikitext parse)</li>
<li><strong>Availability:</strong> 99.95%+ (read path); write path can tolerate brief degradation</li>
<li><strong>Read:Write ratio:</strong> ~1000:1 (reads vastly dominate)</li>
<li><strong>Storage:</strong> All revisions stored forever (never deleted); ~4PB total including media</li>
<li><strong>Budget:</strong> Non-profit ‚Äî runs on ~$150M/year donated funds with ~800 servers total (extremely efficient)</li>
</ul>
</div>

<h2>3. Flow 1 ‚Äî Article Viewing (Read Path)</h2>
<div class="diagram-box">
<svg viewBox="0 0 1050 350" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="a1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#69c"/></marker></defs>
<rect x="20" y="140" width="110" height="60" rx="8" fill="#2e7d32" stroke="#4caf50" stroke-width="2"/><text x="75" y="170" text-anchor="middle" fill="#fff" font-size="13">Reader</text><text x="75" y="185" text-anchor="middle" fill="#fff" font-size="11">16B views/mo</text>
<rect x="180" y="40" width="130" height="60" rx="8" fill="#546e7a" stroke="#90a4ae" stroke-width="2"/><text x="245" y="70" text-anchor="middle" fill="#fff" font-size="13">CDN (Varnish)</text><text x="245" y="85" text-anchor="middle" fill="#fff" font-size="11">edge cache layer</text>
<rect x="180" y="140" width="130" height="60" rx="8" fill="#e65100" stroke="#ff9800" stroke-width="2"/><text x="245" y="170" text-anchor="middle" fill="#fff" font-size="13">Varnish Frontend</text><text x="245" y="185" text-anchor="middle" fill="#fff" font-size="11">(local DC cache)</text>
<rect x="180" y="240" width="130" height="60" rx="8" fill="#00838f" stroke="#26c6da" stroke-width="2"/><text x="245" y="270" text-anchor="middle" fill="#fff" font-size="13">Varnish Backend</text><text x="245" y="285" text-anchor="middle" fill="#fff" font-size="11">(2nd layer)</text>
<rect x="380" y="140" width="130" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="445" y="170" text-anchor="middle" fill="#fff" font-size="13">MediaWiki</text><text x="445" y="185" text-anchor="middle" fill="#fff" font-size="11">(PHP app servers)</text>
<rect x="570" y="40" width="130" height="60" rx="8" fill="#00838f" stroke="#26c6da" stroke-width="2"/><text x="635" y="70" text-anchor="middle" fill="#fff" font-size="13">Memcached</text><text x="635" y="85" text-anchor="middle" fill="#fff" font-size="11">(parsed objects)</text>
<rect x="570" y="140" width="130" height="60" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="635" y="170" text-anchor="middle" fill="#fff" font-size="13">MariaDB</text><text x="635" y="185" text-anchor="middle" fill="#fff" font-size="11">(article metadata)</text>
<rect x="570" y="240" width="130" height="60" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="635" y="270" text-anchor="middle" fill="#fff" font-size="13">Blob Store</text><text x="635" y="285" text-anchor="middle" fill="#fff" font-size="11">(revision text)</text>
<rect x="760" y="140" width="140" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="830" y="170" text-anchor="middle" fill="#fff" font-size="13">Parsoid / Parser</text><text x="830" y="185" text-anchor="middle" fill="#fff" font-size="11">(wikitext ‚Üí HTML)</text>
<line x1="130" y1="155" x2="178" y2="70" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="130" y1="170" x2="178" y2="170" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="245" y1="102" x2="245" y2="138" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="245" y1="202" x2="245" y2="238" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="310" y1="270" x2="378" y2="185" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="510" y1="155" x2="568" y2="70" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="510" y1="170" x2="568" y2="170" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="510" y1="185" x2="568" y2="265" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
<line x1="700" y1="170" x2="758" y2="170" stroke="#69c" stroke-width="2" marker-end="url(#a1)"/>
</svg>
</div>

<h3>Flow Steps</h3>
<div class="card">
<ol>
<li><strong>Reader requests</strong> <code>https://en.wikipedia.org/wiki/Quantum_computing</code></li>
<li><strong>CDN (Varnish edge)</strong>: Cache lookup by URL + language + device variant. Cache HIT ‚Üí return immediately (serves ~85-90% of requests). Average cache hit ratio at edge: ~90%</li>
<li><strong>Cache MISS ‚Üí Varnish Frontend</strong> (local data center Varnish layer): secondary cache lookup. Additional ~5% hit rate</li>
<li><strong>Cache MISS ‚Üí Varnish Backend</strong> (third layer): final Varnish cache. ~3% additional hit rate</li>
<li><strong>Origin MISS ‚Üí MediaWiki (PHP)</strong>: Only ~2-3% of requests reach the application servers</li>
<li><strong>MediaWiki</strong> checks Memcached for parsed HTML of the article. If cached ‚Üí return. If not ‚Üí fetch latest revision metadata from MariaDB</li>
<li><strong>Fetch revision text</strong> from blob store (external storage for wikitext content)</li>
<li><strong>Parsoid/Parser</strong> converts wikitext to HTML: resolves templates ({{cite web|...}}), transclusions, categories, generates table of contents, infoboxes, reference lists</li>
<li><strong>Parsed HTML cached</strong> in Memcached (keyed by page_id + revision_id) and in Varnish (keyed by URL)</li>
</ol>
</div>

<h3>Example</h3>
<div class="card" style="background:#1e1e2e">
<p><strong>Request:</strong> <code>GET /wiki/Quantum_computing HTTP/2</code></p>
<p><strong>Varnish edge:</strong> Cache HIT (popular article, cached 5 minutes ago) ‚Üí return 200 with cached HTML in 15ms</p>
<p><strong>Cache MISS scenario:</strong> Article just edited (cache purged) ‚Üí request falls through all 3 Varnish layers ‚Üí hits MediaWiki</p>
<p><strong>MediaWiki processing:</strong> MariaDB lookup: page_id=25336, latest_rev=1234567. Memcached check for parsed HTML of rev 1234567 ‚Üí MISS. Fetch wikitext from blob store (48KB of wikitext). Parse: resolve 150 templates, 200 citations, 30 images ‚Üí generates 180KB HTML. Total parse time: ~800ms. Cached in Memcached and all Varnish layers. Next reader gets cache hit in 15ms.</p>
<p><strong>Mobile variant:</strong> Separate Varnish cache entry for mobile (m.wikipedia.org uses different HTML renderer via MobileFrontend extension)</p>
</div>

<h3>Deep Dives</h3>
<div class="info-grid">
<div class="card">
<h4>Multi-Layer Varnish Caching</h4>
<p>Wikipedia's caching architecture is the key to serving 16B+ pageviews/month with only ~800 servers. Three Varnish layers: (1) <strong>Edge/CDN</strong>: geographically distributed, serves ~90% of reads. (2) <strong>Frontend</strong>: per-DC Varnish, handles regional cache misses. (3) <strong>Backend</strong>: final cache before origin. Total cache hit ratio: ~97-98%. Cache invalidation: on article edit, a <strong>PURGE</strong> request is sent to all Varnish layers for that URL. Uses <strong>HTCPurge</strong> multicast protocol to efficiently invalidate across all cache nodes. Cache key: URL + Vary headers (Accept-Language, Cookie for logged-in users).</p>
</div>
<div class="card">
<h4>Wikitext Parsing (Parsoid)</h4>
<p><strong>Parsoid</strong> is Wikipedia's parser that converts wikitext (a custom markup language) to HTML5+RDFa and vice-versa. Wikitext is complex: templates (transclusions from other pages), parser functions (#if, #switch), Lua modules (Scribunto), references (ref/reflist), tables, categories, interwiki links. Parsing a complex article can take 500ms-2s. This is why caching is critical ‚Äî parsing is expensive. Parsoid outputs semantic HTML that preserves the wikitext's meaning, enabling round-tripping (HTML ‚Üí wikitext ‚Üí HTML). Used by the Visual Editor for WYSIWYG editing.</p>
</div>
<div class="card">
<h4>Template Transclusion</h4>
<p>Wikitext templates like <code>{{Infobox_country|name=Japan|...}}</code> are resolved by substituting content from the template page. Templates can be recursive (templates calling templates). A single article can transclude 100+ templates. Template changes affect ALL articles that use them ‚Äî requiring cache purge of all dependent articles. Template dependency tracking via the <code>templatelinks</code> table in MariaDB. High-use templates (e.g., {{citation needed}}) are referenced by millions of articles ‚Äî template edits trigger massive cache purge cascades.</p>
</div>
<div class="card">
<h4>Content Negotiation</h4>
<p>Wikipedia serves different content based on: <strong>Language</strong>: each language wiki (en, de, ja, etc.) is a separate MediaWiki installation with its own database. <strong>Device</strong>: desktop vs mobile (different HTML, separate cache entries). <strong>User state</strong>: logged-in users get personalized elements (watchlist links, edit buttons with user-specific tools) ‚Äî these are NOT cached in Varnish (served directly from MediaWiki). Anonymous users: fully cached. This is why ~97% cache hit rate is achievable ‚Äî most readers are anonymous.</p>
</div>
</div>

<h2>4. Flow 2 ‚Äî Article Editing &amp; Version Control</h2>
<div class="diagram-box">
<svg viewBox="0 0 1050 380" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="a2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#9cf"/></marker></defs>
<rect x="20" y="150" width="110" height="60" rx="8" fill="#2e7d32" stroke="#4caf50" stroke-width="2"/><text x="75" y="180" text-anchor="middle" fill="#fff" font-size="13">Editor</text><text x="75" y="195" text-anchor="middle" fill="#fff" font-size="11">(human/bot)</text>
<rect x="180" y="150" width="130" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="245" y="180" text-anchor="middle" fill="#fff" font-size="13">MediaWiki</text><text x="245" y="195" text-anchor="middle" fill="#fff" font-size="11">Edit Handler</text>
<rect x="370" y="50" width="130" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="435" y="80" text-anchor="middle" fill="#fff" font-size="13">Edit Conflict</text><text x="435" y="95" text-anchor="middle" fill="#fff" font-size="11">Detector</text>
<rect x="370" y="150" width="130" height="60" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="435" y="180" text-anchor="middle" fill="#fff" font-size="13">MariaDB</text><text x="435" y="195" text-anchor="middle" fill="#fff" font-size="11">(revision table)</text>
<rect x="370" y="250" width="130" height="60" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="435" y="280" text-anchor="middle" fill="#fff" font-size="13">Blob Store</text><text x="435" y="295" text-anchor="middle" fill="#fff" font-size="11">(wikitext content)</text>
<rect x="560" y="50" width="130" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="625" y="80" text-anchor="middle" fill="#fff" font-size="13">AbuseFilter</text><text x="625" y="95" text-anchor="middle" fill="#fff" font-size="11">(rule engine)</text>
<rect x="560" y="150" width="130" height="60" rx="8" fill="#6a1b9a" stroke="#ab47bc" stroke-width="2"/><text x="625" y="180" text-anchor="middle" fill="#fff" font-size="13">Job Queue</text><text x="625" y="195" text-anchor="middle" fill="#fff" font-size="11">(async tasks)</text>
<rect x="560" y="250" width="130" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="625" y="280" text-anchor="middle" fill="#fff" font-size="13">ORES / ML</text><text x="625" y="295" text-anchor="middle" fill="#fff" font-size="11">(vandalism score)</text>
<rect x="760" y="150" width="140" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="830" y="180" text-anchor="middle" fill="#fff" font-size="13">Cache Purge</text><text x="830" y="195" text-anchor="middle" fill="#fff" font-size="11">(HTCP multicast)</text>
<line x1="130" y1="180" x2="178" y2="180" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="310" y1="165" x2="368" y2="85" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="310" y1="180" x2="368" y2="180" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="310" y1="195" x2="368" y2="275" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="500" y1="80" x2="558" y2="80" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="500" y1="180" x2="558" y2="180" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="500" y1="280" x2="558" y2="280" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
<line x1="690" y1="180" x2="758" y2="180" stroke="#9cf" stroke-width="2" marker-end="url(#a2)"/>
</svg>
</div>

<h3>Flow Steps</h3>
<div class="card">
<ol>
<li><strong>Editor</strong> loads edit form ‚Üí receives current wikitext + base revision ID (e.g., rev 1234567)</li>
<li><strong>Editor submits</strong> modified wikitext + edit summary + base_rev_id via POST to MediaWiki action API</li>
<li><strong>AbuseFilter</strong> checks edit against configured rules (regex patterns for common vandalism, new user restrictions, link spam detection)</li>
<li><strong>Edit Conflict Detector:</strong> Compare base_rev_id with current latest_rev. If they differ ‚Üí edit conflict (another editor saved a revision in between). User must manually merge changes.</li>
<li><strong>If no conflict:</strong> Insert new row in <code>revision</code> table (rev_id, page_id, user_id, timestamp, comment, SHA-1 of content). Store wikitext content in blob store (deduplicated by content hash).</li>
<li><strong>Update <code>page</code> table:</strong> Set <code>page_latest</code> to new rev_id</li>
<li><strong>Job Queue (async):</strong> Parse new wikitext ‚Üí update Memcached with parsed HTML; update search index (Elasticsearch/CirrusSearch); update links tables (pagelinks, categorylinks, templatelinks); update recent changes feed</li>
<li><strong>Cache Purge:</strong> HTCP multicast to all Varnish nodes to purge the article URL</li>
<li><strong>ORES ML scoring:</strong> Score the edit for quality/vandalism probability. If high vandalism score ‚Üí flagged for review in patrol queue</li>
</ol>
</div>

<h3>Example</h3>
<div class="card" style="background:#1e1e2e">
<p><strong>Scenario:</strong> User fixes a typo in the "History" section of the Quantum_computing article</p>
<p><strong>Edit:</strong> Changed "computaiton" ‚Üí "computation" (1 character edit)</p>
<p><strong>AbuseFilter:</strong> No rules triggered (not a new account, not adding external links, not blanking content)</p>
<p><strong>Edit conflict check:</strong> base_rev=1234567, current latest=1234567 ‚Üí no conflict ‚Üí proceed</p>
<p><strong>Revision created:</strong> rev_id=1234568, parent_rev=1234567, size_diff=+0 (same length), sha1=abc...</p>
<p><strong>Content dedup:</strong> New wikitext stored in blob store. Old revision's text preserved (complete text, not delta)</p>
<p><strong>ORES score:</strong> goodfaith=0.98, damaging=0.02 ‚Üí classified as good edit, auto-patrolled</p>
<p><strong>Diff generation:</strong> Line-based diff computed between rev 1234567 and 1234568 ‚Üí stored for display on revision history page</p>
</div>

<h3>Deep Dives</h3>
<div class="info-grid">
<div class="card">
<h4>Edit Conflict Resolution</h4>
<p>Wikipedia uses <strong>optimistic concurrency control</strong>. When an editor opens the edit form, they receive the current revision ID. On submit, if another edit occurred in between, the edit is rejected with a conflict. The editor sees a three-way merge view: their version, the other editor's version, and the common ancestor. They must manually merge. For high-traffic articles, edit conflicts are common. The <strong>TwoColConflict</strong> extension provides a better UX with side-by-side diff. Bots handle this by fetching the latest revision and re-applying their change programmatically (retry loop).</p>
</div>
<div class="card">
<h4>ORES (Objective Revision Evaluation Service)</h4>
<p>ML service that scores each edit in real-time. Models: <strong>damaging</strong> (probability edit is vandalism), <strong>goodfaith</strong> (probability editor intended well), <strong>articlequality</strong> (stub/start/C/B/GA/FA), <strong>draftquality</strong> (for new article drafts). Features: edit size, user tenure, time of day, regex pattern matches, word changes, reference additions/removals. Used by: patrollers (sort edits by damaging probability), ClueBot NG (auto-revert highly damaging edits), and new page patrol. Model: gradient-boosted trees trained on labeled edit datasets.</p>
</div>
</div>

<h2>5. Flow 3 ‚Äî Search (CirrusSearch)</h2>
<div class="diagram-box">
<svg viewBox="0 0 900 300" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="a3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#cdf"/></marker></defs>
<rect x="20" y="120" width="110" height="60" rx="8" fill="#2e7d32" stroke="#4caf50" stroke-width="2"/><text x="75" y="150" text-anchor="middle" fill="#fff" font-size="13">User</text><text x="75" y="165" text-anchor="middle" fill="#fff" font-size="11">search query</text>
<rect x="180" y="120" width="130" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="245" y="150" text-anchor="middle" fill="#fff" font-size="13">MediaWiki</text><text x="245" y="165" text-anchor="middle" fill="#fff" font-size="11">+ CirrusSearch</text>
<rect x="370" y="40" width="140" height="60" rx="8" fill="#00838f" stroke="#26c6da" stroke-width="2"/><text x="440" y="70" text-anchor="middle" fill="#fff" font-size="13">Elasticsearch</text><text x="440" y="85" text-anchor="middle" fill="#fff" font-size="11">Cluster</text>
<rect x="370" y="120" width="140" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="440" y="150" text-anchor="middle" fill="#fff" font-size="13">Completion</text><text x="440" y="165" text-anchor="middle" fill="#fff" font-size="11">Suggester</text>
<rect x="370" y="200" width="140" height="60" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="440" y="230" text-anchor="middle" fill="#fff" font-size="13">Rescore (MLR)</text><text x="440" y="245" text-anchor="middle" fill="#fff" font-size="11">learning-to-rank</text>
<rect x="580" y="120" width="120" height="60" rx="8" fill="#2e7d32" stroke="#4caf50" stroke-width="2"/><text x="640" y="150" text-anchor="middle" fill="#fff" font-size="13">Search Results</text>
<line x1="130" y1="150" x2="178" y2="150" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
<line x1="310" y1="135" x2="368" y2="75" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
<line x1="310" y1="150" x2="368" y2="150" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
<line x1="310" y1="165" x2="368" y2="225" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
<line x1="510" y1="75" x2="578" y2="140" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
<line x1="510" y1="150" x2="578" y2="150" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
<line x1="510" y1="225" x2="578" y2="165" stroke="#cdf" stroke-width="2" marker-end="url(#a3)"/>
</svg>
</div>

<h3>Flow Steps</h3>
<div class="card">
<ol>
<li><strong>User types in search bar</strong> ‚Üí CirrusSearch extension sends prefix completion query to Elasticsearch</li>
<li><strong>Completion Suggester:</strong> Returns title suggestions using FST (Finite State Transducer) ‚Äî sub-millisecond prefix matching across 60M+ article titles</li>
<li><strong>Full search:</strong> Elasticsearch query with BM25 scoring + field boosting (title > headings > content). Supports advanced operators: intitle:, incategory:, hastemplate:, insource:</li>
<li><strong>MLR (Machine Learning Ranking):</strong> Rescore top results using learning-to-rank model (features: page popularity, incoming link count, text relevance, recency)</li>
<li><strong>Snippet generation:</strong> Highlight matching terms in article excerpt</li>
<li><strong>Did-you-mean:</strong> Spell correction via Elasticsearch suggest API (phrase suggester with bigram/trigram analysis)</li>
</ol>
</div>

<h3>Example</h3>
<div class="card" style="background:#1e1e2e">
<p><strong>Query:</strong> "quantim computing" (typo)</p>
<p><strong>Autocomplete (as user types "quant"):</strong> ["Quantum computing", "Quantum mechanics", "Quantitative easing", "Quantum entanglement"]</p>
<p><strong>Full search:</strong> Did-you-mean: "quantum computing" ‚Üí redirects. BM25 results + MLR rescore: Quantum_computing (score: 95), Quantum_supremacy (score: 78), Qubit (score: 72)...</p>
<p><strong>MLR features for top result:</strong> incoming_links=15000, pageviews_30d=2M, text_match=0.95, title_match=0.99</p>
</div>

<h2>6. Combined Architecture</h2>
<div class="diagram-box">
<svg viewBox="0 0 1100 500" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="a4" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#69c"/></marker></defs>
<rect x="10" y="220" width="100" height="60" rx="8" fill="#2e7d32" stroke="#4caf50" stroke-width="2"/><text x="60" y="250" text-anchor="middle" fill="#fff" font-size="12">Readers</text><text x="60" y="265" text-anchor="middle" fill="#fff" font-size="10">16B views/mo</text>
<rect x="150" y="130" width="110" height="50" rx="8" fill="#546e7a" stroke="#90a4ae" stroke-width="2"/><text x="205" y="160" text-anchor="middle" fill="#fff" font-size="12">Varnish CDN</text>
<rect x="150" y="200" width="110" height="50" rx="8" fill="#e65100" stroke="#ff9800" stroke-width="2"/><text x="205" y="225" text-anchor="middle" fill="#fff" font-size="12">Varnish FE</text><text x="205" y="240" text-anchor="middle" fill="#fff" font-size="10">(per-DC)</text>
<rect x="150" y="270" width="110" height="50" rx="8" fill="#00838f" stroke="#26c6da" stroke-width="2"/><text x="205" y="295" text-anchor="middle" fill="#fff" font-size="12">Varnish BE</text>
<rect x="310" y="200" width="130" height="50" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="375" y="225" text-anchor="middle" fill="#fff" font-size="12">MediaWiki (PHP)</text><text x="375" y="240" text-anchor="middle" fill="#fff" font-size="10">~300 app servers</text>
<rect x="310" y="280" width="130" height="50" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="375" y="305" text-anchor="middle" fill="#fff" font-size="12">Parsoid (Node.js)</text>
<rect x="310" y="360" width="130" height="50" rx="8" fill="#6a1b9a" stroke="#ab47bc" stroke-width="2"/><text x="375" y="385" text-anchor="middle" fill="#fff" font-size="12">Job Queue</text><text x="375" y="400" text-anchor="middle" fill="#fff" font-size="10">(Redis-backed)</text>
<rect x="500" y="80" width="120" height="45" rx="8" fill="#00838f" stroke="#26c6da" stroke-width="2"/><text x="560" y="108" text-anchor="middle" fill="#fff" font-size="11">Memcached</text>
<rect x="500" y="145" width="120" height="45" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="560" y="173" text-anchor="middle" fill="#fff" font-size="11">MariaDB Primary</text>
<rect x="500" y="210" width="120" height="45" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="560" y="238" text-anchor="middle" fill="#fff" font-size="11">MariaDB Replicas</text>
<rect x="500" y="275" width="120" height="45" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="560" y="303" text-anchor="middle" fill="#fff" font-size="11">Blob Store</text>
<rect x="500" y="340" width="120" height="45" rx="8" fill="#00838f" stroke="#26c6da" stroke-width="2"/><text x="560" y="368" text-anchor="middle" fill="#fff" font-size="11">Elasticsearch</text>
<rect x="680" y="145" width="120" height="45" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="740" y="173" text-anchor="middle" fill="#fff" font-size="11">ORES (ML)</text>
<rect x="680" y="210" width="120" height="45" rx="8" fill="#1565c0" stroke="#42a5f5" stroke-width="2"/><text x="740" y="238" text-anchor="middle" fill="#fff" font-size="11">Wikidata (WDQS)</text>
<rect x="680" y="275" width="120" height="45" rx="8" fill="#4e342e" stroke="#8d6e63" stroke-width="2"/><text x="740" y="303" text-anchor="middle" fill="#fff" font-size="11">Commons (media)</text>
<line x1="110" y1="240" x2="148" y2="155" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="110" y1="250" x2="148" y2="225" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="205" y1="252" x2="205" y2="268" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="260" y1="295" x2="308" y2="225" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="440" y1="215" x2="498" y2="105" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="440" y1="225" x2="498" y2="165" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="440" y1="230" x2="498" y2="295" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="440" y1="225" x2="498" y2="230" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="440" y1="310" x2="498" y2="360" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
<line x1="620" y1="165" x2="678" y2="165" stroke="#69c" stroke-width="2" marker-end="url(#a4)"/>
</svg>
</div>

<h2>7. Database Schema</h2>
<div class="card">
<h3>MariaDB ‚Äî Core Tables (per-wiki database, e.g., enwiki)</h3>
<pre>
Table: page
- page_id: int unsigned        <span class="tag-pk">PK</span>
- page_namespace: int          <span class="tag-idx">IDX</span> (0=article, 1=talk, 2=user, etc.)
- page_title: varbinary(255)   <span class="tag-idx">IDX: UNIQUE(namespace, title)</span>
- page_is_redirect: tinyint
- page_is_new: tinyint
- page_len: int unsigned       // byte length of latest wikitext
- page_latest: int unsigned    <span class="tag-fk">FK ‚Üí revision</span> (latest revision ID)
- page_content_model: varbinary(32)  // 'wikitext', 'json', etc.
- page_touched: varbinary(14)  // yyyymmddhhmmss (cache invalidation timestamp)

Table: revision  <span class="tag-shard">SHARD: by wiki (enwiki, dewiki, etc.)</span>
- rev_id: int unsigned         <span class="tag-pk">PK</span>
- rev_page: int unsigned       <span class="tag-fk">FK ‚Üí page</span> <span class="tag-idx">IDX</span>
- rev_actor: bigint unsigned   <span class="tag-fk">FK ‚Üí actor</span>
- rev_timestamp: varbinary(14) <span class="tag-idx">IDX</span>
- rev_minor_edit: tinyint
- rev_deleted: tinyint         // suppression flags
- rev_len: int unsigned        // content length
- rev_parent_id: int unsigned  <span class="tag-fk">FK ‚Üí revision</span> (previous revision)
- rev_sha1: varbinary(32)     // SHA-1 of content (dedup key)
- rev_comment_id: bigint      <span class="tag-fk">FK ‚Üí comment</span>

Table: text (blob store ‚Äî external storage)
- old_id: int unsigned         <span class="tag-pk">PK</span>
- old_text: mediumblob         // raw wikitext content (gzip compressed)
- old_flags: tinyblob          // 'utf-8,gzip,external' ‚Äî storage flags
// In practice, large wikis use external blob stores (not MySQL TEXT column)
</pre>

<h3>Link Tables</h3>
<pre>
Table: pagelinks (which pages link to which)
- pl_from: int unsigned        <span class="tag-fk">FK ‚Üí page</span> <span class="tag-idx">IDX</span>
- pl_namespace: int
- pl_title: varbinary(255)     <span class="tag-idx">IDX</span>
// Used for: "What links here", backlink updates, link graph analysis

Table: categorylinks
- cl_from: int unsigned        <span class="tag-fk">FK ‚Üí page</span>
- cl_to: varbinary(255)        <span class="tag-idx">IDX</span> (category name)
- cl_sortkey: varbinary(230)
- cl_timestamp: timestamp

Table: templatelinks
- tl_from: int unsigned        <span class="tag-fk">FK ‚Üí page</span>
- tl_namespace: int
- tl_title: varbinary(255)     <span class="tag-idx">IDX</span>
// Used for: cache invalidation when template is edited
</pre>

<h3>Recent Changes &amp; Watchlist</h3>
<pre>
Table: recentchanges
- rc_id: int unsigned          <span class="tag-pk">PK</span>
- rc_timestamp: varbinary(14)  <span class="tag-idx">IDX</span>
- rc_actor: bigint unsigned
- rc_namespace: int
- rc_title: varbinary(255)
- rc_type: tinyint             // 0=edit, 1=new, 3=log, 5=categorize
- rc_cur_id: int unsigned      <span class="tag-fk">FK ‚Üí page</span>
- rc_this_oldid: int unsigned  <span class="tag-fk">FK ‚Üí revision</span>
- rc_last_oldid: int unsigned  <span class="tag-fk">FK ‚Üí revision</span>
- rc_patrolled: tinyint        // 0=unpatrolled, 1=patrolled

Table: watchlist
- wl_user: int unsigned        <span class="tag-fk">FK ‚Üí user</span>
- wl_namespace: int
- wl_title: varbinary(255)
- wl_notificationtimestamp: varbinary(14)
// Composite PK: (wl_user, wl_namespace, wl_title)
</pre>
</div>

<h2>8. Cache &amp; CDN Deep Dive</h2>
<div class="card">
<h3>Wikipedia's Caching Philosophy</h3>
<p>Wikipedia's entire architecture is optimized around caching because: (1) 1000:1 read:write ratio, (2) non-profit budget (~800 servers for 16B pageviews/month), (3) most content is stable (articles change infrequently relative to reads).</p>

<table>
<tr><th>Layer</th><th>Technology</th><th>Hit Rate</th><th>Purpose</th><th>TTL / Invalidation</th></tr>
<tr><td>Edge CDN</td><td>Varnish (custom, ~60 servers)</td><td>~90%</td><td>Full HTML pages for anonymous users</td><td>24h TTL, PURGE on edit</td></tr>
<tr><td>Varnish Frontend</td><td>Varnish (per-DC)</td><td>~5%</td><td>Second-layer page cache</td><td>Same as edge</td></tr>
<tr><td>Varnish Backend</td><td>Varnish</td><td>~3%</td><td>Third-layer, request coalescing</td><td>Same as edge</td></tr>
<tr><td>Memcached</td><td>Memcached (~100 servers, ~200GB)</td><td>~95% (of origin hits)</td><td>Parsed HTML, metadata, user sessions</td><td>Invalidated on edit (version key)</td></tr>
<tr><td>MariaDB query cache</td><td>MariaDB built-in</td><td>Varies</td><td>Repeated queries</td><td>Invalidated on table write</td></tr>
</table>

<h3>Cache Invalidation: HTCP Purge</h3>
<p>When an article is edited, MediaWiki sends a <strong>PURGE</strong> to all Varnish instances. Uses <strong>HTCP (Hyper Text Caching Protocol)</strong> multicast: a single multicast packet invalidates the URL across all Varnish servers simultaneously. This ensures readers see updated content within seconds of an edit. For high-edit-rate articles (e.g., ongoing events), the cache is constantly being purged and refilled ‚Äî Varnish's <strong>request coalescing</strong> (grace mode) prevents thundering herd by serving stale content to concurrent requesters while one request refills the cache.</p>

<h3>Purge Cascade for Templates</h3>
<p>Editing a template (e.g., {{citation needed}}) requires purging ALL articles that transclude it. For popular templates, this can mean purging millions of URLs. This is done via the <strong>Job Queue</strong> (Redis-backed): a "htmlCacheUpdate" job is created for each affected page, processed asynchronously. A template used by 5M articles might take hours to fully re-cache all dependent pages.</p>
</div>

<h2>9. Scaling Considerations</h2>
<div class="card">
<h3>Infrastructure Efficiency</h3>
<p>Wikipedia serves 16B+ pageviews/month with only ~800 servers (compared to comparable sites needing 10,000+). Key factors:</p>
<ul>
<li><strong>97-98% cache hit rate:</strong> Only 2-3% of requests reach origin servers</li>
<li><strong>Read-heavy workload:</strong> ~300 edits/minute vs ~300,000 page views/minute</li>
<li><strong>No user personalization for anonymous readers:</strong> Same HTML served to all anonymous users (cache-friendly)</li>
<li><strong>MediaWiki is PHP:</strong> Simple, shared-nothing architecture ‚Äî each request is independent</li>
</ul>

<h3>Data Center Architecture</h3>
<ul>
<li><strong>Primary DC:</strong> eqiad (Ashburn, Virginia) ‚Äî handles all writes (single-primary MariaDB)</li>
<li><strong>Secondary DC:</strong> codfw (Dallas, Texas) ‚Äî warm standby, handles reads via MariaDB replicas</li>
<li><strong>Edge PoPs:</strong> esams (Amsterdam), ulsfo (San Francisco), eqsin (Singapore), drmrs (Marseille) ‚Äî Varnish edge caches only, no app servers</li>
<li><strong>DC switchover:</strong> Can promote codfw to primary within minutes for disaster recovery</li>
</ul>

<h3>MariaDB Scaling</h3>
<ul>
<li>Each language wiki has its own database (enwiki_p, dewiki_p, etc.)</li>
<li>Large wikis (en, de, fr) get dedicated MariaDB clusters with multiple read replicas</li>
<li>Small wikis (300+ languages) share database servers</li>
<li>Single-primary for writes (no multi-master) ‚Äî edit conflicts handled at application level</li>
<li>Read replicas serve all read queries via MediaWiki's <code>LoadBalancer</code> (lag-aware routing)</li>
</ul>
</div>

<h2>10. Tradeoffs</h2>
<div class="tradeoff-grid">
<div class="tradeoff-card pro">
<h4>‚úÖ Multi-Layer Varnish (Cost Efficiency)</h4>
<p>97% cache hit rate means only ~800 servers needed for 16B pageviews/month. Incredibly cost-efficient for a non-profit. Varnish is open-source, no CDN vendor dependency.</p>
</div>
<div class="tradeoff-card con">
<h4>‚ùå Cache Purge Complexity</h4>
<p>Template edits can cascade to millions of page purges. HTCP multicast is fragile at scale. Stale content can persist for seconds during purge propagation. Logged-in users bypass cache entirely (higher origin load).</p>
</div>
<div class="tradeoff-card pro">
<h4>‚úÖ Full Revision History (Never Delete)</h4>
<p>Every edit preserved forever enables: accountability, vandalism recovery, scholarly research, legal compliance, transparency. Wikipedia's core philosophy: all knowledge should be traceable.</p>
</div>
<div class="tradeoff-card con">
<h4>‚ùå Storage Growth</h4>
<p>Storing every revision's complete wikitext (not deltas) is storage-intensive. English Wikipedia alone: ~20TB of revision text. Content deduplication by SHA-1 helps (identical content stored once). But still, storage grows linearly with edit count.</p>
</div>
<div class="tradeoff-card pro">
<h4>‚úÖ Single-Primary DB (Simplicity)</h4>
<p>No multi-master complexity, no write conflicts at DB level. Edit conflicts handled cleanly at application level (optimistic locking). Simple replication topology. Easy to reason about consistency.</p>
</div>
<div class="tradeoff-card con">
<h4>‚ùå Write Bottleneck</h4>
<p>All writes go to single primary DC. If primary DC goes down, writes are unavailable until failover (~minutes). Write throughput limited by single MariaDB primary. Sufficient for Wikipedia's ~300 edits/minute but wouldn't scale for higher write volumes.</p>
</div>
</div>

<h2>11. Alternative Approaches</h2>
<div class="info-grid">
<div class="card">
<h4>CRDTs for Collaborative Editing</h4>
<p>Instead of optimistic locking with edit conflicts, use CRDTs (like Google Docs) for real-time collaborative editing. Wikipedia considered this but rejected it: wikitext is not well-suited for character-level CRDTs, editorial review process requires discrete edits (diffs), and the community values the "edit ‚Üí review ‚Üí merge" workflow over real-time collaboration.</p>
</div>
<div class="card">
<h4>Delta Storage for Revisions</h4>
<p>Store only diffs between revisions instead of full text. Saves significant storage (typical edit changes &lt;1% of article). Used by some wikis (git uses delta compression). Wikipedia chose full-text storage for simplicity: any revision can be retrieved in O(1) without reconstructing from deltas. Blob store uses content-addressing (SHA-1) for deduplication of identical content.</p>
</div>
<div class="card">
<h4>Cloud CDN (CloudFlare/Fastly)</h4>
<p>Instead of self-hosted Varnish, use a commercial CDN. Would reduce operational burden. Wikipedia chose self-hosted for: full control over cache behavior (custom VCL), no vendor lock-in, privacy (no third-party seeing all traffic), and cost (at their scale, self-hosted is cheaper than CDN pricing).</p>
</div>
<div class="card">
<h4>Static Site Generation</h4>
<p>Pre-render all articles to static HTML (like a static site generator). Would eliminate Varnish/MediaWiki for reads entirely. Challenges: 60M articles √ó 300 languages = massive generation pipeline. Template changes would require re-rendering millions of pages. Real-time edits would have minutes of delay. Wikipedia needs sub-minute edit visibility.</p>
</div>
</div>

<h2>12. Additional Information</h2>
<div class="card">
<h3>Tech Stack</h3>
<ul>
<li><strong>MediaWiki:</strong> PHP application (custom framework, not Laravel/Symfony). Powers all Wikimedia sites</li>
<li><strong>Parsoid:</strong> Node.js service for wikitext‚ÜîHTML conversion</li>
<li><strong>MariaDB:</strong> Primary database (forked from MySQL)</li>
<li><strong>Memcached:</strong> Object caching layer (~200GB total)</li>
<li><strong>Varnish:</strong> HTTP caching (self-hosted CDN)</li>
<li><strong>Elasticsearch:</strong> Full-text search (CirrusSearch extension)</li>
<li><strong>Redis:</strong> Job queue backend, session storage</li>
<li><strong>Puppet:</strong> Configuration management for all servers</li>
<li><strong>Kubernetes:</strong> Newer services (ORES, Parsoid) run on K8s</li>
</ul>

<h3>Key Numbers</h3>
<table>
<tr><td>Monthly pageviews</td><td>16B+</td></tr>
<tr><td>Total articles (all languages)</td><td>60M+</td></tr>
<tr><td>English Wikipedia articles</td><td>6.8M+</td></tr>
<tr><td>Language editions</td><td>300+</td></tr>
<tr><td>Edits per minute</td><td>~300</td></tr>
<tr><td>Active editors per month</td><td>~280,000</td></tr>
<tr><td>Total servers</td><td>~800</td></tr>
<tr><td>Annual budget</td><td>~$150M</td></tr>
<tr><td>Cache hit rate</td><td>97-98%</td></tr>
</table>

<h3>Anti-Vandalism Stack</h3>
<ul>
<li><strong>ClueBot NG:</strong> ML bot that auto-reverts obvious vandalism within seconds (~40% of vandalism caught)</li>
<li><strong>ORES:</strong> ML scoring service (damaging probability) used by human patrollers</li>
<li><strong>AbuseFilter:</strong> Rule-based filter engine (regex/conditions) configured by admins</li>
<li><strong>Page protection:</strong> Semi-protect (only autoconfirmed users can edit), full-protect (only admins)</li>
<li><strong>Flagged Revisions:</strong> On some wikis (dewiki), edits must be reviewed before being shown to anonymous readers</li>
</ul>
</div>
</div>
</body>
</html>
