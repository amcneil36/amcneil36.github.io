<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Design: YouTube</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 20px; line-height: 1.7; }
  h1 { color: #ff0000; font-size: 2.2em; border-bottom: 3px solid #ff0000; padding-bottom: 10px; }
  h2 { color: #ff4444; margin-top: 40px; }
  h3 { color: #ff7777; }
  h4 { color: #ffaaaa; }
  .section { background: #1a1a1a; padding: 25px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ff0000; }
  .subsection { background: #222; padding: 15px; border-radius: 8px; margin: 15px 0; }
  .diagram-container { background: #1e1e1e; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center; overflow-x: auto; }
  .tag { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 0.85em; margin: 2px 4px; }
  .tag-pk { background: #4a9eff33; color: #4a9eff; border: 1px solid #4a9eff66; }
  .tag-fk { background: #ff4a4a33; color: #ff4a4a; border: 1px solid #ff4a4a66; }
  .tag-idx { background: #4aff4a33; color: #4aff4a; border: 1px solid #4aff4a66; }
  .tag-shard { background: #ffa54a33; color: #ffa54a; border: 1px solid #ffa54a66; }
  table { width: 100%; border-collapse: collapse; margin: 15px 0; }
  th, td { padding: 12px; text-align: left; border: 1px solid #333; }
  th { background: #2a2a2a; color: #ff4444; }
  tr:nth-child(even) { background: #1a1a1a; }
  code { background: #2a2a2a; padding: 2px 8px; border-radius: 4px; color: #ff7777; font-family: 'Fira Code', monospace; }
  pre { background: #1a1a1a; padding: 20px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
  .example { background: #0d2818; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #4aff4a; }
  .tradeoff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
  .tradeoff-pro { background: #0d2818; padding: 15px; border-radius: 8px; border-left: 3px solid #4aff4a; }
  .tradeoff-con { background: #2d1018; padding: 15px; border-radius: 8px; border-left: 3px solid #ff4a4a; }
  ul, ol { padding-left: 25px; }
  li { margin: 6px 0; }
</style>
</head>
<body>

<h1>‚ñ∂Ô∏è System Design: YouTube (Video Streaming Platform)</h1>

<div class="section">
<h2>üìã Functional Requirements</h2>
<ul>
  <li>Creators can upload videos in any format ‚Äî system transcodes to multiple resolutions</li>
  <li>Viewers can stream videos with adaptive bitrate (auto quality adjustment)</li>
  <li>Users can search for videos by title, description, tags</li>
  <li>Users can like, comment, subscribe, and view personalized recommendations</li>
</ul>
</div>

<div class="section">
<h2>üîí Non-Functional Requirements</h2>
<ul>
  <li><strong>Scale:</strong> 800M+ videos, 500 hours uploaded per minute, 1B hours watched per day</li>
  <li><strong>Low latency streaming:</strong> Video playback starts in &lt;2s, rebuffering ratio &lt;0.5%</li>
  <li><strong>High availability:</strong> 99.99% uptime globally</li>
  <li><strong>Efficient storage:</strong> ~1PB of new video per day after transcoding</li>
  <li><strong>Global distribution:</strong> CDN serving from edge locations worldwide</li>
</ul>
</div>

<!-- ============================================================ -->
<h2>üîÑ Flow 1 ‚Äî Video Upload & Processing Pipeline</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1200 420" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ah1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="170" width="110" height="60" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="75" y="198" text-anchor="middle" fill="white" font-size="13">Creator</text>
  <text x="75" y="215" text-anchor="middle" fill="white" font-size="10">(Upload Client)</text>
  <line x1="130" y1="200" x2="190" y2="200" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="200" y="170" width="130" height="60" rx="10" fill="#c97a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="265" y="195" text-anchor="middle" fill="white" font-size="12">Upload Service</text>
  <text x="265" y="212" text-anchor="middle" fill="white" font-size="10">(Resumable / Chunked)</text>
  <line x1="330" y1="200" x2="390" y2="200" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="400" y="170" width="130" height="60" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="465" y="195" text-anchor="middle" fill="white" font-size="12">Object Storage</text>
  <text x="465" y="212" text-anchor="middle" fill="white" font-size="10">(GCS ‚Äî Raw Video)</text>
  <line x1="530" y1="200" x2="590" y2="200" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="600" y="170" width="140" height="60" rx="10" fill="#6a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="670" y="195" text-anchor="middle" fill="white" font-size="12">Kafka / Pub-Sub</text>
  <text x="670" y="212" text-anchor="middle" fill="white" font-size="10">(transcode-jobs)</text>
  <line x1="740" y1="180" x2="810" y2="110" stroke="#aaa" marker-end="url(#ah1)"/>
  <line x1="740" y1="200" x2="810" y2="200" stroke="#aaa" marker-end="url(#ah1)"/>
  <line x1="740" y1="220" x2="810" y2="290" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="820" y="80" width="160" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="900" y="103" text-anchor="middle" fill="white" font-size="11">Transcoder Workers</text>
  <text x="900" y="120" text-anchor="middle" fill="white" font-size="10">(FFmpeg ‚Äî GPU Cluster)</text>
  <rect x="820" y="175" width="160" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="900" y="198" text-anchor="middle" fill="white" font-size="11">Thumbnail Generator</text>
  <text x="900" y="215" text-anchor="middle" fill="white" font-size="10">(ML Scene Detection)</text>
  <rect x="820" y="270" width="160" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="900" y="293" text-anchor="middle" fill="white" font-size="11">Content Moderation</text>
  <text x="900" y="310" text-anchor="middle" fill="white" font-size="10">(ML + Human Review)</text>
  <line x1="980" y1="108" x2="1040" y2="200" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="1040" y="175" width="130" height="55" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="1105" y="198" text-anchor="middle" fill="white" font-size="11">CDN Origin</text>
  <text x="1105" y="215" text-anchor="middle" fill="white" font-size="10">(Transcoded Segments)</text>
</svg>
</div>

<div class="section">
<h3>Step-by-Step</h3>
<ol>
  <li><strong>Creator initiates upload:</strong> <code>POST /api/v3/videos?uploadType=resumable</code> ‚Üí returns upload URI. Client uploads video in 8MB chunks with progress tracking. Supports resume on network interruption</li>
  <li><strong>Upload Service:</strong> Validates file type, size limit (256GB max), user quota. Stores raw video in Google Cloud Storage (GCS) with lifecycle policy. Generates video_id (Base62 encoded, 11 chars like <code>dQw4w9WgXcQ</code>)</li>
  <li><strong>Metadata saved:</strong> Video record created in DB with status <code>processing</code>. Title, description, tags, channel_id stored</li>
  <li><strong>Pub/Sub message:</strong> Transcode job message published: <code>{ video_id, raw_path, target_resolutions: [144p, 240p, 360p, 480p, 720p, 1080p, 1440p, 2160p] }</code></li>
  <li><strong>Transcoder Workers (GPU):</strong> Each worker pulls a job ‚Üí downloads raw video ‚Üí FFmpeg transcodes to target resolution with H.264/H.265/VP9/AV1 codecs ‚Üí segments into 2-6 second chunks ‚Üí generates MPD/M3U8 manifest for DASH/HLS</li>
  <li><strong>Thumbnail Generator:</strong> ML model selects 3 key frames (scene changes, faces, text) ‚Üí generates thumbnails at multiple sizes ‚Üí creator can choose or upload custom</li>
  <li><strong>Content Moderation:</strong> ML classifiers check for: nudity (NSFW), violence, copyright (Content ID fingerprinting against reference library of 100M+ assets), hate speech in audio (speech-to-text + NLP)</li>
  <li><strong>CDN distribution:</strong> Transcoded segments pushed to CDN origin ‚Üí replicated to edge PoPs. Video status ‚Üí <code>published</code></li>
</ol>

<div class="example">
<strong>Example:</strong> Creator uploads 4K 30-minute vlog (8GB raw) ‚Üí Upload Service: resumable upload completes in ~12 min on 100Mbps ‚Üí Transcoder: 8 resolution variants √ó 3 codecs = 24 renditions ‚Üí Total output: ~15GB across all variants ‚Üí 900 segments (2s each √ó 30 min) per rendition ‚Üí Content ID: no copyright match ‚Üí Published in ~20 minutes ‚Üí First viewer in US streams 1080p ‚Üí CDN edge in Virginia serves pre-cached segments
</div>
</div>

<div class="section">
<h3>üîç Component Deep Dives ‚Äî Upload Flow</h3>

<div class="subsection">
<h4>Transcoding Pipeline</h4>
<p><strong>Codec ladder:</strong></p>
<table>
<tr><th>Resolution</th><th>H.264 Bitrate</th><th>VP9 Bitrate</th><th>AV1 Bitrate</th></tr>
<tr><td>2160p (4K)</td><td>20 Mbps</td><td>12 Mbps</td><td>8 Mbps</td></tr>
<tr><td>1080p</td><td>8 Mbps</td><td>5 Mbps</td><td>3.5 Mbps</td></tr>
<tr><td>720p</td><td>5 Mbps</td><td>3 Mbps</td><td>2 Mbps</td></tr>
<tr><td>480p</td><td>2.5 Mbps</td><td>1.5 Mbps</td><td>1 Mbps</td></tr>
<tr><td>360p</td><td>1 Mbps</td><td>0.7 Mbps</td><td>0.5 Mbps</td></tr>
</table>
<p><strong>Per-title encoding:</strong> Netflix-pioneered technique ‚Äî analyze video complexity first (animation vs live action vs sports), then optimize bitrate ladder per video. A cartoon needs fewer bits than a fast-action sports clip at the same resolution.</p>
<p><strong>Parallel transcoding:</strong> Split video into GOP-aligned segments, transcode segments in parallel across workers, merge. Reduces wall-clock time from hours to minutes for long videos.</p>
</div>

<div class="subsection">
<h4>Content ID (Copyright Detection)</h4>
<p><strong>How it works:</strong> Reference content owners upload their media ‚Üí system generates audio/visual fingerprint. Every uploaded video is fingerprinted and compared against the reference database (~100M+ assets).</p>
<p><strong>Fingerprinting:</strong> Audio: chromagram-based spectral fingerprint. Visual: perceptual hash of key frames. Both are robust to transcoding, cropping, speed changes.</p>
<p><strong>Actions:</strong> Match found ‚Üí content owner policy applies: (1) Block video, (2) Monetize (run ads, revenue to rights holder), (3) Track (just monitor). Most choose monetize.</p>
</div>

<div class="subsection">
<h4>Resumable Upload Protocol</h4>
<p><strong>Protocol:</strong> Google's Resumable Upload protocol over HTTPS</p>
<p><strong>Flow:</strong> (1) Client POSTs metadata ‚Üí gets upload URI, (2) Client PUTs video data in chunks, (3) If interrupted, client queries upload status ‚Üí server reports last received byte, (4) Client resumes from that byte offset</p>
<p><strong>Why:</strong> Video files are large (GBs). Without resumability, a network hiccup at 99% would require re-uploading everything. Critical for mobile uploads on unreliable connections.</p>
</div>
</div>

<!-- ============================================================ -->
<h2>üîÑ Flow 2 ‚Äî Video Streaming (Playback)</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1100 380" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ah2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="160" width="110" height="60" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="75" y="188" text-anchor="middle" fill="white" font-size="13">Viewer</text>
  <text x="75" y="205" text-anchor="middle" fill="white" font-size="10">(Video Player)</text>
  <line x1="130" y1="190" x2="200" y2="190" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="210" y="160" width="140" height="60" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="280" y="185" text-anchor="middle" fill="white" font-size="12">Video API</text>
  <text x="280" y="202" text-anchor="middle" fill="white" font-size="10">(Metadata + Manifest)</text>
  <line x1="350" y1="190" x2="420" y2="190" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="430" y="160" width="140" height="60" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="500" y="185" text-anchor="middle" fill="white" font-size="12">CDN Edge PoP</text>
  <text x="500" y="202" text-anchor="middle" fill="white" font-size="10">(Nearest Location)</text>
  <line x1="570" y1="175" x2="640" y2="120" stroke="#aaa" marker-end="url(#ah2)"/>
  <line x1="570" y1="205" x2="640" y2="260" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="650" y="90" width="160" height="55" rx="10" fill="#1a8a7a" stroke="#4afff0" stroke-width="2"/>
  <text x="730" y="115" text-anchor="middle" fill="white" font-size="12">Cache HIT</text>
  <text x="730" y="132" text-anchor="middle" fill="white" font-size="10">(Serve from Edge)</text>
  <rect x="650" y="235" width="160" height="55" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="730" y="258" text-anchor="middle" fill="white" font-size="12">Cache MISS</text>
  <text x="730" y="275" text-anchor="middle" fill="white" font-size="10">(Fetch from Origin)</text>
  <line x1="810" y1="262" x2="880" y2="262" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="890" y="235" width="140" height="55" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="960" y="258" text-anchor="middle" fill="white" font-size="12">Origin (GCS)</text>
  <text x="960" y="275" text-anchor="middle" fill="white" font-size="10">(Fill ‚Üí Edge Cache)</text>
</svg>
</div>

<div class="section">
<h3>Step-by-Step</h3>
<ol>
  <li><strong>Player requests video:</strong> <code>GET /api/v3/videos/dQw4w9WgXcQ</code> ‚Üí returns metadata (title, description, channel) + streaming manifest URL</li>
  <li><strong>Manifest fetch:</strong> Player fetches DASH MPD or HLS M3U8 manifest from CDN. Manifest lists all available resolutions + segment URLs</li>
  <li><strong>Adaptive Bitrate (ABR):</strong> Player's ABR algorithm selects initial resolution based on connection speed estimate. Starts with lower quality for fast start, ramps up</li>
  <li><strong>Segment requests:</strong> Player requests 2-6 second video segments sequentially from CDN: <code>GET /v/dQw4w9WgXcQ/seg-0001-1080p.m4s</code></li>
  <li><strong>CDN edge serve:</strong> If segment is cached at edge (cache HIT ~95% for popular videos) ‚Üí serve directly. If MISS ‚Üí fetch from regional cache ‚Üí origin (GCS) ‚Üí cache at edge for subsequent requests</li>
  <li><strong>Quality switching:</strong> During playback, ABR continuously monitors buffer level + throughput. If bandwidth drops ‚Üí switch to lower resolution on next segment boundary (seamless switch)</li>
  <li><strong>View counted:</strong> After ~30 seconds of playback, view count event fired ‚Üí Kafka ‚Üí async increment</li>
</ol>

<div class="example">
<strong>Example:</strong> Viewer clicks video ‚Üí Player fetches manifest (50KB, cached at edge) ‚Üí ABR: estimated 15Mbps connection ‚Üí starts at 720p ‚Üí first segment in 0.8s ‚Üí buffer fills, switches to 1080p at segment 3 ‚Üí viewer on subway: bandwidth drops to 2Mbps ‚Üí ABR detects buffer draining ‚Üí switches to 360p at segment 45 ‚Üí bandwidth recovers ‚Üí back to 720p seamlessly
</div>
</div>

<div class="section">
<h3>üîç Component Deep Dives ‚Äî Streaming Flow</h3>

<div class="subsection">
<h4>DASH vs HLS (Adaptive Streaming Protocols)</h4>
<table>
<tr><th>Feature</th><th>DASH (Dynamic Adaptive Streaming over HTTP)</th><th>HLS (HTTP Live Streaming)</th></tr>
<tr><td>Manifest</td><td>MPD (XML)</td><td>M3U8 (plaintext playlist)</td></tr>
<tr><td>Segment format</td><td>fMP4, WebM</td><td>fMP4, MPEG-TS</td></tr>
<tr><td>Browser support</td><td>MSE-based (most browsers)</td><td>Native Safari, MSE others</td></tr>
<tr><td>Codec support</td><td>Any (VP9, AV1, H.264, H.265)</td><td>H.264, H.265, limited AV1</td></tr>
<tr><td>DRM</td><td>CENC (Widevine, PlayReady)</td><td>FairPlay (Apple)</td></tr>
</table>
<p><strong>YouTube uses DASH</strong> primarily (with HLS fallback for Apple devices). DASH allows more codec flexibility (YouTube is pushing AV1 adoption for bandwidth savings).</p>
</div>

<div class="subsection">
<h4>ABR (Adaptive Bitrate) Algorithm</h4>
<p><strong>Buffer-Based (BBA):</strong> YouTube uses a buffer-based approach ‚Äî decisions based on current buffer level, not just throughput:</p>
<ul>
  <li>Buffer &lt; 5s ‚Üí drop to lowest quality (avoid rebuffer at all costs)</li>
  <li>Buffer 5-15s ‚Üí choose quality matching recent throughput</li>
  <li>Buffer &gt; 15s ‚Üí try next higher quality</li>
</ul>
<p><strong>Why not throughput-based?</strong> Throughput estimation is noisy (varies wildly on mobile). Buffer level is a more stable signal of whether the player can sustain current quality.</p>
</div>

<div class="subsection">
<h4>CDN Architecture (Multi-Tier)</h4>
<p><strong>Tier 1 ‚Äî Edge PoPs:</strong> Hundreds of locations worldwide. Cache hot content (videos viewed in last hour). ~95% cache hit rate for popular videos. SSD-backed</p>
<p><strong>Tier 2 ‚Äî Regional Caches:</strong> ~20 locations. Broader cache for less popular content. Edge misses go here before origin</p>
<p><strong>Tier 3 ‚Äî Origin (GCS):</strong> All transcoded segments stored permanently. Only accessed on cold content or initial cache fill</p>
<p><strong>Long tail problem:</strong> ~80% of YouTube's videos are watched &lt;100 times total. These "long tail" videos are not cached at edge ‚Äî served from regional/origin. Google's Peering CDN (Google Global Cache) is installed directly in ISP data centers for better performance.</p>
</div>
</div>

<!-- ============================================================ -->
<h2>üîÑ Flow 3 ‚Äî Video Search</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1000 300" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ah3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="120" width="110" height="60" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="75" y="155" text-anchor="middle" fill="white" font-size="14">User</text>
  <line x1="130" y1="150" x2="200" y2="150" stroke="#aaa" marker-end="url(#ah3)"/>
  <rect x="210" y="120" width="140" height="60" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="280" y="148" text-anchor="middle" fill="white" font-size="12">Search Service</text>
  <text x="280" y="165" text-anchor="middle" fill="white" font-size="10">(Query Understanding)</text>
  <line x1="350" y1="150" x2="420" y2="150" stroke="#aaa" marker-end="url(#ah3)"/>
  <rect x="430" y="120" width="150" height="60" rx="10" fill="#8a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="505" y="148" text-anchor="middle" fill="white" font-size="12">Video Search Index</text>
  <text x="505" y="165" text-anchor="middle" fill="white" font-size="10">(Inverted Index)</text>
  <line x1="580" y1="150" x2="650" y2="150" stroke="#aaa" marker-end="url(#ah3)"/>
  <rect x="660" y="120" width="150" height="60" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="735" y="148" text-anchor="middle" fill="white" font-size="12">Ranking Service</text>
  <text x="735" y="165" text-anchor="middle" fill="white" font-size="10">(ML ‚Äî CTR + Watch Time)</text>
</svg>
</div>

<div class="section">
<h3>Step-by-Step</h3>
<ol>
  <li><strong>User searches:</strong> <code>GET /api/v3/search?q=python+tutorial+beginners&type=video</code></li>
  <li><strong>Query Understanding:</strong> Spell correction, synonym expansion, entity detection ("python" ‚Üí programming language, not snake), intent classification (tutorial-seeking)</li>
  <li><strong>Index query:</strong> Inverted index lookup on tokenized title, description, tags, auto-generated captions. Initial retrieval: ~10K candidates</li>
  <li><strong>Ranking:</strong> ML model scores candidates based on: query relevance (BM25 text match), predicted CTR (click-through rate), predicted watch time, video freshness, channel authority, user personalization (watch history, subscriptions)</li>
  <li><strong>Return top 20:</strong> Paginated results with thumbnails, title, channel, view count, upload date, duration</li>
</ol>

<div class="example">
<strong>Example:</strong> User searches "python tutorial beginners" ‚Üí 15K candidate videos match text ‚Üí Ranking model: "Automate the Boring Stuff" (high watch time completion), "Python for Beginners" (most views), "Learn Python in 1 Hour" (recent, high CTR) ‚Üí User has Java tutorials in watch history ‚Üí personalization boosts "Python for Java Developers" ‚Üí Results returned in 150ms
</div>
</div>

<!-- ============================================================ -->
<h2>üèóÔ∏è Combined Architecture</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ahc" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <!-- Clients -->
  <rect x="20" y="60" width="120" height="45" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="80" y="87" text-anchor="middle" fill="white" font-size="12">Web Player</text>
  <rect x="20" y="120" width="120" height="45" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="80" y="147" text-anchor="middle" fill="white" font-size="12">Mobile App</text>
  <rect x="20" y="180" width="120" height="45" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="80" y="207" text-anchor="middle" fill="white" font-size="12">Smart TV</text>
  <!-- LB -->
  <line x1="140" y1="90" x2="220" y2="140" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="140" y1="142" x2="220" y2="142" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="140" y1="200" x2="220" y2="150" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="230" y="115" width="140" height="55" rx="10" fill="#c97a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="300" y="138" text-anchor="middle" fill="white" font-size="12">API Gateway / LB</text>
  <text x="300" y="155" text-anchor="middle" fill="white" font-size="10">(Global L7)</text>
  <!-- Services -->
  <line x1="370" y1="125" x2="450" y2="60" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="370" y1="135" x2="450" y2="135" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="370" y1="145" x2="450" y2="210" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="370" y1="155" x2="450" y2="285" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="370" y1="160" x2="450" y2="360" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="460" y="35" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="530" y="65" text-anchor="middle" fill="white" font-size="11">Upload Service</text>
  <rect x="460" y="110" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="530" y="140" text-anchor="middle" fill="white" font-size="11">Video API</text>
  <rect x="460" y="185" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="530" y="215" text-anchor="middle" fill="white" font-size="11">Search Service</text>
  <rect x="460" y="260" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="530" y="290" text-anchor="middle" fill="white" font-size="11">Recommendation</text>
  <rect x="460" y="335" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="530" y="365" text-anchor="middle" fill="white" font-size="11">Comment Service</text>
  <!-- Processing -->
  <line x1="600" y1="60" x2="680" y2="60" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="690" y="35" width="150" height="50" rx="10" fill="#6a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="765" y="55" text-anchor="middle" fill="white" font-size="11">Transcode Pipeline</text>
  <text x="765" y="72" text-anchor="middle" fill="white" font-size="10">(Kafka + GPU Workers)</text>
  <!-- Databases -->
  <line x1="600" y1="135" x2="680" y2="135" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="600" y1="210" x2="680" y2="210" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="690" y="110" width="150" height="50" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="765" y="130" text-anchor="middle" fill="white" font-size="11">Vitess / MySQL</text>
  <text x="765" y="147" text-anchor="middle" fill="white" font-size="10">(Video Metadata)</text>
  <rect x="690" y="185" width="150" height="50" rx="10" fill="#8a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="765" y="205" text-anchor="middle" fill="white" font-size="11">Search Index</text>
  <text x="765" y="222" text-anchor="middle" fill="white" font-size="10">(Inverted Index)</text>
  <line x1="600" y1="285" x2="680" y2="280" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="690" y="260" width="150" height="50" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="765" y="280" text-anchor="middle" fill="white" font-size="11">Bigtable</text>
  <text x="765" y="297" text-anchor="middle" fill="white" font-size="10">(Watch History, Recs)</text>
  <line x1="600" y1="360" x2="680" y2="340" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="690" y="335" width="150" height="50" rx="10" fill="#1a8a7a" stroke="#4afff0" stroke-width="2"/>
  <text x="765" y="355" text-anchor="middle" fill="white" font-size="11">Redis</text>
  <text x="765" y="372" text-anchor="middle" fill="white" font-size="10">(View Counts, Sessions)</text>
  <!-- Storage -->
  <line x1="840" y1="60" x2="920" y2="60" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="930" y="35" width="160" height="50" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="1010" y="55" text-anchor="middle" fill="white" font-size="11">GCS (Object Storage)</text>
  <text x="1010" y="72" text-anchor="middle" fill="white" font-size="10">(Raw + Transcoded)</text>
  <rect x="930" y="110" width="160" height="50" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="1010" y="130" text-anchor="middle" fill="white" font-size="11">CDN (Global Edge)</text>
  <text x="1010" y="147" text-anchor="middle" fill="white" font-size="10">(Video Segments)</text>
  <line x1="1010" y1="85" x2="1010" y2="105" stroke="#aaa" marker-end="url(#ahc)"/>
</svg>
</div>

<div class="example">
<strong>End-to-End:</strong> Creator uploads 4K video ‚Üí Upload Service stores raw in GCS ‚Üí Kafka triggers transcode pipeline ‚Üí GPU workers produce 8 resolutions √ó 3 codecs ‚Üí Content ID checks copyright ‚Üí Published ‚Üí CDN distributes ‚Üí Viewer searches "tutorial" ‚Üí Search Service ranks by relevance + personalization ‚Üí Viewer clicks ‚Üí Player fetches DASH manifest ‚Üí ABR selects 1080p ‚Üí CDN edge serves segments ‚Üí View event ‚Üí Kafka ‚Üí async view count increment + recommendation update ‚Üí Next viewer sees video in recommendations
</div>

<!-- ============================================================ -->
<h2>üóÑÔ∏è Database Schema</h2>
<!-- ============================================================ -->

<div class="section">
<h3>Vitess/MySQL ‚Äî Video Metadata</h3>

<h4>videos</h4>
<table>
<tr><th>Column</th><th>Type</th><th>Notes</th></tr>
<tr><td>id</td><td>VARCHAR(11)</td><td><span class="tag tag-pk">PK</span> Base62 encoded (dQw4w9WgXcQ)</td></tr>
<tr><td>channel_id</td><td>VARCHAR(24)</td><td><span class="tag tag-fk">FK ‚Üí channels</span><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>title</td><td>VARCHAR(100)</td><td></td></tr>
<tr><td>description</td><td>TEXT</td><td></td></tr>
<tr><td>duration_seconds</td><td>INTEGER</td><td></td></tr>
<tr><td>view_count</td><td>BIGINT</td><td>Denormalized, updated async</td></tr>
<tr><td>like_count</td><td>BIGINT</td><td>Denormalized</td></tr>
<tr><td>category_id</td><td>INTEGER</td><td></td></tr>
<tr><td>tags</td><td>JSON</td><td></td></tr>
<tr><td>thumbnail_url</td><td>TEXT</td><td></td></tr>
<tr><td>manifest_url</td><td>TEXT</td><td>DASH MPD path</td></tr>
<tr><td>status</td><td>VARCHAR(20)</td><td>processing / published / blocked / private / unlisted</td></tr>
<tr><td>privacy</td><td>VARCHAR(20)</td><td>public / unlisted / private</td></tr>
<tr><td>upload_date</td><td>TIMESTAMPTZ</td><td><span class="tag tag-idx">INDEX</span></td></tr>
</table>

<h4>channels</h4>
<table>
<tr><th>Column</th><th>Type</th><th>Notes</th></tr>
<tr><td>id</td><td>VARCHAR(24)</td><td><span class="tag tag-pk">PK</span></td></tr>
<tr><td>name</td><td>VARCHAR(100)</td><td></td></tr>
<tr><td>owner_user_id</td><td>BIGINT</td><td><span class="tag tag-fk">FK ‚Üí users</span></td></tr>
<tr><td>subscriber_count</td><td>BIGINT</td><td>Denormalized</td></tr>
<tr><td>total_views</td><td>BIGINT</td><td>Denormalized</td></tr>
<tr><td>created_at</td><td>TIMESTAMPTZ</td><td></td></tr>
</table>

<h3>Bigtable ‚Äî User Data (NoSQL)</h3>
<pre>
Table: user_watch_history
Row Key: {user_id}#{reverse_timestamp}
Column Family: video
  - video:id = "dQw4w9WgXcQ"
  - video:watch_pct = 0.85
  - video:timestamp = 1707500000

Table: video_comments
Row Key: {video_id}#{timestamp}#{comment_id}
Column Family: comment
  - comment:user_id = "12345"
  - comment:text = "Great tutorial!"
  - comment:likes = 42
  - comment:reply_to = null
</pre>

<h3>Sharding Strategy</h3>
<p><strong>videos:</strong> Vitess (sharded MySQL) ‚Äî shard by <code>video_id</code> hash. YouTube uses Vitess (which they created) for horizontal MySQL scaling <span class="tag tag-shard">HASH SHARD</span></p>
<p><strong>user_watch_history:</strong> Bigtable ‚Äî row key prefix is user_id, so all history for a user is on same tablet (Bigtable's shard unit) <span class="tag tag-shard">PREFIX SHARD</span></p>
<p><strong>comments:</strong> Shard by <code>video_id</code> ‚Äî all comments for a video co-located <span class="tag tag-shard">HASH SHARD</span></p>
</div>

<!-- ============================================================ -->
<h2>üíæ Cache & CDN Deep Dive</h2>
<!-- ============================================================ -->

<div class="section">
<h3>CDN Caching Strategy</h3>
<table>
<tr><th>Content</th><th>Cache Location</th><th>TTL</th><th>Hit Rate</th></tr>
<tr><td>Popular video segments</td><td>Edge PoP (L1)</td><td>24 hr</td><td>~95%</td></tr>
<tr><td>Moderate video segments</td><td>Regional cache (L2)</td><td>7 days</td><td>~85%</td></tr>
<tr><td>Long-tail videos</td><td>Origin (GCS)</td><td>Permanent</td><td>N/A</td></tr>
<tr><td>Thumbnails</td><td>Edge PoP</td><td>30 days</td><td>~99%</td></tr>
<tr><td>Manifests (MPD/M3U8)</td><td>Edge PoP</td><td>1 hr</td><td>~98%</td></tr>
</table>

<h3>Redis Caching</h3>
<ul>
  <li><strong>View counts:</strong> <code>INCR views:{video_id}</code> ‚Äî buffered in Redis, flushed to MySQL every minute. Prevents write amplification from billions of view events</li>
  <li><strong>Session/auth:</strong> User session tokens cached in Redis (TTL 30 min)</li>
  <li><strong>Rate limiting:</strong> Upload rate limits per user in Redis sliding window</li>
</ul>

<h3>Google Global Cache (GGC)</h3>
<p>Google deploys cache servers directly inside ISP networks. ISP traffic to YouTube stays within their network ‚Äî reduces transit costs for ISP, reduces latency for users. Over 1,000 ISPs worldwide have GGC deployments. This is why YouTube feels "fast" even on average internet connections.</p>
</div>

<!-- ============================================================ -->
<h2>‚öñÔ∏è Scaling Considerations</h2>
<!-- ============================================================ -->

<div class="section">
<ul>
  <li><strong>Transcoding:</strong> GPU clusters auto-scale based on upload queue depth. Spot/preemptible instances for cost savings (transcode jobs are restartable)</li>
  <li><strong>View count hot spots:</strong> Viral videos get millions of INCR per second. Sharded Redis counters (split into 100 sub-counters, aggregate on read) prevent hot key problems</li>
  <li><strong>Storage costs:</strong> ~1 exabyte total. Cold storage (Coldline) for rarely-watched videos. Per-title encoding optimizes bitrate ‚Üí reduces storage by ~20%</li>
  <li><strong>CDN capacity:</strong> Peak traffic during evening hours per timezone. CDN auto-scales at edge. Pre-warming: when a popular creator's video is detected (subscriber notification), pre-push segments to regional caches before traffic arrives</li>
  <li><strong>Database:</strong> Vitess provides transparent sharding for MySQL. Add shards as data grows without application changes</li>
</ul>
</div>

<!-- ============================================================ -->
<h2>‚öñÔ∏è Tradeoffs</h2>
<!-- ============================================================ -->

<div class="section">
<div class="tradeoff-grid">
  <div class="tradeoff-pro">
    <h4>‚úÖ Pre-transcoding All Resolutions</h4>
    <p>Instant playback at any quality. No transcoding delay at view time. CDN can cache fixed segments</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå Pre-transcoding All Resolutions</h4>
    <p>Massive storage cost (8+ renditions per video). Most 144p/240p renditions rarely accessed. Alternative: just-in-time transcoding for low-demand resolutions</p>
  </div>
  <div class="tradeoff-pro">
    <h4>‚úÖ Segmented Streaming (DASH/HLS)</h4>
    <p>Adaptive bitrate, works over HTTP (CDN-friendly), seekable, no special streaming server needed</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå Segmented Streaming</h4>
    <p>Higher latency than WebRTC (2-30s delay). Segment boundaries limit quality switch speed. Manifest overhead for short videos</p>
  </div>
  <div class="tradeoff-pro">
    <h4>‚úÖ AV1 Codec</h4>
    <p>30-50% bitrate savings over H.264 at same quality ‚Üí massive CDN bandwidth savings at YouTube's scale</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå AV1 Codec</h4>
    <p>10x slower encoding (higher compute cost), limited hardware decoding support (newer devices only), H.264 still needed as fallback</p>
  </div>
</div>
</div>

<!-- ============================================================ -->
<h2>üîÑ Alternative Approaches</h2>
<!-- ============================================================ -->

<div class="section">
<div class="subsection">
<h4>Just-In-Time Transcoding</h4>
<p>Only transcode on first view at that resolution. Saves storage for long-tail content that's rarely watched. Used by some smaller platforms. Tradeoff: first viewer experiences delay, requires fast transcoding infrastructure (GPU always warm).</p>
</div>
<div class="subsection">
<h4>WebRTC for Low-Latency (Live Streaming)</h4>
<p>YouTube Live uses WebRTC for ultra-low-latency streams (&lt;1s). Sub-second latency enables real-time interaction. But doesn't scale to millions of viewers without SFU cascading. DASH/HLS used for most live streams with 5-30s latency instead.</p>
</div>
<div class="subsection">
<h4>P2P-Assisted CDN</h4>
<p>Viewers share video segments with nearby peers (like BitTorrent). Reduces CDN cost by offloading bandwidth to viewers. Used by some Chinese platforms (Bilibili). Drawback: reliability depends on peer availability, privacy concerns, NAT traversal complexity.</p>
</div>
</div>

<!-- ============================================================ -->
<h2>üìö Additional Information</h2>
<!-- ============================================================ -->

<div class="section">
<h3>Recommendation Engine</h3>
<p>YouTube's recommendation drives 70%+ of watch time. Two-stage architecture: (1) Candidate generation ‚Äî collaborative filtering from watch history (deep neural network with embedding layers), retrieves ~1000 candidates. (2) Ranking ‚Äî predicts expected watch time using features: user history, video features (title, tags, freshness, channel), context (time of day, device). Optimizes for engagement metrics (watch time, not just clicks).</p>

<h3>Video ID Design</h3>
<p>YouTube video IDs are 11 characters, Base64url encoded: [A-Za-z0-9_-]. This gives 64^11 = 73.8 quadrillion possible IDs. IDs are not sequential (security through obscurity ‚Äî can't enumerate all videos). Generated randomly with collision check.</p>

<h3>Monetization Infrastructure</h3>
<p>Ad serving during video playback: pre-roll (before video), mid-roll (during, at natural breaks), post-roll. Ad decisions made in real-time by auction system (similar to Ad Click Aggregator design). Revenue split: 55% to creator, 45% to YouTube. Super Chat, Memberships, and Merchandise Shelf are additional revenue streams, each with their own microservices.</p>
</div>

</body>
</html>
