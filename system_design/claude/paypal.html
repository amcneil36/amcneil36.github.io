<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Design: PayPal</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 20px; line-height: 1.7; }
  h1 { color: #003087; font-size: 2.2em; border-bottom: 3px solid #003087; padding-bottom: 10px; }
  h2 { color: #0070ba; margin-top: 40px; }
  h3 { color: #00a0df; }
  h4 { color: #55c3f0; }
  .section { background: #1a1a1a; padding: 25px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #0070ba; }
  .subsection { background: #222; padding: 15px; border-radius: 8px; margin: 15px 0; }
  .diagram-container { background: #1e1e1e; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center; overflow-x: auto; }
  .tag { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 0.85em; margin: 2px 4px; }
  .tag-pk { background: #4a9eff33; color: #4a9eff; border: 1px solid #4a9eff66; }
  .tag-fk { background: #ff4a4a33; color: #ff4a4a; border: 1px solid #ff4a4a66; }
  .tag-idx { background: #4aff4a33; color: #4aff4a; border: 1px solid #4aff4a66; }
  .tag-shard { background: #ffa54a33; color: #ffa54a; border: 1px solid #ffa54a66; }
  table { width: 100%; border-collapse: collapse; margin: 15px 0; }
  th, td { padding: 12px; text-align: left; border: 1px solid #333; }
  th { background: #2a2a2a; color: #0070ba; }
  tr:nth-child(even) { background: #1a1a1a; }
  code { background: #2a2a2a; padding: 2px 8px; border-radius: 4px; color: #55c3f0; font-family: 'Fira Code', monospace; }
  pre { background: #1a1a1a; padding: 20px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
  .example { background: #0d2818; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #4aff4a; }
  .tradeoff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
  .tradeoff-pro { background: #0d2818; padding: 15px; border-radius: 8px; border-left: 3px solid #4aff4a; }
  .tradeoff-con { background: #2d1018; padding: 15px; border-radius: 8px; border-left: 3px solid #ff4a4a; }
  ul, ol { padding-left: 25px; }
  li { margin: 6px 0; }
</style>
</head>
<body>

<h1>üí∞ System Design: PayPal (Digital Payment Platform)</h1>

<div class="section">
<h2>üìã Functional Requirements</h2>
<ul>
  <li>Users can send money to other users (P2P payments) via email/phone</li>
  <li>Users can pay merchants for goods/services (checkout integration)</li>
  <li>Users can link bank accounts, cards, and manage a PayPal balance</li>
  <li>Support for multi-currency transactions with real-time exchange rates</li>
</ul>
</div>

<div class="section">
<h2>üîí Non-Functional Requirements</h2>
<ul>
  <li><strong>Strong consistency:</strong> Financial transactions must be ACID ‚Äî no double-spending, no lost money</li>
  <li><strong>Idempotency:</strong> Every payment request must be safely retryable without duplicate charges</li>
  <li><strong>PCI-DSS compliance:</strong> Card data tokenized, encrypted at rest (AES-256), HSM for key management</li>
  <li><strong>High availability:</strong> 99.99% uptime ‚Äî payment failures directly impact revenue</li>
  <li><strong>Low latency:</strong> &lt;2s end-to-end for payment processing</li>
  <li><strong>Fraud prevention:</strong> Real-time ML fraud detection on every transaction</li>
  <li><strong>Scale:</strong> ~40M transactions/day, $1.5T annual payment volume</li>
</ul>
</div>

<!-- ============================================================ -->
<h2>üîÑ Flow 1 ‚Äî P2P Payment (Send Money)</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1200 400" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ah1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="160" width="110" height="60" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="75" y="195" text-anchor="middle" fill="white" font-size="14">Sender App</text>
  <line x1="130" y1="190" x2="190" y2="190" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="200" y="160" width="130" height="60" rx="10" fill="#c97a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="265" y="188" text-anchor="middle" fill="white" font-size="13">API Gateway</text>
  <text x="265" y="205" text-anchor="middle" fill="white" font-size="10">(Auth + Idempotency)</text>
  <line x1="330" y1="190" x2="390" y2="190" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="400" y="160" width="140" height="60" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="470" y="185" text-anchor="middle" fill="white" font-size="13">Payment</text>
  <text x="470" y="202" text-anchor="middle" fill="white" font-size="10">Orchestrator</text>
  <line x1="540" y1="175" x2="610" y2="110" stroke="#aaa" marker-end="url(#ah1)"/>
  <line x1="540" y1="190" x2="610" y2="190" stroke="#aaa" marker-end="url(#ah1)"/>
  <line x1="540" y1="205" x2="610" y2="270" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="620" y="80" width="150" height="55" rx="10" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="695" y="105" text-anchor="middle" fill="white" font-size="12">Risk / Fraud Engine</text>
  <text x="695" y="122" text-anchor="middle" fill="white" font-size="10">(ML Real-time)</text>
  <rect x="620" y="165" width="150" height="55" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="695" y="188" text-anchor="middle" fill="white" font-size="12">Ledger Service</text>
  <text x="695" y="205" text-anchor="middle" fill="white" font-size="10">(Double-Entry)</text>
  <rect x="620" y="245" width="150" height="55" rx="10" fill="#6a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="695" y="268" text-anchor="middle" fill="white" font-size="12">Wallet Service</text>
  <text x="695" y="285" text-anchor="middle" fill="white" font-size="10">(Balance Mgmt)</text>
  <line x1="770" y1="192" x2="840" y2="192" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="850" y="165" width="150" height="55" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="925" y="188" text-anchor="middle" fill="white" font-size="12">PostgreSQL</text>
  <text x="925" y="205" text-anchor="middle" fill="white" font-size="10">(Ledger DB)</text>
  <line x1="770" y1="272" x2="840" y2="330" stroke="#aaa" marker-end="url(#ah1)"/>
  <rect x="850" y="305" width="150" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="925" y="328" text-anchor="middle" fill="white" font-size="12">Funding Source</text>
  <text x="925" y="345" text-anchor="middle" fill="white" font-size="10">(Bank/Card ACH)</text>
</svg>
</div>

<div class="section">
<h3>Step-by-Step</h3>
<ol>
  <li><strong>Client initiates:</strong> <code>POST /api/v2/payments/send</code> with <code>{ "recipient": "friend@email.com", "amount": 50.00, "currency": "USD", "idempotency_key": "uuid-abc123", "note": "Dinner split" }</code></li>
  <li><strong>API Gateway:</strong> Authenticates via OAuth2 token, checks <code>idempotency_key</code> in Redis ‚Äî if exists, return cached response (prevents duplicate payments on retry)</li>
  <li><strong>Payment Orchestrator:</strong> Creates a <code>payment_intent</code> record with status <code>initiated</code>. Resolves recipient (email ‚Üí PayPal account lookup)</li>
  <li><strong>Risk Engine (sync):</strong> Real-time fraud check ‚Äî evaluates sender device fingerprint, transaction velocity, amount anomaly, recipient risk profile. Returns: approve / deny / step-up-auth</li>
  <li><strong>Wallet Service:</strong> Determines funding source priority: (1) PayPal balance, (2) linked bank account (ACH), (3) linked card. If balance sufficient ‚Üí debit sender balance immediately</li>
  <li><strong>Ledger Service (atomic):</strong> Double-entry booking: <code>DEBIT sender_wallet $50.00</code> + <code>CREDIT receiver_wallet $50.00</code> in a single DB transaction. Payment status ‚Üí <code>completed</code></li>
  <li><strong>Notify recipient:</strong> Push notification + email ‚Äî "You received $50.00 from John"</li>
  <li><strong>Idempotency key cached:</strong> Store response in Redis with TTL 24hr keyed by idempotency_key</li>
</ol>

<div class="example">
<strong>Example:</strong> Alice sends $50 to Bob ‚Üí Risk Engine: score 0.02 (low risk, approved) ‚Üí Alice has $120 PayPal balance ‚Üí Debit Alice $50, Credit Bob $50 ‚Üí Ledger: two entries in same TX ‚Üí Bob sees $50 in balance instantly ‚Üí If Alice retries (network timeout), idempotency_key returns cached "success" ‚Äî no double charge
</div>
</div>

<div class="section">
<h3>üîç Component Deep Dives ‚Äî P2P Payment</h3>

<div class="subsection">
<h4>Double-Entry Ledger</h4>
<p><strong>Principle:</strong> Every financial movement creates exactly two entries ‚Äî a DEBIT and a CREDIT ‚Äî that sum to zero. This ensures money is never created or destroyed in the system.</p>
<pre>
-- Single atomic transaction
BEGIN;
INSERT INTO ledger_entries (account_id, amount, type, payment_id, created_at)
  VALUES ('alice_wallet', -50.00, 'DEBIT', 'pay_123', NOW());
INSERT INTO ledger_entries (account_id, amount, type, payment_id, created_at)
  VALUES ('bob_wallet', 50.00, 'CREDIT', 'pay_123', NOW());
UPDATE wallets SET balance = balance - 50.00 WHERE account_id = 'alice_wallet' AND balance >= 50.00;
UPDATE wallets SET balance = balance + 50.00 WHERE account_id = 'bob_wallet';
COMMIT;
</pre>
<p><strong>Key:</strong> The <code>WHERE balance >= 50.00</code> check prevents overdraft. If UPDATE affects 0 rows ‚Üí insufficient funds ‚Üí ROLLBACK entire TX.</p>
</div>

<div class="subsection">
<h4>Idempotency Implementation</h4>
<p><strong>Protocol:</strong> Client generates UUID v4 idempotency_key, sends in header <code>Idempotency-Key: uuid-abc123</code></p>
<p><strong>Storage:</strong> Redis <code>SET idempotency:{key} {response_json} EX 86400 NX</code> ‚Äî NX ensures only first request proceeds</p>
<p><strong>Flow:</strong> (1) Check Redis for key ‚Üí miss ‚Üí proceed with payment ‚Üí store result. (2) Check Redis ‚Üí hit ‚Üí return cached response immediately</p>
<p><strong>Edge case:</strong> If payment is in-flight (key exists but no response yet), return 409 Conflict telling client to retry after delay</p>
</div>

<div class="subsection">
<h4>Risk / Fraud Engine</h4>
<p><strong>Protocol:</strong> gRPC sync call from Payment Orchestrator (must complete in &lt;100ms)</p>
<p><strong>Features:</strong> Device fingerprint, IP geolocation, transaction velocity (count/sum in last hour), recipient risk score, historical pattern, time-of-day anomaly</p>
<p><strong>Decisions:</strong> APPROVE (score &lt; 0.3), STEP_UP_AUTH (0.3-0.7 ‚Üí require 2FA/SMS), DENY (score &gt; 0.7)</p>
<p><strong>Model:</strong> Gradient Boosted Trees (XGBoost) with ~500 features, retrained daily on labeled fraud data</p>
</div>
</div>

<!-- ============================================================ -->
<h2>üîÑ Flow 2 ‚Äî Merchant Checkout Payment</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1200 420" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ah2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="160" width="110" height="60" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="75" y="195" text-anchor="middle" fill="white" font-size="14">Buyer</text>
  <line x1="130" y1="190" x2="190" y2="190" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="200" y="160" width="130" height="60" rx="10" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="265" y="188" text-anchor="middle" fill="white" font-size="13">Merchant Site</text>
  <text x="265" y="205" text-anchor="middle" fill="white" font-size="10">(PayPal JS SDK)</text>
  <line x1="330" y1="190" x2="390" y2="190" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="400" y="160" width="140" height="60" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="470" y="185" text-anchor="middle" fill="white" font-size="12">Checkout Service</text>
  <text x="470" y="202" text-anchor="middle" fill="white" font-size="10">(Order Creation)</text>
  <line x1="540" y1="175" x2="610" y2="100" stroke="#aaa" marker-end="url(#ah2)"/>
  <line x1="540" y1="190" x2="610" y2="190" stroke="#aaa" marker-end="url(#ah2)"/>
  <line x1="540" y1="210" x2="610" y2="290" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="620" y="70" width="150" height="55" rx="10" fill="#6a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="695" y="93" text-anchor="middle" fill="white" font-size="12">Token Vault</text>
  <text x="695" y="110" text-anchor="middle" fill="white" font-size="10">(PCI ‚Äî Card Data)</text>
  <rect x="620" y="165" width="150" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="695" y="188" text-anchor="middle" fill="white" font-size="12">Payment Processor</text>
  <text x="695" y="205" text-anchor="middle" fill="white" font-size="10">(Card Networks)</text>
  <rect x="620" y="265" width="150" height="55" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="695" y="288" text-anchor="middle" fill="white" font-size="12">Ledger + Escrow</text>
  <text x="695" y="305" text-anchor="middle" fill="white" font-size="10">(Hold ‚Üí Capture)</text>
  <line x1="770" y1="192" x2="850" y2="130" stroke="#aaa" marker-end="url(#ah2)"/>
  <line x1="770" y1="192" x2="850" y2="250" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="860" y="100" width="150" height="55" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="935" y="123" text-anchor="middle" fill="white" font-size="12">Visa / Mastercard</text>
  <text x="935" y="140" text-anchor="middle" fill="white" font-size="10">(ISO 8583)</text>
  <rect x="860" y="225" width="150" height="55" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="935" y="248" text-anchor="middle" fill="white" font-size="12">ACH / Bank</text>
  <text x="935" y="265" text-anchor="middle" fill="white" font-size="10">(Wire Network)</text>
  <line x1="1010" y1="128" x2="1080" y2="180" stroke="#aaa" marker-end="url(#ah2)"/>
  <line x1="1010" y1="252" x2="1080" y2="195" stroke="#aaa" marker-end="url(#ah2)"/>
  <rect x="1080" y="165" width="100" height="50" rx="10" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="1130" y="195" text-anchor="middle" fill="white" font-size="12">Merchant</text>
</svg>
</div>

<div class="section">
<h3>Step-by-Step</h3>
<ol>
  <li><strong>Merchant creates order:</strong> <code>POST /v2/checkout/orders</code> with <code>{ "intent": "CAPTURE", "purchase_units": [{ "amount": { "currency_code": "USD", "value": "99.99" } }] }</code></li>
  <li><strong>Buyer approves:</strong> PayPal modal/redirect ‚Üí buyer logs in, selects funding source (balance, card, bank), confirms</li>
  <li><strong>Authorization:</strong> Payment Processor performs authorization ‚Äî for cards: sends ISO 8583 authorization request to card network ‚Üí issuing bank approves ‚Üí auth_code returned. Funds are held (not captured yet)</li>
  <li><strong>Merchant captures:</strong> <code>POST /v2/checkout/orders/{id}/capture</code> ‚Äî triggers actual fund movement</li>
  <li><strong>Capture execution:</strong> Card network capture message sent, or ACH debit initiated. Ledger records double-entry: DEBIT buyer ‚Üí CREDIT PayPal escrow ‚Üí CREDIT merchant (minus fees)</li>
  <li><strong>Settlement:</strong> Funds available in merchant's PayPal account. Merchant can withdraw to bank (1-3 business days for ACH)</li>
</ol>

<div class="example">
<strong>Example:</strong> Buyer on e-commerce site clicks "Pay with PayPal" for $99.99 order ‚Üí PayPal modal opens ‚Üí Buyer selects Visa card ‚Üí Authorization: Visa approves hold of $99.99 ‚Üí Merchant ships item ‚Üí Merchant calls Capture API ‚Üí PayPal captures $99.99 from Visa ‚Üí Ledger: buyer -$99.99, merchant +$97.10 (after 2.9% + $0.30 fee), PayPal revenue +$2.89
</div>
</div>

<div class="section">
<h3>üîç Component Deep Dives ‚Äî Checkout Payment</h3>

<div class="subsection">
<h4>Two-Phase Payment (Auth + Capture)</h4>
<p><strong>Why separate?</strong> Merchant may not want to charge until shipment. Authorization holds funds for 3-29 days (varies by card network). If merchant doesn't capture, auth expires and hold is released.</p>
<p><strong>Void:</strong> If order is cancelled before capture, send void request to release the hold immediately</p>
<p><strong>Partial Capture:</strong> Merchant can capture less than authorized amount (e.g., item out of stock ‚Üí partial shipment)</p>
</div>

<div class="subsection">
<h4>PCI-DSS Token Vault</h4>
<p><strong>Card data never touches PayPal application servers.</strong> Flow: buyer enters card in secure iframe (hosted field) ‚Üí card data sent directly to Token Vault (isolated PCI-certified environment) ‚Üí returns opaque token <code>tok_abc123</code> ‚Üí all subsequent API calls use token, not card numbers</p>
<p><strong>Encryption:</strong> AES-256-GCM at rest, HSM (Hardware Security Module) for key management. Card numbers stored encrypted with per-card unique DEK (Data Encryption Key), DEK encrypted with KEK (Key Encryption Key) in HSM</p>
</div>

<div class="subsection">
<h4>ISO 8583 ‚Äî Card Network Protocol</h4>
<p><strong>Protocol:</strong> Binary message format used by Visa/Mastercard networks over TCP/IP</p>
<p><strong>Message types:</strong> 0100 (Authorization Request), 0110 (Authorization Response), 0200 (Financial Request/Capture), 0400 (Reversal)</p>
<p><strong>Fields:</strong> PAN (Primary Account Number), expiry date, amount, currency code, merchant category code (MCC), terminal ID</p>
<p><strong>Response codes:</strong> 00 (Approved), 05 (Do Not Honor), 51 (Insufficient Funds), 54 (Expired Card)</p>
</div>
</div>

<!-- ============================================================ -->
<h2>üîÑ Flow 3 ‚Äî Refund Processing</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1000 320" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ah3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="130" width="120" height="60" rx="10" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="80" y="165" text-anchor="middle" fill="white" font-size="13">Merchant /</text>
  <text x="80" y="180" text-anchor="middle" fill="white" font-size="13">Buyer Dispute</text>
  <line x1="140" y1="160" x2="210" y2="160" stroke="#aaa" marker-end="url(#ah3)"/>
  <rect x="220" y="130" width="140" height="60" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="290" y="158" text-anchor="middle" fill="white" font-size="13">Refund Service</text>
  <text x="290" y="175" text-anchor="middle" fill="white" font-size="10">(Validation)</text>
  <line x1="360" y1="160" x2="430" y2="110" stroke="#aaa" marker-end="url(#ah3)"/>
  <line x1="360" y1="160" x2="430" y2="210" stroke="#aaa" marker-end="url(#ah3)"/>
  <rect x="440" y="85" width="150" height="55" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="515" y="108" text-anchor="middle" fill="white" font-size="12">Ledger (Reverse)</text>
  <text x="515" y="125" text-anchor="middle" fill="white" font-size="10">(Compensating TX)</text>
  <rect x="440" y="185" width="150" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="515" y="208" text-anchor="middle" fill="white" font-size="12">Payment Processor</text>
  <text x="515" y="225" text-anchor="middle" fill="white" font-size="10">(Reverse Charge)</text>
  <line x1="590" y1="112" x2="660" y2="160" stroke="#aaa" marker-end="url(#ah3)"/>
  <line x1="590" y1="212" x2="660" y2="165" stroke="#aaa" marker-end="url(#ah3)"/>
  <rect x="670" y="135" width="140" height="55" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="740" y="158" text-anchor="middle" fill="white" font-size="12">Notification</text>
  <text x="740" y="175" text-anchor="middle" fill="white" font-size="10">(Buyer + Merchant)</text>
</svg>
</div>

<div class="section">
<h3>Step-by-Step</h3>
<ol>
  <li><strong>Refund initiated:</strong> Merchant calls <code>POST /v2/payments/captures/{capture_id}/refund</code> with <code>{ "amount": { "value": "99.99", "currency_code": "USD" } }</code></li>
  <li><strong>Refund Service validates:</strong> Original payment exists, is captured, refund amount ‚â§ remaining capturable amount, refund window not expired (180 days)</li>
  <li><strong>Ledger reverse entries:</strong> Compensating transaction ‚Äî DEBIT merchant account, CREDIT buyer account. This doesn't delete original entries ‚Äî it creates new reversal entries for audit trail</li>
  <li><strong>Payment Processor:</strong> If funded by card ‚Üí send ISO 8583 reversal (0400) to card network ‚Üí issuing bank credits buyer's card (3-10 business days). If funded by balance ‚Üí instant credit to buyer PayPal balance</li>
  <li><strong>Notifications:</strong> Buyer gets email "Refund of $99.99 processed" + merchant gets confirmation</li>
</ol>

<div class="example">
<strong>Example:</strong> Buyer received wrong item ‚Üí Merchant issues full refund of $99.99 ‚Üí Ledger creates reverse entries: merchant -$99.99, buyer +$99.99. PayPal's fee ($2.89) is NOT refunded to merchant (PayPal keeps processing fee). Card network processes reversal ‚Üí buyer sees credit on Visa statement in 5-7 days.
</div>
</div>

<!-- ============================================================ -->
<h2>üèóÔ∏è Combined Architecture</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<svg viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="ahc" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#aaa"/></marker></defs>
  <rect x="20" y="80" width="130" height="50" rx="10" fill="#2d7a3a" stroke="#4aff4a" stroke-width="2"/>
  <text x="85" y="110" text-anchor="middle" fill="white" font-size="13">Buyer App</text>
  <rect x="20" y="150" width="130" height="50" rx="10" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="85" y="180" text-anchor="middle" fill="white" font-size="13">Merchant SDK</text>
  <line x1="150" y1="105" x2="230" y2="155" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="150" y1="175" x2="230" y2="160" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="240" y="130" width="140" height="60" rx="10" fill="#c97a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="310" y="158" text-anchor="middle" fill="white" font-size="13">API Gateway</text>
  <text x="310" y="175" text-anchor="middle" fill="white" font-size="10">(L7 LB + Auth)</text>
  <!-- Services -->
  <line x1="380" y1="145" x2="460" y2="80" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="380" y1="155" x2="460" y2="155" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="380" y1="165" x2="460" y2="230" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="380" y1="175" x2="460" y2="310" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="470" y="55" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="540" y="85" text-anchor="middle" fill="white" font-size="12">Payment Orchestrator</text>
  <rect x="470" y="130" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="540" y="160" text-anchor="middle" fill="white" font-size="12">Checkout Service</text>
  <rect x="470" y="210" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="540" y="240" text-anchor="middle" fill="white" font-size="12">Wallet Service</text>
  <rect x="470" y="290" width="140" height="50" rx="10" fill="#1a5a8a" stroke="#4a9eff" stroke-width="2"/>
  <text x="540" y="320" text-anchor="middle" fill="white" font-size="12">Refund Service</text>
  <!-- Middle Layer -->
  <line x1="610" y1="80" x2="700" y2="80" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="610" y1="155" x2="700" y2="155" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="610" y1="235" x2="700" y2="235" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="710" y="55" width="150" height="50" rx="10" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="785" y="85" text-anchor="middle" fill="white" font-size="12">Risk Engine (ML)</text>
  <rect x="710" y="130" width="150" height="50" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="785" y="160" text-anchor="middle" fill="white" font-size="12">Ledger Service</text>
  <rect x="710" y="210" width="150" height="50" rx="10" fill="#6a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="785" y="240" text-anchor="middle" fill="white" font-size="12">Token Vault (PCI)</text>
  <!-- Databases -->
  <line x1="860" y1="155" x2="940" y2="155" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="950" y="55" width="160" height="50" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="1030" y="85" text-anchor="middle" fill="white" font-size="11">PostgreSQL (Ledger)</text>
  <rect x="950" y="130" width="160" height="50" rx="10" fill="#5a3a1a" stroke="#c97a1a" stroke-width="2"/>
  <text x="1030" y="160" text-anchor="middle" fill="white" font-size="11">PostgreSQL (Accounts)</text>
  <rect x="950" y="210" width="160" height="50" rx="10" fill="#1a8a7a" stroke="#4afff0" stroke-width="2"/>
  <text x="1030" y="240" text-anchor="middle" fill="white" font-size="11">Redis (Idempotency)</text>
  <line x1="860" y1="80" x2="940" y2="80" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="860" y1="235" x2="940" y2="235" stroke="#aaa" marker-end="url(#ahc)"/>
  <!-- Kafka -->
  <rect x="470" y="400" width="140" height="50" rx="10" fill="#6a1a8a" stroke="#d94aff" stroke-width="2"/>
  <text x="540" y="430" text-anchor="middle" fill="white" font-size="12">Apache Kafka</text>
  <line x1="540" y1="340" x2="540" y2="395" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="610" y1="425" x2="700" y2="400" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="610" y1="425" x2="700" y2="455" stroke="#aaa" marker-end="url(#ahc)"/>
  <rect x="710" y="375" width="150" height="45" rx="8" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="785" y="402" text-anchor="middle" fill="white" font-size="11">Notification Service</text>
  <rect x="710" y="435" width="150" height="45" rx="8" fill="#8a4a1a" stroke="#ffa54a" stroke-width="2"/>
  <text x="785" y="462" text-anchor="middle" fill="white" font-size="11">Analytics / Reporting</text>
  <!-- External -->
  <rect x="950" y="375" width="160" height="50" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="1030" y="405" text-anchor="middle" fill="white" font-size="11">Card Networks (Visa/MC)</text>
  <rect x="950" y="440" width="160" height="50" rx="10" fill="#4a4a4a" stroke="#999" stroke-width="2"/>
  <text x="1030" y="470" text-anchor="middle" fill="white" font-size="11">ACH / Bank Network</text>
  <line x1="860" y1="235" x2="940" y2="400" stroke="#aaa" marker-end="url(#ahc)"/>
  <line x1="860" y1="235" x2="940" y2="465" stroke="#aaa" marker-end="url(#ahc)"/>
</svg>
</div>

<div class="example">
<strong>End-to-End Example:</strong> Buyer on merchant site clicks "Pay with PayPal" ‚Üí PayPal JS SDK opens checkout modal ‚Üí Buyer selects saved Visa ‚Üí Token Vault retrieves encrypted card ‚Üí Risk Engine approves (score 0.05) ‚Üí Auth request to Visa via ISO 8583 ‚Üí Approved ‚Üí Merchant captures payment ‚Üí Ledger: buyer debited, PayPal escrow, merchant credited (minus 2.9% + $0.30 fee) ‚Üí Kafka event ‚Üí Notification Service emails buyer receipt ‚Üí Analytics records transaction metrics
</div>

<!-- ============================================================ -->
<h2>üóÑÔ∏è Database Schema</h2>
<!-- ============================================================ -->

<div class="section">
<h3>PostgreSQL ‚Äî Ledger Database (ACID Critical)</h3>

<h4>accounts</h4>
<table>
<tr><th>Column</th><th>Type</th><th>Notes</th></tr>
<tr><td>id</td><td>UUID</td><td><span class="tag tag-pk">PK</span></td></tr>
<tr><td>user_id</td><td>UUID</td><td><span class="tag tag-fk">FK ‚Üí users</span><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>account_type</td><td>VARCHAR(20)</td><td>wallet / merchant / escrow / fee_revenue</td></tr>
<tr><td>currency</td><td>VARCHAR(3)</td><td>USD, EUR, GBP, etc.</td></tr>
<tr><td>balance</td><td>DECIMAL(19,4)</td><td>Current balance (denormalized from ledger sum)</td></tr>
<tr><td>available_balance</td><td>DECIMAL(19,4)</td><td>Balance minus holds/pending</td></tr>
<tr><td>status</td><td>VARCHAR(20)</td><td>active / frozen / closed</td></tr>
<tr><td>created_at</td><td>TIMESTAMPTZ</td><td></td></tr>
</table>

<h4>ledger_entries</h4>
<table>
<tr><th>Column</th><th>Type</th><th>Notes</th></tr>
<tr><td>id</td><td>BIGINT</td><td><span class="tag tag-pk">PK</span> (Snowflake ID ‚Äî time-ordered)</td></tr>
<tr><td>account_id</td><td>UUID</td><td><span class="tag tag-fk">FK ‚Üí accounts</span><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>payment_id</td><td>UUID</td><td><span class="tag tag-fk">FK ‚Üí payments</span><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>type</td><td>VARCHAR(10)</td><td>DEBIT / CREDIT</td></tr>
<tr><td>amount</td><td>DECIMAL(19,4)</td><td>Always positive; type indicates direction</td></tr>
<tr><td>currency</td><td>VARCHAR(3)</td><td></td></tr>
<tr><td>description</td><td>TEXT</td><td></td></tr>
<tr><td>created_at</td><td>TIMESTAMPTZ</td><td><span class="tag tag-idx">INDEX</span></td></tr>
</table>
<p><strong>Constraint:</strong> For any payment_id, SUM(CREDIT amounts) = SUM(DEBIT amounts). Enforced by application-level invariant + periodic reconciliation job.</p>

<h4>payments</h4>
<table>
<tr><th>Column</th><th>Type</th><th>Notes</th></tr>
<tr><td>id</td><td>UUID</td><td><span class="tag tag-pk">PK</span></td></tr>
<tr><td>idempotency_key</td><td>VARCHAR(64)</td><td><span class="tag tag-idx">UNIQUE INDEX</span></td></tr>
<tr><td>sender_account_id</td><td>UUID</td><td><span class="tag tag-fk">FK ‚Üí accounts</span></td></tr>
<tr><td>receiver_account_id</td><td>UUID</td><td><span class="tag tag-fk">FK ‚Üí accounts</span></td></tr>
<tr><td>amount</td><td>DECIMAL(19,4)</td><td></td></tr>
<tr><td>currency</td><td>VARCHAR(3)</td><td></td></tr>
<tr><td>fee_amount</td><td>DECIMAL(19,4)</td><td></td></tr>
<tr><td>payment_type</td><td>VARCHAR(20)</td><td>p2p / checkout / refund / withdrawal</td></tr>
<tr><td>status</td><td>VARCHAR(20)</td><td>initiated / authorized / captured / completed / failed / refunded</td></tr>
<tr><td>funding_source</td><td>VARCHAR(20)</td><td>balance / card / bank</td></tr>
<tr><td>risk_score</td><td>DECIMAL(5,4)</td><td></td></tr>
<tr><td>auth_code</td><td>VARCHAR(20)</td><td>From card network (if card funded)</td></tr>
<tr><td>created_at</td><td>TIMESTAMPTZ</td><td><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>updated_at</td><td>TIMESTAMPTZ</td><td></td></tr>
</table>

<h4>funding_sources</h4>
<table>
<tr><th>Column</th><th>Type</th><th>Notes</th></tr>
<tr><td>id</td><td>UUID</td><td><span class="tag tag-pk">PK</span></td></tr>
<tr><td>user_id</td><td>UUID</td><td><span class="tag tag-fk">FK ‚Üí users</span><span class="tag tag-idx">INDEX</span></td></tr>
<tr><td>type</td><td>VARCHAR(20)</td><td>card / bank_account</td></tr>
<tr><td>token</td><td>VARCHAR(64)</td><td>Reference to Token Vault (never raw card number)</td></tr>
<tr><td>last_four</td><td>VARCHAR(4)</td><td>Display purposes</td></tr>
<tr><td>brand</td><td>VARCHAR(20)</td><td>visa / mastercard / amex</td></tr>
<tr><td>expiry_month</td><td>SMALLINT</td><td></td></tr>
<tr><td>expiry_year</td><td>SMALLINT</td><td></td></tr>
<tr><td>is_default</td><td>BOOLEAN</td><td></td></tr>
<tr><td>status</td><td>VARCHAR(20)</td><td>active / expired / removed</td></tr>
<tr><td>created_at</td><td>TIMESTAMPTZ</td><td></td></tr>
</table>

<h3>Sharding Strategy</h3>
<p><strong>accounts + ledger_entries:</strong> Shard by <code>account_id</code> ‚Äî keeps all entries for an account on same shard. Cross-shard transactions (sender and receiver on different shards) handled by 2-Phase Commit or Saga pattern <span class="tag tag-shard">HASH SHARD</span></p>
<p><strong>payments:</strong> Shard by <code>payment_id</code> hash ‚Äî uniform distribution. Secondary index on sender/receiver for lookup <span class="tag tag-shard">HASH SHARD</span></p>

<h3>DECIMAL(19,4) for Money</h3>
<p><strong>NEVER use FLOAT for money.</strong> IEEE 754 floating point cannot represent 0.10 exactly (0.1000000000000000055511151231257827021181583404541015625). Use DECIMAL/NUMERIC with fixed precision. 19 digits allows values up to 999,999,999,999,999.9999 ‚Äî sufficient for any single transaction.</p>

<h3>Reconciliation</h3>
<p>Daily batch job sums all ledger_entries per account and compares to <code>accounts.balance</code>. Any discrepancy triggers an alert and investigation. This catches bugs in the double-entry system. Also reconciles PayPal's internal ledger against card network settlement files and bank statements.</p>
</div>

<!-- ============================================================ -->
<h2>üíæ Cache & CDN Deep Dive</h2>
<!-- ============================================================ -->

<div class="section">
<h3>Redis Caching Strategy</h3>
<table>
<tr><th>Cache</th><th>Key Pattern</th><th>TTL</th><th>Strategy</th></tr>
<tr><td>Idempotency</td><td><code>idemp:{key}</code></td><td>24 hr</td><td>Write-through (SET NX)</td></tr>
<tr><td>Rate Limits</td><td><code>rate:{user_id}:{endpoint}</code></td><td>1 min window</td><td>Sliding window counter</td></tr>
<tr><td>Session / Auth</td><td><code>session:{token}</code></td><td>30 min</td><td>Write-through</td></tr>
<tr><td>Exchange Rates</td><td><code>fx:{from}:{to}</code></td><td>5 min</td><td>Pull from rate provider</td></tr>
<tr><td>Account Balance</td><td><code>balance:{account_id}</code></td><td>None (invalidate on write)</td><td>Read-through, write-invalidate</td></tr>
</table>

<p><strong>‚ö†Ô∏è No caching of financial data for reads that affect decisions.</strong> Balance checks for payment processing ALWAYS read from PostgreSQL primary (not replica, not cache) to prevent stale-balance attacks. Cache is only for display purposes (e.g., showing balance on home screen).</p>

<h3>CDN Strategy</h3>
<p><strong>Static only:</strong> JS SDK, logos, marketing pages. API responses are NEVER cached on CDN ‚Äî all payment APIs require real-time auth and are user-specific.</p>
<p><strong>SDK caching:</strong> PayPal JS SDK (<code>paypal-js</code>) cached on CDN with versioned URLs. Merchants include <code>&lt;script src="https://www.paypal.com/sdk/js?client-id=..."&gt;</code></p>
</div>

<!-- ============================================================ -->
<h2>‚öñÔ∏è Scaling Considerations</h2>
<!-- ============================================================ -->

<div class="section">
<ul>
  <li><strong>Ledger DB scaling:</strong> Shard by account_id. Cross-shard P2P payments use Saga pattern with compensating transactions. Ledger is append-only (immutable entries), enabling high write throughput</li>
  <li><strong>Connection pooling:</strong> PgBouncer with transaction-mode pooling ‚Äî critical for high-concurrency payment processing</li>
  <li><strong>Geo-distributed:</strong> Multi-region deployment (US, EU, APAC) with regional PostgreSQL primaries. Cross-region payments routed to sender's region's primary</li>
  <li><strong>Rate limiting:</strong> Token bucket per user per endpoint. Strict limits on payment initiation (100/hour), lenient on balance checks (1000/hour)</li>
  <li><strong>Circuit breaker:</strong> Card network connections have circuit breakers ‚Äî if Visa is down, route to backup processor or fail gracefully with retry logic</li>
  <li><strong>Hot account problem:</strong> Popular merchants (e.g., Amazon's PayPal account) receive millions of credits/day ‚Üí row-level lock contention on balance UPDATE. Solution: sub-accounts ‚Äî split merchant balance into 100 sub-accounts, round-robin credits, aggregate balance for display</li>
</ul>
</div>

<!-- ============================================================ -->
<h2>‚öñÔ∏è Tradeoffs</h2>
<!-- ============================================================ -->

<div class="section">
<div class="tradeoff-grid">
  <div class="tradeoff-pro">
    <h4>‚úÖ Double-Entry Ledger</h4>
    <p>Complete audit trail, mathematical invariant (debits = credits), regulatory compliance, easy reconciliation</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå Double-Entry Ledger</h4>
    <p>2x write amplification (every transaction = 2+ rows), cross-shard transactions complex, harder to scale than event-sourcing</p>
  </div>
  <div class="tradeoff-pro">
    <h4>‚úÖ Idempotency Keys</h4>
    <p>Safe retries ‚Äî eliminates duplicate payment problem entirely, essential for unreliable networks</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå Idempotency Keys</h4>
    <p>Extra storage (Redis), client must generate unique keys, 24hr TTL means very late retries may create duplicates</p>
  </div>
  <div class="tradeoff-pro">
    <h4>‚úÖ Sync Risk Check</h4>
    <p>Blocks fraud before money moves ‚Äî prevents financial loss in real-time</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå Sync Risk Check</h4>
    <p>Adds latency to every payment (~50-100ms), single point of failure if risk engine is down (must have fallback policy)</p>
  </div>
  <div class="tradeoff-pro">
    <h4>‚úÖ Auth + Capture (Two-Phase)</h4>
    <p>Merchants only charge when they ship, reduces chargebacks, supports partial captures</p>
  </div>
  <div class="tradeoff-con">
    <h4>‚ùå Auth + Capture (Two-Phase)</h4>
    <p>Complexity in tracking auth expiry (29 days for Visa, 7 for MC), held funds unavailable to buyer, failed captures after auth expiry</p>
  </div>
</div>
</div>

<!-- ============================================================ -->
<h2>üîÑ Alternative Approaches</h2>
<!-- ============================================================ -->

<div class="section">
<div class="subsection">
<h4>Event Sourcing Instead of Double-Entry Ledger</h4>
<p>Store all financial events as immutable event stream (Kafka). Current balance derived by replaying events. Advantages: natural audit trail, easy to replay/debug, scales better horizontally. Disadvantage: calculating current balance requires reading full event history (mitigated by snapshots). Used by some modern fintech (e.g., Nubank).</p>
</div>
<div class="subsection">
<h4>CQRS for Transaction History</h4>
<p>Separate write model (ledger DB ‚Äî optimized for ACID writes) from read model (Elasticsearch or materialized views ‚Äî optimized for transaction history queries, search, filtering). Write path: PostgreSQL. Read path: CDC ‚Üí Elasticsearch with rich search capabilities (date range, amount range, merchant name search).</p>
</div>
<div class="subsection">
<h4>Blockchain / DLT for Settlement</h4>
<p>Use distributed ledger for cross-border settlements (like Ripple/XRP). Eliminates intermediary banks for international transfers, reduces settlement from days to seconds. Drawback: regulatory uncertainty, throughput limitations, energy cost for proof-of-work chains.</p>
</div>
</div>

<!-- ============================================================ -->
<h2>üìö Additional Information</h2>
<!-- ============================================================ -->

<div class="section">
<h3>Multi-Currency & FX</h3>
<p>PayPal supports 25+ currencies. When sender's currency differs from receiver's, FX conversion happens at PayPal's rate (which includes a ~3-4% markup over mid-market rate). Exchange rates cached in Redis (5-min TTL) from upstream FX providers. Rate locked at time of payment initiation for 10 minutes.</p>

<h3>Dispute Resolution (Chargebacks)</h3>
<p>Buyer Protection: buyers can open disputes within 180 days. Process: (1) Buyer opens case, (2) Merchant has 10 days to respond with evidence, (3) PayPal arbitrates. If merchant loses ‚Üí forced refund (chargeback). Merchant accounts with high chargeback rates get account restrictions or termination.</p>

<h3>ACH Processing</h3>
<p>Bank transfers via ACH (Automated Clearing House) are batch-processed. PayPal submits ACH files to the Federal Reserve in batches (multiple times/day). Settlement takes 1-3 business days. Provisional credit given to recipient immediately (PayPal takes the risk). ACH returns (insufficient funds) handled as negative balance on sender's account.</p>

<h3>Compliance & KYC</h3>
<p>Know Your Customer (KYC): users must verify identity for higher limits. Progressive KYC: basic account ($500/month limit) ‚Üí verified (SSN/ID check ‚Üí unlimited). Anti-Money Laundering (AML): suspicious transaction reporting to FinCEN. OFAC screening: every payment checked against sanctions list in real-time.</p>
</div>

</body>
</html>
