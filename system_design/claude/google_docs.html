<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Docs - System Design</title>
<style>
:root{--bg:#0f0f0f;--surface:#1a1a1a;--border:#2a2a2a;--text:#e0e0e0;--accent:#4285F4;--accent2:#EA4335;}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;line-height:1.7;padding:2rem;max-width:1400px;margin:0 auto}
h1{color:var(--accent);font-size:2.2rem;border-bottom:3px solid var(--accent);padding-bottom:.5rem;margin-bottom:1.5rem}
h2{color:var(--accent2);margin:2rem 0 1rem;font-size:1.5rem}
h3{color:#81D4FA;margin:1.5rem 0 .75rem}
h4{color:#CE93D8;margin:1rem 0 .5rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin:1rem 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1rem}
table{width:100%;border-collapse:collapse;margin:1rem 0}
th,td{border:1px solid var(--border);padding:.75rem;text-align:left;font-size:.95rem}
th{background:#1a3a5c;color:var(--accent)}
pre{background:#1e1e1e;padding:1rem;border-radius:8px;overflow-x:auto;margin:.5rem 0}
code{color:#89DDFF;font-size:.9rem}
svg text{font-family:'Segoe UI',system-ui,sans-serif}
.tradeoff-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.pro{border-left:4px solid #4CAF50;padding-left:1rem}
.con{border-left:4px solid #f44336;padding-left:1rem}
details{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;margin:.5rem 0}
summary{cursor:pointer;font-weight:600;color:var(--accent)}
.step{margin:.5rem 0;padding:.5rem 1rem;border-left:3px solid var(--accent2)}
.tag-pk{background:#E91E63;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
.tag-fk{background:#2196F3;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
.tag-idx{background:#FF9800;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
.tag-shard{background:#9C27B0;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
</style>
</head>
<body>

<h1>üìù Google Docs ‚Äî Real-Time Collaborative Document Editor</h1>
<p>Design a real-time collaborative document editing system where multiple users can simultaneously edit the same document with instant synchronization, conflict resolution, and full revision history.</p>

<h2>üìã Functional Requirements</h2>
<div class="card">
<ul>
<li><strong>Real-time collaboration</strong> ‚Äî multiple users edit simultaneously with cursors/selections visible to all</li>
<li><strong>Conflict resolution</strong> ‚Äî concurrent edits on same text resolved automatically without data loss</li>
<li><strong>Rich text editing</strong> ‚Äî bold, italic, headings, lists, tables, images, comments, suggestions</li>
<li><strong>Version history</strong> ‚Äî full revision history with ability to restore any previous version</li>
<li><strong>Offline editing</strong> ‚Äî edit without internet, sync changes when reconnected</li>
<li><strong>Sharing & permissions</strong> ‚Äî owner, editor, commenter, viewer roles with link sharing</li>
<li><strong>Comments & suggestions</strong> ‚Äî inline comments, suggested edits with accept/reject workflow</li>
</ul>
</div>

<h2>üìã Non-Functional Requirements</h2>
<div class="card">
<ul>
<li><strong>Latency</strong> ‚Äî edits visible to collaborators within 100-200ms</li>
<li><strong>Consistency</strong> ‚Äî all clients converge to same document state (strong eventual consistency)</li>
<li><strong>Scale</strong> ‚Äî billions of documents, up to 200 concurrent editors per document</li>
<li><strong>Durability</strong> ‚Äî zero data loss; every keystroke persisted</li>
<li><strong>Availability</strong> ‚Äî 99.99% uptime globally</li>
<li><strong>Storage efficiency</strong> ‚Äî billions of documents with full revision history stored compactly</li>
</ul>
</div>

<h2>üîÑ Flow 1: Real-Time Collaborative Editing (OT)</h2>
<svg viewBox="0 0 1050 340" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="a1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#4285F4"/></marker></defs>
<rect x="20" y="50" width="110" height="50" rx="8" fill="#2E7D32"/><text x="75" y="70" text-anchor="middle" fill="white" font-size="12">Client A</text><text x="75" y="85" text-anchor="middle" fill="white" font-size="10">(types "Hello")</text>
<rect x="20" y="160" width="110" height="50" rx="8" fill="#2E7D32"/><text x="75" y="180" text-anchor="middle" fill="white" font-size="12">Client B</text><text x="75" y="195" text-anchor="middle" fill="white" font-size="10">(types "World")</text>
<rect x="220" y="100" width="140" height="60" rx="8" fill="#6A1B9A"/><text x="290" y="125" text-anchor="middle" fill="white" font-size="12">WebSocket</text><text x="290" y="140" text-anchor="middle" fill="white" font-size="10">Connection</text>
<rect x="440" y="100" width="160" height="60" rx="8" fill="#1565C0"/><text x="520" y="120" text-anchor="middle" fill="white" font-size="12">Collaboration Server</text><text x="520" y="140" text-anchor="middle" fill="white" font-size="10">(OT Transform Engine)</text>
<rect x="680" y="70" width="140" height="50" rx="8" fill="#4E342E"/><text x="750" y="100" text-anchor="middle" fill="white" font-size="12">Document Store</text>
<rect x="680" y="160" width="140" height="50" rx="8" fill="#00695C"/><text x="750" y="180" text-anchor="middle" fill="white" font-size="12">Operation Log</text><text x="750" y="195" text-anchor="middle" fill="white" font-size="10">(append-only)</text>
<rect x="440" y="250" width="160" height="50" rx="8" fill="#E65100"/><text x="520" y="280" text-anchor="middle" fill="white" font-size="12">Presence Service</text>
<line x1="130" y1="75" x2="215" y2="115" stroke="#4285F4" stroke-width="2" marker-end="url(#a1)"/>
<line x1="130" y1="185" x2="215" y2="145" stroke="#34A853" stroke-width="2" marker-end="url(#a1)"/>
<line x1="360" y1="130" x2="435" y2="130" stroke="#4285F4" stroke-width="2" marker-end="url(#a1)"/>
<line x1="600" y1="115" x2="675" y2="95" stroke="#4285F4" stroke-width="2" marker-end="url(#a1)"/>
<line x1="600" y1="145" x2="675" y2="185" stroke="#FF9800" stroke-width="2" marker-end="url(#a1)"/>
<line x1="520" y1="160" x2="520" y2="245" stroke="#81D4FA" stroke-width="2" marker-end="url(#a1)"/>
<text x="420" y="95" fill="#aaa" font-size="10">ops stream</text>
<text x="640" y="90" fill="#aaa" font-size="10">persist snapshot</text>
<text x="640" y="175" fill="#aaa" font-size="10">append ops</text>
</svg>

<div class="step"><strong>Step 1:</strong> Clients A and B connect via WebSocket to Collaboration Server for the same document</div>
<div class="step"><strong>Step 2:</strong> Each keystroke generates an operation: {type: "insert", position: 5, chars: "H", revision: 42}</div>
<div class="step"><strong>Step 3:</strong> Server receives ops, applies OT (Operational Transformation) to resolve conflicts</div>
<div class="step"><strong>Step 4:</strong> Transformed ops broadcast to all other clients; each client applies transformed op locally</div>
<div class="step"><strong>Step 5:</strong> Operations appended to immutable Operation Log; document snapshot periodically saved</div>

<details><summary>Deep Dive: Operational Transformation (OT)</summary>
<div class="card">
<h4>How OT Resolves Concurrent Edits</h4>
<pre><code>// Problem: Client A inserts "X" at position 3
//          Client B deletes char at position 1
//          Both see initial document: "ABCDE"

// Without OT: applying both literally produces different results!
// Client A sees: "ABCXDE" ‚Üí delete pos 1 ‚Üí "BCXDE" ‚úó
// Client B sees: "ACDE"   ‚Üí insert X at 3 ‚Üí "ACDXE" ‚úó

// With OT: Transform(Op_A, Op_B) adjusts positions
// Op_A: insert("X", 3), Op_B: delete(1)
// Transform: since B deleted before A's insert position,
//   A' = insert("X", 2)  (position shifted left by 1)
//   B' = delete(1)        (unaffected by insert after it)
// Both converge to: "ACXDE" ‚úì

// OT Transform function (simplified):
function transform(op1, op2) {
  if (op1.type === 'insert' && op2.type === 'insert') {
    if (op1.pos < op2.pos || (op1.pos === op2.pos && op1.clientId < op2.clientId)) {
      return [op1, {...op2, pos: op2.pos + op1.chars.length}];
    } else {
      return [{...op1, pos: op1.pos + op2.chars.length}, op2];
    }
  }
  if (op1.type === 'insert' && op2.type === 'delete') {
    if (op1.pos <= op2.pos) {
      return [op1, {...op2, pos: op2.pos + op1.chars.length}];
    } else {
      return [{...op1, pos: op1.pos - 1}, op2];
    }
  }
  // ... handle all (insert, delete) √ó (insert, delete) combinations
}

// Google Docs uses centralized OT:
// Server is the single source of truth (total ordering)
// Server revision number prevents divergence
// Client buffers ops while awaiting server acknowledgment</code></pre>
</div>
</details>

<details><summary>Deep Dive: OT vs CRDT</summary>
<div class="card">
<table>
<tr><th>Aspect</th><th>OT (Google Docs)</th><th>CRDT (Yjs, Automerge)</th></tr>
<tr><td>Server requirement</td><td>Central server required</td><td>Peer-to-peer possible</td></tr>
<tr><td>Complexity</td><td>Transform functions are complex</td><td>Data structure is complex</td></tr>
<tr><td>Consistency</td><td>Server-ordered (total order)</td><td>Mathematically convergent</td></tr>
<tr><td>Offline</td><td>Buffer ops, sync on reconnect</td><td>Natively supports offline</td></tr>
<tr><td>Storage</td><td>Compact (ops are small)</td><td>Larger (metadata per character)</td></tr>
<tr><td>Proven scale</td><td>Google Docs (billions of docs)</td><td>Figma, newer systems</td></tr>
<tr><td>Latency</td><td>Server round-trip needed</td><td>Instant local apply</td></tr>
</table>
<pre><code>// CRDT example: Each character has a unique ID
// Insert "H" ‚Üí {id: "A:1", char: "H", after: "root"}
// Insert "i" ‚Üí {id: "A:2", char: "i", after: "A:1"}
// Concurrent insert by B after same position:
// Insert "X" ‚Üí {id: "B:1", char: "X", after: "root"}
// Resolution: compare IDs (deterministic ordering)
// Result: either "HXi" or "XHi" ‚Äî same on all clients

// Google chose OT because:
// 1. Proven at scale (20+ years)
// 2. Central server simplifies access control
// 3. Smaller on-wire format than CRDT metadata</code></pre>
</div>
</details>

<h2>üîÑ Flow 2: Document Sharing & Access Control</h2>
<svg viewBox="0 0 1000 280" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="a2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#EA4335"/></marker></defs>
<rect x="20" y="60" width="110" height="50" rx="8" fill="#2E7D32"/><text x="75" y="90" text-anchor="middle" fill="white" font-size="12">Owner</text>
<rect x="175" y="60" width="130" height="50" rx="8" fill="#1565C0"/><text x="240" y="80" text-anchor="middle" fill="white" font-size="12">Sharing Service</text>
<rect x="350" y="30" width="130" height="50" rx="8" fill="#4E342E"/><text x="415" y="60" text-anchor="middle" fill="white" font-size="12">ACL Store</text>
<rect x="350" y="100" width="130" height="50" rx="8" fill="#6A1B9A"/><text x="415" y="130" text-anchor="middle" fill="white" font-size="12">Link Token Service</text>
<rect x="550" y="60" width="130" height="50" rx="8" fill="#E65100"/><text x="615" y="80" text-anchor="middle" fill="white" font-size="12">Notification</text><text x="615" y="95" text-anchor="middle" fill="white" font-size="10">Service</text>
<rect x="730" y="60" width="120" height="50" rx="8" fill="#2E7D32"/><text x="790" y="90" text-anchor="middle" fill="white" font-size="12">Invitee</text>
<line x1="130" y1="85" x2="170" y2="85" stroke="#EA4335" stroke-width="2" marker-end="url(#a2)"/>
<line x1="305" y1="70" x2="345" y2="55" stroke="#EA4335" stroke-width="2" marker-end="url(#a2)"/>
<line x1="305" y1="100" x2="345" y2="125" stroke="#EA4335" stroke-width="2" marker-end="url(#a2)"/>
<line x1="480" y1="55" x2="545" y2="75" stroke="#EA4335" stroke-width="2" marker-end="url(#a2)"/>
<line x1="680" y1="85" x2="725" y2="85" stroke="#EA4335" stroke-width="2" marker-end="url(#a2)"/>
</svg>

<div class="step"><strong>Step 1:</strong> Owner shares document by entering email addresses or generating shareable link</div>
<div class="step"><strong>Step 2:</strong> Sharing Service creates ACL entries (user ‚Üí role mapping) and optional link tokens</div>
<div class="step"><strong>Step 3:</strong> Link sharing options: "Anyone with link" (viewer/commenter/editor) or restricted to specific users</div>
<div class="step"><strong>Step 4:</strong> On every document access, ACL checked: owner > editor > commenter > viewer</div>
<div class="step"><strong>Step 5:</strong> Notification Service sends email invite with direct link to document</div>

<h2>üîÑ Flow 3: Version History & Restore</h2>
<svg viewBox="0 0 1000 260" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="a3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#34A853"/></marker></defs>
<rect x="20" y="60" width="110" height="50" rx="8" fill="#2E7D32"/><text x="75" y="90" text-anchor="middle" fill="white" font-size="12">User</text>
<rect x="175" y="60" width="130" height="50" rx="8" fill="#1565C0"/><text x="240" y="80" text-anchor="middle" fill="white" font-size="12">Version Service</text>
<rect x="350" y="30" width="140" height="50" rx="8" fill="#4E342E"/><text x="420" y="50" text-anchor="middle" fill="white" font-size="12">Operation Log</text><text x="420" y="65" text-anchor="middle" fill="white" font-size="10">(all edits since creation)</text>
<rect x="350" y="100" width="140" height="50" rx="8" fill="#00695C"/><text x="420" y="120" text-anchor="middle" fill="white" font-size="12">Snapshot Store</text><text x="420" y="135" text-anchor="middle" fill="white" font-size="10">(periodic checkpoints)</text>
<rect x="550" y="60" width="130" height="50" rx="8" fill="#6A1B9A"/><text x="615" y="80" text-anchor="middle" fill="white" font-size="12">Diff Engine</text><text x="615" y="95" text-anchor="middle" fill="white" font-size="10">(visual diff)</text>
<line x1="130" y1="85" x2="170" y2="85" stroke="#34A853" stroke-width="2" marker-end="url(#a3)"/>
<line x1="305" y1="70" x2="345" y2="55" stroke="#34A853" stroke-width="2" marker-end="url(#a3)"/>
<line x1="305" y1="100" x2="345" y2="125" stroke="#34A853" stroke-width="2" marker-end="url(#a3)"/>
<line x1="490" y1="80" x2="545" y2="80" stroke="#34A853" stroke-width="2" marker-end="url(#a3)"/>
</svg>

<div class="step"><strong>Step 1:</strong> User opens version history panel. Version Service retrieves revision timeline</div>
<div class="step"><strong>Step 2:</strong> For any point in time: load nearest snapshot + replay ops from Operation Log to reconstruct document</div>
<div class="step"><strong>Step 3:</strong> Diff Engine highlights changes between versions with color-coded per-author annotations</div>
<div class="step"><strong>Step 4:</strong> "Named versions" let users bookmark important states. Auto-grouping: batch edits within session into one revision</div>
<div class="step"><strong>Step 5:</strong> Restore creates new version (non-destructive) ‚Äî old history preserved</div>

<details><summary>Deep Dive: Operation Log & Snapshot Strategy</summary>
<div class="card">
<pre><code>// Storing every keystroke for billions of documents:
// Operation Log: append-only, immutable, compressed

// Storage optimization:
// 1. Operation compaction: merge sequential inserts by same user
//    "H" + "e" + "l" + "l" + "o" ‚Üí insert("Hello", pos: 0)
// 2. Periodic snapshots: full document state every N ops (e.g., 1000)
// 3. To reconstruct any version: find nearest snapshot, replay remaining ops

// Snapshot strategy:
// - Every 1000 operations OR every 30 minutes (whichever first)
// - Snapshot stored as compressed JSON/protobuf
// - Old snapshots: keep every 1000th, discard intermediate
// - Result: O(1) storage per time period, not O(edits)

// Example timeline:
// t=0:    Snapshot S0 (empty doc)
// t=1-999: Operations O1...O999
// t=1000:  Snapshot S1 (current state)
// t=1001-1999: Operations O1001...O1999
// t=2000:  Snapshot S2

// To reconstruct version at t=1500:
// Load S1, replay O1001...O1500 ‚Üí document at t=1500
// Max 999 ops to replay (fast reconstruction)

// Garbage collection: after 30 days, compact ops into fewer snapshots
// Legal hold: some orgs require full edit history for compliance</code></pre>
</div>
</details>

<h2>üèóÔ∏è Combined Architecture</h2>
<svg viewBox="0 0 1100 520" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="ac" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#4285F4"/></marker></defs>
<text x="550" y="25" text-anchor="middle" fill="#4285F4" font-size="16" font-weight="bold">Google Docs Architecture</text>
<rect x="20" y="50" width="120" height="40" rx="8" fill="#2E7D32"/><text x="80" y="75" text-anchor="middle" fill="white" font-size="11">Web / Mobile Clients</text>
<rect x="200" y="50" width="130" height="40" rx="8" fill="#6A1B9A"/><text x="265" y="75" text-anchor="middle" fill="white" font-size="11">WebSocket Gateway</text>
<rect x="400" y="40" width="140" height="35" rx="8" fill="#1565C0"/><text x="470" y="63" text-anchor="middle" fill="white" font-size="11">Collaboration Server (OT)</text>
<rect x="400" y="85" width="140" height="35" rx="8" fill="#1565C0"/><text x="470" y="108" text-anchor="middle" fill="white" font-size="11">Document Service</text>
<rect x="400" y="130" width="140" height="35" rx="8" fill="#1565C0"/><text x="470" y="153" text-anchor="middle" fill="white" font-size="11">Version Service</text>
<rect x="400" y="175" width="140" height="35" rx="8" fill="#1565C0"/><text x="470" y="198" text-anchor="middle" fill="white" font-size="11">Sharing / ACL Service</text>
<rect x="400" y="220" width="140" height="35" rx="8" fill="#1565C0"/><text x="470" y="243" text-anchor="middle" fill="white" font-size="11">Presence Service</text>
<rect x="400" y="265" width="140" height="35" rx="8" fill="#1565C0"/><text x="470" y="288" text-anchor="middle" fill="white" font-size="11">Comment Service</text>
<rect x="620" y="50" width="140" height="40" rx="8" fill="#4E342E"/><text x="690" y="75" text-anchor="middle" fill="white" font-size="11">Spanner (Metadata)</text>
<rect x="620" y="110" width="140" height="40" rx="8" fill="#4E342E"/><text x="690" y="135" text-anchor="middle" fill="white" font-size="11">Colossus (Operation Log)</text>
<rect x="620" y="170" width="140" height="40" rx="8" fill="#00695C"/><text x="690" y="195" text-anchor="middle" fill="white" font-size="11">Bigtable (Snapshots)</text>
<rect x="620" y="230" width="140" height="40" rx="8" fill="#00695C"/><text x="690" y="255" text-anchor="middle" fill="white" font-size="11">Redis (Presence Cache)</text>
<rect x="620" y="290" width="140" height="40" rx="8" fill="#6A1B9A"/><text x="690" y="315" text-anchor="middle" fill="white" font-size="11">Pub/Sub (Real-Time)</text>
<rect x="850" y="50" width="140" height="40" rx="8" fill="#607D8B"/><text x="920" y="75" text-anchor="middle" fill="white" font-size="11">Google Drive (Storage)</text>
<rect x="850" y="110" width="140" height="40" rx="8" fill="#6A1B9A"/><text x="920" y="135" text-anchor="middle" fill="white" font-size="11">Search Indexer</text>
<rect x="850" y="170" width="140" height="40" rx="8" fill="#E65100"/><text x="920" y="195" text-anchor="middle" fill="white" font-size="11">Export Service (PDF/DOCX)</text>
<line x1="140" y1="70" x2="195" y2="70" stroke="#4285F4" stroke-width="2" marker-end="url(#ac)"/>
<line x1="330" y1="70" x2="395" y2="57" stroke="#4285F4" stroke-width="2" marker-end="url(#ac)"/>
<line x1="540" y1="57" x2="615" y2="70" stroke="#4285F4" stroke-width="2" marker-end="url(#ac)"/>
<line x1="540" y1="102" x2="615" y2="130" stroke="#4285F4" stroke-width="2" marker-end="url(#ac)"/>
<line x1="540" y1="147" x2="615" y2="130" stroke="#FF9800" stroke-width="2" marker-end="url(#ac)"/>
<line x1="540" y1="192" x2="615" y2="70" stroke="#81D4FA" stroke-width="2" marker-end="url(#ac)"/>
<line x1="540" y1="237" x2="615" y2="255" stroke="#81D4FA" stroke-width="2" marker-end="url(#ac)"/>
<line x1="760" y1="70" x2="845" y2="70" stroke="#FF9800" stroke-width="2" marker-end="url(#ac)"/>
<line x1="760" y1="130" x2="845" y2="130" stroke="#FF9800" stroke-width="2" marker-end="url(#ac)"/>
<line x1="760" y1="195" x2="845" y2="195" stroke="#FF9800" stroke-width="2" marker-end="url(#ac)"/>
</svg>

<h2>üíæ Database Schema</h2>
<div class="grid">
<div class="card">
<h3>Spanner ‚Äî Document Metadata</h3>
<pre><code>CREATE TABLE documents (
  doc_id STRING(36) NOT NULL, -- <span class="tag-pk">PK</span>
  title STRING(500),
  owner_id STRING(36) NOT NULL, -- <span class="tag-idx">IDX</span>
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  current_revision INT64 NOT NULL DEFAULT 0,
  last_snapshot_revision INT64,
  is_deleted BOOL DEFAULT false,
  storage_bucket STRING(50)
) PRIMARY KEY (doc_id);

CREATE TABLE document_acl (
  doc_id STRING(36) NOT NULL, -- <span class="tag-fk">FK</span>
  principal_id STRING(100) NOT NULL, -- user email or group
  role STRING(20) NOT NULL, -- 'owner'|'editor'|'commenter'|'viewer'
  granted_by STRING(36),
  granted_at TIMESTAMP,
) PRIMARY KEY (doc_id, principal_id),
  INTERLEAVE IN PARENT documents ON DELETE CASCADE;

CREATE TABLE document_links (
  doc_id STRING(36) NOT NULL,
  link_token STRING(64) NOT NULL, -- <span class="tag-pk">PK</span>
  access_level STRING(20) NOT NULL,
  expires_at TIMESTAMP,
) PRIMARY KEY (link_token);
-- <span class="tag-idx">IDX</span>: (doc_id) for listing links per doc</code></pre>
</div>
<div class="card">
<h3>Bigtable ‚Äî Operations & Snapshots</h3>
<pre><code>// Operation Log (append-only, per document)
Row Key: {doc_id}#{revision_number (zero-padded)}
Column Family "op": {
  "type": "insert" | "delete" | "format",
  "position": 1234,
  "content": "Hello",
  "author_id": "user_abc",
  "timestamp": 1707500000000,
  "client_revision": 41
}

// Example rows for doc "doc_123":
// doc_123#000000001 ‚Üí insert("H", 0, user_a)
// doc_123#000000002 ‚Üí insert("i", 1, user_a)
// doc_123#000000003 ‚Üí insert("!", 0, user_b)
// doc_123#000000004 ‚Üí delete(2, 1, user_a)

// Snapshots (periodic checkpoints)
Row Key: {doc_id}#snapshot#{revision_number}
Column Family "state": {
  "content": compressed_document_json,
  "revision": 1000,
  "timestamp": 1707400000000,
  "size_bytes": 45230
}

// Efficient range scan: get ops 1001-1500 for doc_123
// Scan: start="doc_123#000001001", end="doc_123#000001500"
// Bigtable is perfect: sorted by row key, fast range scans</code></pre>
</div>
</div>

<h2>‚ö° Cache & CDN Deep Dive</h2>
<div class="card">
<table>
<tr><th>Layer</th><th>What</th><th>Strategy</th><th>TTL</th></tr>
<tr><td>Client Memory</td><td>Current document state + pending ops</td><td>In-memory, updated via WebSocket</td><td>Until tab closed</td></tr>
<tr><td>Redis ‚Äî Presence</td><td>Active cursors, selections, online users</td><td>Pub/Sub + ephemeral keys</td><td>30s heartbeat TTL</td></tr>
<tr><td>Redis ‚Äî Doc Cache</td><td>Hot document snapshots</td><td>LRU, write-through on snapshot</td><td>1 hour</td></tr>
<tr><td>Memcache ‚Äî ACL</td><td>Permission lookups</td><td>Write-through, invalidate on share change</td><td>5 minutes</td></tr>
<tr><td>CDN</td><td>Static editor JS/CSS, fonts, images</td><td>Immutable versioned URLs</td><td>1 year</td></tr>
</table>
<h4>WebSocket Connection Management</h4>
<pre><code>// Each document session maintains WebSocket to Collaboration Server
// Connection protocol:
// 1. Client connects with doc_id + auth token
// 2. Server sends current document state (or last known revision)
// 3. Bidirectional op streaming begins

// Presence protocol (lightweight):
// Client sends cursor position every 50ms (throttled)
// Server fans out to all other clients via Pub/Sub
// Presence data NOT persisted (ephemeral Redis keys with 30s TTL)
// Heartbeat: client pings every 10s, server removes on timeout

// Reconnection: client stores last confirmed revision
// On reconnect: request ops since last_revision
// If gap > threshold: full document re-fetch</code></pre>
</div>

<h2>üìà Scaling Considerations</h2>
<div class="card">
<ul>
<li><strong>Document partitioning:</strong> each document assigned to one Collaboration Server instance (consistent hashing on doc_id). All ops for a doc processed by single server (avoids distributed OT). If server dies, another takes over from operation log.</li>
<li><strong>Hot documents:</strong> a viral document with 200 editors generates 1000s of ops/sec. Solution: batch ops into micro-batches (every 50ms), transform batch together. Presence updates throttled to 5Hz.</li>
<li><strong>WebSocket scaling:</strong> each server holds ~100K WebSocket connections. Horizontally scale connection servers. Pub/Sub (Google Cloud Pub/Sub) fans out ops to all connection servers for a document.</li>
<li><strong>Storage:</strong> billions of documents √ó full revision history. Compression: ops are small (avg ~50 bytes). Snapshots compressed with zstd. Cold documents (not edited in 30 days): compact ops ‚Üí single snapshot.</li>
</ul>
</div>

<h2>‚öñÔ∏è Tradeoffs</h2>
<div class="tradeoff-grid">
<div class="card pro"><h4>Centralized OT (Server-Ordered)</h4><ul><li>Strong consistency guarantee</li><li>Simpler client implementation</li><li>Server controls access + ordering</li></ul></div>
<div class="card con"><h4>Centralized OT (Server-Ordered)</h4><ul><li>Server is bottleneck per document</li><li>Network latency on every edit</li><li>Complex transform function maintenance</li></ul></div>
<div class="card pro"><h4>Append-Only Operation Log</h4><ul><li>Perfect audit trail (every edit preserved)</li><li>Easy version reconstruction</li><li>Natural event sourcing pattern</li></ul></div>
<div class="card con"><h4>Append-Only Operation Log</h4><ul><li>Grows unboundedly without compaction</li><li>Reconstruction from ops is slow without snapshots</li><li>Storage cost for rarely-accessed docs</li></ul></div>
</div>

<h2>üîÑ Alternative Approaches</h2>
<div class="grid">
<div class="card"><h4>CRDT-Based (Yjs / Automerge)</h4><p>CRDTs (Conflict-free Replicated Data Types) mathematically guarantee convergence without a central server. Each character has a unique ID and position in a partial order. Better for offline-first (Figma uses CRDTs). Trade-off: higher metadata overhead per character (~2-4x storage).</p></div>
<div class="card"><h4>Differential Sync (Neil Fraser)</h4><p>Periodically diff client state vs server state (using Myers diff algorithm). Simpler than OT but less granular ‚Äî batches changes between sync cycles. Used by earlier collaborative tools. Not suitable for real-time character-by-character sync.</p></div>
</div>

<h2>üìö Additional Information</h2>
<div class="card">
<ul>
<li><strong>Jupiter protocol:</strong> Google's internal OT implementation (used in Docs). Uses a state-space graph where each axis represents one client's operations. Traversal from any point to any other always produces the same result (convergence proof).</li>
<li><strong>Rich text as operations:</strong> formatting is also an operation: format(range: [5,10], bold: true). OT must transform formatting ops against insert/delete ops (e.g., if text inserted within formatted range, extend format range).</li>
<li><strong>Offline editing:</strong> client queues ops locally (IndexedDB). On reconnect, sends all buffered ops. Server transforms against any concurrent ops that arrived from other clients. Can result in surprising merges for long offline periods.</li>
<li><strong>Smart Compose / AI:</strong> predictive text suggestions while typing (using LLM). Suggestions are "phantom ops" ‚Äî not committed until user accepts. Must not interfere with OT stream from other collaborators.</li>
</ul>
</div>

</body>
</html>
