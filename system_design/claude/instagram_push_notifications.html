<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Design: Instagram Push Notifications</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5;color:#333}
  .container{max-width:1200px;margin:0 auto;background:#fff;padding:40px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  h1{color:#1a73e8;border-bottom:3px solid #1a73e8;padding-bottom:10px}h2{color:#2c3e50;margin-top:40px;border-left:4px solid #1a73e8;padding-left:12px}h3{color:#34495e}h4{color:#555}
  .diagram{background:#fafafa;border:1px solid #ddd;border-radius:8px;padding:20px;margin:20px 0;overflow-x:auto}
  .example{background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:15px 0;border-radius:4px}
  .deep-dive{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin:15px 0;border-radius:4px}
  .tradeoff{background:#fff3e0;border-left:4px solid #ff9800;padding:15px;margin:15px 0;border-radius:4px}
  .alternative{background:#fce4ec;border-left:4px solid #e91e63;padding:15px;margin:15px 0;border-radius:4px}
  table{border-collapse:collapse;width:100%;margin:15px 0}th,td{border:1px solid #ddd;padding:10px 14px;text-align:left}th{background:#1a73e8;color:#fff}tr:nth-child(even){background:#f9f9f9}
  code{background:#f0f0f0;padding:2px 6px;border-radius:3px;font-size:.9em}
  .tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.85em;margin:2px}.tag-pk{background:#ffeb3b;color:#333}.tag-fk{background:#ce93d8;color:#333}.tag-idx{background:#80cbc4;color:#333}
  ul,ol{line-height:1.8}svg text{font-family:'Segoe UI',Arial,sans-serif}
</style>
</head>
<body>
<div class="container">
<h1>System Design: Instagram Push Notifications</h1>

<h2>Functional Requirements</h2>
<ol>
  <li><strong>Push notifications to mobile devices</strong> – Deliver push notifications for likes, comments, follows, mentions, DMs, live videos, and stories to iOS (APNs) and Android (FCM) devices.</li>
  <li><strong>Notification preferences</strong> – Users can enable/disable specific notification types (e.g., turn off like notifications but keep comment notifications).</li>
  <li><strong>Rate limiting/throttling</strong> – Don't overwhelm users with too many notifications in a short period; batch or suppress excess notifications.</li>
  <li><strong>Rich notifications</strong> – Include thumbnail images, action buttons (like, reply), and deep links in the notification payload.</li>
  <li><strong>Multi-device support</strong> – Users logged into multiple devices receive notifications on all devices.</li>
  <li><strong>Quiet hours</strong> – Respect user-configured do-not-disturb schedules.</li>
</ol>

<h2>Non-Functional Requirements</h2>
<ol>
  <li><strong>Low latency</strong> – Push notifications delivered within 1-3 seconds of the triggering event.</li>
  <li><strong>High throughput</strong> – Handle billions of push notifications per day.</li>
  <li><strong>Reliability</strong> – At-least-once delivery to the push notification provider (APNs/FCM).</li>
  <li><strong>Scalability</strong> – Scale horizontally to handle viral events (celebrity posts generating millions of likes).</li>
</ol>

<!-- ==================== FLOW 1: SENDING PUSH NOTIFICATION ==================== -->
<h2>Flow 1: Sending a Push Notification</h2>
<div class="diagram">
<svg viewBox="0 0 1150 420" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="a1" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M0 0L10 5L0 10z" fill="#333"/></marker></defs>
  <!-- Trigger Services -->
  <rect x="10" y="120" width="95" height="40" rx="6" fill="#2196f3" stroke="#1565c0" stroke-width="1.5"/>
  <text x="57" y="144" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Like Svc</text>
  <rect x="10" y="170" width="95" height="40" rx="6" fill="#2196f3" stroke="#1565c0" stroke-width="1.5"/>
  <text x="57" y="194" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Comment Svc</text>
  <rect x="10" y="220" width="95" height="40" rx="6" fill="#2196f3" stroke="#1565c0" stroke-width="1.5"/>
  <text x="57" y="244" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Follow Svc</text>
  <!-- Arrows to Kafka -->
  <line x1="105" y1="140" x2="180" y2="190" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <line x1="105" y1="190" x2="180" y2="190" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <line x1="105" y1="240" x2="180" y2="195" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <!-- Kafka -->
  <rect x="180" y="168" width="110" height="50" rx="8" fill="#9c27b0" stroke="#6a1b9a" stroke-width="2"/>
  <text x="235" y="197" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">Event Queue</text>
  <!-- Push Notification Service -->
  <line x1="290" y1="192" x2="370" y2="192" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <rect x="370" y="160" width="130" height="65" rx="8" fill="#e91e63" stroke="#ad1457" stroke-width="2"/>
  <text x="435" y="187" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">Push Notif</text>
  <text x="435" y="202" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">Service</text>
  <!-- Preference Check -->
  <line x1="435" y1="160" x2="435" y2="80" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="380" y="30" width="110" height="50" rx="8" fill="#673ab7" stroke="#4527a0" stroke-width="2"/>
  <text x="435" y="53" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Preference</text>
  <text x="435" y="68" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Service</text>
  <!-- Preference DB -->
  <line x1="490" y1="55" x2="560" y2="55" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <ellipse cx="610" cy="48" rx="40" ry="10" fill="#ff5722" stroke="#d84315" stroke-width="1.5"/>
  <rect x="570" y="48" width="80" height="22" fill="#ff5722" stroke="#d84315" stroke-width="1.5"/>
  <ellipse cx="610" cy="70" rx="40" ry="10" fill="#e64a19" stroke="#d84315" stroke-width="1.5"/>
  <line x1="570" y1="48" x2="570" y2="70" stroke="#d84315" stroke-width="1.5"/>
  <line x1="650" y1="48" x2="650" y2="70" stroke="#d84315" stroke-width="1.5"/>
  <text x="610" y="63" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Pref DB</text>
  <!-- Rate Limiter -->
  <line x1="435" y1="225" x2="435" y2="290" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="380" y="290" width="110" height="45" rx="8" fill="#00bcd4" stroke="#00838f" stroke-width="2"/>
  <text x="435" y="317" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">Rate Limiter</text>
  <!-- Rate Limiter to Redis -->
  <line x1="490" y1="312" x2="560" y2="312" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <ellipse cx="610" cy="305" rx="40" ry="10" fill="#009688" stroke="#00695c" stroke-width="1.5"/>
  <rect x="570" y="305" width="80" height="22" fill="#009688" stroke="#00695c" stroke-width="1.5"/>
  <ellipse cx="610" cy="327" rx="40" ry="10" fill="#00796b" stroke="#00695c" stroke-width="1.5"/>
  <line x1="570" y1="305" x2="570" y2="327" stroke="#00695c" stroke-width="1.5"/>
  <line x1="650" y1="305" x2="650" y2="327" stroke="#00695c" stroke-width="1.5"/>
  <text x="610" y="320" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Redis</text>
  <!-- Device Token Store -->
  <line x1="500" y1="185" x2="580" y2="155" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <ellipse cx="630" cy="142" rx="45" ry="10" fill="#ff5722" stroke="#d84315" stroke-width="1.5"/>
  <rect x="585" y="142" width="90" height="25" fill="#ff5722" stroke="#d84315" stroke-width="1.5"/>
  <ellipse cx="630" cy="167" rx="45" ry="10" fill="#e64a19" stroke="#d84315" stroke-width="1.5"/>
  <line x1="585" y1="142" x2="585" y2="167" stroke="#d84315" stroke-width="1.5"/>
  <line x1="675" y1="142" x2="675" y2="167" stroke="#d84315" stroke-width="1.5"/>
  <text x="630" y="159" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Device Tokens</text>
  <!-- Send Queue -->
  <line x1="500" y1="200" x2="580" y2="220" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <rect x="580" y="200" width="110" height="45" rx="8" fill="#9c27b0" stroke="#6a1b9a" stroke-width="2"/>
  <text x="635" y="222" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Send Queue</text>
  <!-- Workers -->
  <line x1="690" y1="222" x2="770" y2="222" stroke="#333" stroke-width="2" marker-end="url(#a1)"/>
  <rect x="770" y="190" width="100" height="55" rx="8" fill="#ff9800" stroke="#f57c00" stroke-width="2"/>
  <text x="820" y="215" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Push</text>
  <text x="820" y="230" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Workers</text>
  <!-- To APNs -->
  <line x1="870" y1="205" x2="950" y2="175" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="950" y="155" width="80" height="40" rx="6" fill="#607d8b" stroke="#37474f" stroke-width="1.5"/>
  <text x="990" y="179" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">APNs</text>
  <!-- To FCM -->
  <line x1="870" y1="230" x2="950" y2="255" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="950" y="240" width="80" height="40" rx="6" fill="#607d8b" stroke="#37474f" stroke-width="1.5"/>
  <text x="990" y="264" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">FCM</text>
  <!-- Devices -->
  <line x1="1030" y1="175" x2="1080" y2="175" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="1080" y="155" width="50" height="40" rx="6" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="1105" y="179" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">iOS</text>
  <line x1="1030" y1="260" x2="1080" y2="260" stroke="#333" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="1080" y="240" width="50" height="40" rx="6" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="1105" y="264" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Andro</text>
</svg>
</div>

<div class="example">
<h4>Example 1: Normal push notification</h4>
<p>Bob likes Alice's photo. The Like Service publishes a <code>{event: POST_LIKED, actor: bob, target: alice, post_id: 123}</code> event to the <strong>Event Queue</strong> (Kafka). The <strong>Push Notification Service</strong> consumes the event and: (1) Calls the <strong>Preference Service</strong> to check if Alice has like notifications enabled — yes. (2) Checks the <strong>Rate Limiter</strong> (Redis sliding window: max 50 push notifs/hour per user) — Alice has received 12 this hour, under the limit. (3) Fetches Alice's device tokens from the <strong>Device Token Store</strong> — Alice has 2 devices (iPhone, iPad). (4) Constructs the notification payload: <code>{title: "Instagram", body: "bob liked your photo", image: thumbnail_url, deep_link: "instagram://post/123"}</code>. (5) Enqueues two messages (one per device) to the <strong>Send Queue</strong>. <strong>Push Workers</strong> dequeue and send to <strong>APNs</strong> via HTTP/2 for both iOS devices. Alice sees a push notification on both devices.</p>
</div>

<div class="example">
<h4>Example 2: Notification suppressed (user preference)</h4>
<p>Carol tags Alice in a story. The Push Notification Service checks Preference Service — Alice has disabled "Tags" notifications. The notification is dropped. No push is sent, but the notification still appears in Alice's in-app notification feed (handled by the Notification Feed system).</p>
</div>

<div class="example">
<h4>Example 3: Rate limited</h4>
<p>A celebrity posts a photo and gets 10,000 likes in 1 minute. The celebrity would normally get 10,000 push notifications. The Rate Limiter detects the burst: after the first 50 in the hour, subsequent individual like notifications are suppressed. Instead, a summary notification is sent after a cooldown: "10,423 people liked your photo." This is achieved by aggregating suppressed events and sending a batch notification every 5 minutes when the rate limit is exceeded.</p>
</div>

<h3>Deep Dive: Flow 1 Components</h3>

<div class="deep-dive">
<h4>Push Notification Service</h4>
<p>Core orchestrator that processes notification events. Steps: validate event → check preferences → apply rate limiting → resolve device tokens → construct payload → enqueue for delivery.</p>
<p><strong>Protocol:</strong> Kafka consumer (event ingestion). Internal gRPC to Preference Service. HTTP/2 to APNs, HTTPS to FCM.</p>
</div>

<div class="deep-dive">
<h4>Preference Service</h4>
<p>Manages user notification settings. Exposes a gRPC API: <code>GetPreferences(user_id) → {likes: true, comments: true, follows: true, mentions: false, ...}</code>. Caches preferences in Redis (read-heavy, rarely updated).</p>
<p><strong>Cache strategy:</strong> Read-through cache. TTL = 1 hour. Invalidated on preference update (write-through).</p>
</div>

<div class="deep-dive">
<h4>Rate Limiter</h4>
<p>Implemented using a <strong>sliding window counter</strong> in Redis. Key: <code>ratelimit:{user_id}:{hour}</code>. INCR on each notification. If count &gt; 50, suppress. Uses a secondary key <code>batch:{user_id}</code> to accumulate suppressed events for batch notification.</p>
<p><strong>Why sliding window:</strong> Fixed window can allow bursts at window boundaries. Sliding window provides smoother rate limiting.</p>
</div>

<div class="deep-dive">
<h4>Device Token Store</h4>
<p>Stores APNs/FCM device tokens per user. Schema: <code>{user_id → [{device_token, platform, app_version, last_active}]}</code>. Users can have multiple devices. Stale tokens (device not seen in 30 days) are periodically purged. Stored in Cassandra for high availability.</p>
</div>

<div class="deep-dive">
<h4>Push Workers</h4>
<p>Worker pool that dequeues from the Send Queue and makes HTTP calls to APNs/FCM. Uses connection pooling and HTTP/2 multiplexing for high throughput to APNs. Handles retries with exponential backoff for transient failures. Invalid device tokens (APNs returns 410 Gone) are flagged for removal from the Device Token Store.</p>
</div>

<div class="deep-dive">
<h4>APNs and FCM (External Services)</h4>
<p><strong>APNs (Apple Push Notification service):</strong> Connected via HTTP/2 with persistent connections. Requires JWT-based authentication. Supports alert, badge, and silent notifications.</p>
<p><strong>FCM (Firebase Cloud Messaging):</strong> Connected via HTTPS POST to <code>https://fcm.googleapis.com/v1/projects/{id}/messages:send</code>. Supports data messages and notification messages.</p>
<p><strong>Protocol:</strong> Both use TCP/TLS. APNs uses HTTP/2 for multiplexing (sending multiple notifications on one connection). FCM uses standard HTTPS.</p>
</div>

<!-- ==================== FLOW 2: DEVICE TOKEN REGISTRATION ==================== -->
<h2>Flow 2: Device Token Registration</h2>
<div class="diagram">
<svg viewBox="0 0 700 200" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="a2" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M0 0L10 5L0 10z" fill="#333"/></marker></defs>
  <rect x="10" y="70" width="90" height="55" rx="8" fill="#4caf50" stroke="#388e3c" stroke-width="2"/>
  <text x="55" y="102" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">Client</text>
  <line x1="100" y1="97" x2="180" y2="97" stroke="#333" stroke-width="2" marker-end="url(#a2)"/>
  <text x="140" y="88" text-anchor="middle" fill="#555" font-size="9">PUT /device-token</text>
  <rect x="180" y="70" width="100" height="55" rx="8" fill="#ff9800" stroke="#f57c00" stroke-width="2"/>
  <text x="230" y="95" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">API</text>
  <text x="230" y="108" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Gateway</text>
  <line x1="280" y1="97" x2="360" y2="97" stroke="#333" stroke-width="2" marker-end="url(#a2)"/>
  <rect x="360" y="70" width="120" height="55" rx="8" fill="#e91e63" stroke="#ad1457" stroke-width="2"/>
  <text x="420" y="95" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Device Token</text>
  <text x="420" y="108" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Service</text>
  <line x1="480" y1="97" x2="560" y2="97" stroke="#333" stroke-width="2" marker-end="url(#a2)"/>
  <ellipse cx="610" cy="90" rx="40" ry="10" fill="#ff5722" stroke="#d84315" stroke-width="1.5"/>
  <rect x="570" y="90" width="80" height="25" fill="#ff5722" stroke="#d84315" stroke-width="1.5"/>
  <ellipse cx="610" cy="115" rx="40" ry="10" fill="#e64a19" stroke="#d84315" stroke-width="1.5"/>
  <line x1="570" y1="90" x2="570" y2="115" stroke="#d84315" stroke-width="1.5"/>
  <line x1="650" y1="90" x2="650" y2="115" stroke="#d84315" stroke-width="1.5"/>
  <text x="610" y="107" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Token Store</text>
</svg>
</div>

<div class="example">
<h4>Example: App install and token registration</h4>
<p>Alice installs Instagram on her new iPhone. On first launch, the app requests push notification permission from iOS. iOS returns an APNs device token. The app sends <strong>PUT /api/v1/device-token</strong> with <code>{user_id: alice, device_token: "abc123...", platform: "ios", app_version: "310.0"}</code> to the API Gateway → <strong>Device Token Service</strong> → upserts into the <strong>Token Store</strong> (Cassandra). If Alice reinstalls the app, a new token is generated and the old one is replaced.</p>
</div>

<!-- ==================== OVERALL COMBINED FLOW ==================== -->
<h2>Overall Combined Flow</h2>
<div class="diagram">
<svg viewBox="0 0 1150 400" xmlns="http://www.w3.org/2000/svg">
  <defs><marker id="a3" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M0 0L10 5L0 10z" fill="#333"/></marker></defs>
  <!-- Sources -->
  <rect x="5" y="150" width="80" height="35" rx="5" fill="#2196f3" stroke="#1565c0" stroke-width="1.5"/>
  <text x="45" y="172" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Services</text>
  <!-- Kafka -->
  <line x1="85" y1="167" x2="140" y2="167" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="140" y="148" width="80" height="38" rx="6" fill="#9c27b0" stroke="#6a1b9a" stroke-width="1.5"/>
  <text x="180" y="171" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Kafka</text>
  <!-- Push Notif Service -->
  <line x1="220" y1="167" x2="280" y2="167" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="280" y="140" width="110" height="55" rx="8" fill="#e91e63" stroke="#ad1457" stroke-width="2"/>
  <text x="335" y="165" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Push Notif</text>
  <text x="335" y="178" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Service</text>
  <!-- Pref check -->
  <line x1="335" y1="140" x2="335" y2="75" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="295" y="35" width="80" height="40" rx="5" fill="#673ab7" stroke="#4527a0" stroke-width="1.5"/>
  <text x="335" y="55" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Prefs</text>
  <text x="335" y="65" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">+ Cache</text>
  <!-- Rate limiter -->
  <line x1="335" y1="195" x2="335" y2="250" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <rect x="295" y="250" width="80" height="35" rx="5" fill="#00bcd4" stroke="#00838f" stroke-width="1.5"/>
  <text x="335" y="272" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Rate Limit</text>
  <!-- Device tokens -->
  <line x1="390" y1="155" x2="440" y2="105" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
  <ellipse cx="480" cy="95" rx="35" ry="8" fill="#ff5722" stroke="#d84315" stroke-width="1"/>
  <rect x="445" y="95" width="70" height="18" fill="#ff5722" stroke="#d84315" stroke-width="1"/>
  <ellipse cx="480" cy="113" rx="35" ry="8" fill="#e64a19" stroke="#d84315" stroke-width="1"/>
  <line x1="445" y1="95" x2="445" y2="113" stroke="#d84315" stroke-width="1"/>
  <line x1="515" y1="95" x2="515" y2="113" stroke="#d84315" stroke-width="1"/>
  <text x="480" y="108" text-anchor="middle" fill="#fff" font-size="7" font-weight="bold">Tokens</text>
  <!-- Send Queue -->
  <line x1="390" y1="170" x2="450" y2="170" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="450" y="150" width="90" height="38" rx="6" fill="#9c27b0" stroke="#6a1b9a" stroke-width="1.5"/>
  <text x="495" y="173" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Send Queue</text>
  <!-- Workers -->
  <line x1="540" y1="170" x2="600" y2="170" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="600" y="148" width="90" height="42" rx="6" fill="#ff9800" stroke="#f57c00" stroke-width="1.5"/>
  <text x="645" y="173" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Workers</text>
  <!-- APNs/FCM -->
  <line x1="690" y1="160" x2="750" y2="135" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="750" y="118" width="60" height="30" rx="5" fill="#607d8b" stroke="#37474f" stroke-width="1.5"/>
  <text x="780" y="137" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">APNs</text>
  <line x1="690" y1="178" x2="750" y2="200" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="750" y="188" width="60" height="30" rx="5" fill="#607d8b" stroke="#37474f" stroke-width="1.5"/>
  <text x="780" y="207" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">FCM</text>
  <!-- Devices -->
  <line x1="810" y1="133" x2="860" y2="133" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="860" y="118" width="50" height="30" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="885" y="137" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">iOS</text>
  <line x1="810" y1="203" x2="860" y2="203" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="860" y="188" width="60" height="30" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="890" y="207" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Android</text>
  <!-- Token Registration path (bottom) -->
  <rect x="5" y="320" width="80" height="35" rx="5" fill="#4caf50" stroke="#388e3c" stroke-width="1.5"/>
  <text x="45" y="342" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">Client</text>
  <line x1="85" y1="337" x2="140" y2="337" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <text x="112" y="330" text-anchor="middle" fill="#555" font-size="7">PUT</text>
  <rect x="140" y="320" width="80" height="35" rx="5" fill="#ff9800" stroke="#f57c00" stroke-width="1.5"/>
  <text x="180" y="342" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">API GW</text>
  <line x1="220" y1="337" x2="280" y2="337" stroke="#333" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="280" y="320" width="90" height="35" rx="5" fill="#e91e63" stroke="#ad1457" stroke-width="1.5"/>
  <text x="325" y="342" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">Token Svc</text>
  <line x1="370" y1="337" x2="445" y2="120" stroke="#333" stroke-width="1" marker-end="url(#a3)"/>
</svg>
</div>

<div class="example">
<h4>Combined Example</h4>
<p><strong>Registration:</strong> Client installs app → requests push permission → gets device token from OS → PUT /device-token → stored in Token Store. <strong>Notification:</strong> Bob likes Alice's photo → Like Service → Kafka → Push Notification Service checks prefs (enabled), checks rate limit (under threshold), fetches Alice's 2 device tokens → constructs payload → enqueues to Send Queue → Push Workers send to APNs (iPhone) and FCM (Android tablet) → Alice sees push on both devices.</p>
</div>

<!-- ==================== SCHEMA ==================== -->
<h2>Database Schema</h2>

<h3>NoSQL Tables (Cassandra)</h3>

<h4>1. device_tokens</h4>
<table>
  <tr><th>Field</th><th>Type</th><th>Key</th><th>Description</th></tr>
  <tr><td>user_id</td><td>BIGINT</td><td><span class="tag tag-pk">Partition Key</span></td><td>User who owns the device</td></tr>
  <tr><td>device_token</td><td>TEXT</td><td><span class="tag tag-pk">Clustering Key</span></td><td>APNs or FCM token</td></tr>
  <tr><td>platform</td><td>TEXT</td><td></td><td>ios, android</td></tr>
  <tr><td>app_version</td><td>TEXT</td><td></td><td>App version for targeting</td></tr>
  <tr><td>last_active</td><td>TIMESTAMP</td><td></td><td>Last time device was seen</td></tr>
  <tr><td>created_at</td><td>TIMESTAMP</td><td></td><td>Registration time</td></tr>
</table>
<p><strong>Why NoSQL:</strong> Simple key-value lookup (get all tokens for user_id). High availability required. No relational queries.</p>
<p><strong>Read:</strong> When sending a push notification (fetch all device tokens for a user). <strong>Write:</strong> On app launch (device token registration/update), on token invalidation (APNs returns error).</p>

<h3>SQL Tables (PostgreSQL)</h3>

<h4>2. notification_preferences</h4>
<table>
  <tr><th>Field</th><th>Type</th><th>Key</th><th>Description</th></tr>
  <tr><td>user_id</td><td>BIGINT</td><td><span class="tag tag-pk">PK</span></td><td>User</td></tr>
  <tr><td>likes_enabled</td><td>BOOLEAN</td><td></td><td>Default: true</td></tr>
  <tr><td>comments_enabled</td><td>BOOLEAN</td><td></td><td>Default: true</td></tr>
  <tr><td>follows_enabled</td><td>BOOLEAN</td><td></td><td>Default: true</td></tr>
  <tr><td>mentions_enabled</td><td>BOOLEAN</td><td></td><td>Default: true</td></tr>
  <tr><td>dm_enabled</td><td>BOOLEAN</td><td></td><td>Default: true</td></tr>
  <tr><td>quiet_hours_start</td><td>TIME</td><td></td><td>DND start time (nullable)</td></tr>
  <tr><td>quiet_hours_end</td><td>TIME</td><td></td><td>DND end time (nullable)</td></tr>
  <tr><td>updated_at</td><td>TIMESTAMP</td><td></td><td>Last update time</td></tr>
</table>
<p><strong>Why SQL:</strong> Small table (one row per user), strong consistency needed (preference changes must take effect immediately), ACID for updates.</p>
<p><strong>Index:</strong> PK on user_id (hash). No additional indexes needed.</p>
<p><strong>Read:</strong> On every push notification event (cached in Redis). <strong>Write:</strong> When user changes notification settings.</p>

<!-- ==================== CACHE ==================== -->
<h2>Cache Deep Dive</h2>
<div class="deep-dive">
<h4>Preference Cache (Redis)</h4>
<p><strong>Purpose:</strong> Cache notification preferences to avoid hitting PostgreSQL on every event.</p>
<p><strong>Strategy:</strong> <strong>Read-through with write-invalidation.</strong> On read: check Redis first, if miss → query PostgreSQL → populate Redis. On write: update PostgreSQL → invalidate Redis key → next read repopulates.</p>
<p><strong>Eviction:</strong> LRU. <strong>Expiration:</strong> TTL = 1 hour.</p>
</div>

<h2>Scaling Considerations</h2>
<ul>
  <li><strong>Load Balancer:</strong> L7 LB in front of API Gateway for device token registration. Internal LB for Push Workers.</li>
  <li><strong>Push Workers:</strong> Auto-scale based on Send Queue depth. Peak load (celebrity posts) may require 10x normal capacity.</li>
  <li><strong>Connection pooling:</strong> Each Push Worker maintains persistent HTTP/2 connections to APNs (multiplexed) and connection pools to FCM.</li>
  <li><strong>Kafka partitioning:</strong> Partition by <code>target_user_id % N</code> to distribute load evenly across consumers.</li>
</ul>

<h2>Tradeoffs and Deep Dives</h2>
<div class="tradeoff">
<h4>Push vs. Pull for Notifications</h4>
<p>Push (proactive delivery via APNs/FCM) is chosen over pull (client polling). Push provides real-time delivery with minimal battery drain. The tradeoff is dependency on third-party services (APNs/FCM) and their rate limits/quotas.</p>
</div>

<div class="tradeoff">
<h4>Two-Queue Architecture</h4>
<p>We use two queues: Event Queue (Kafka, for raw events) and Send Queue (for processed, ready-to-send notifications). This separation allows the Push Notification Service to filter/enrich events without blocking delivery workers.</p>
</div>

<h2>Alternative Approaches</h2>
<div class="alternative">
<h4>Alternative: WebSocket for Real-time In-app Notifications</h4>
<p>Instead of APNs/FCM, use a persistent WebSocket to push notifications while the app is open. This is used for in-app real-time updates but doesn't replace push notifications because WebSocket only works when the app is in the foreground. Push notifications via APNs/FCM work even when the app is closed/backgrounded.</p>
</div>

<div class="alternative">
<h4>Alternative: SMS Fallback</h4>
<p>For critical notifications (e.g., security alerts), fall back to SMS if push delivery fails. Not used for social notifications due to cost (~$0.01/SMS at scale = millions of dollars/day).</p>
</div>

<h2>Additional Information</h2>
<h3>Notification Analytics</h3>
<p>Track notification delivery rates, open rates, and engagement (did the user tap the notification?). APNs provides delivery receipts; FCM provides message delivery data. Analytics are streamed to a data warehouse (BigQuery/Hive) for analysis.</p>

<h3>A/B Testing Notifications</h3>
<p>The notification payload (copy, image, timing) can be A/B tested. The Push Notification Service integrates with an experimentation platform to select notification variants per user cohort.</p>
</div>
</body>
</html>
