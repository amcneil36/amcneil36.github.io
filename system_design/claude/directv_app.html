<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DirecTV App - System Design</title>
<style>
:root{--bg:#0f0f0f;--surface:#1a1a1a;--border:#2a2a2a;--text:#e0e0e0;--accent:#00A3E0;--accent2:#FF6B00;}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;line-height:1.7;padding:2rem;max-width:1400px;margin:0 auto}
h1{color:var(--accent);font-size:2.2rem;border-bottom:3px solid var(--accent);padding-bottom:.5rem;margin-bottom:1.5rem}
h2{color:var(--accent2);margin:2rem 0 1rem;font-size:1.5rem}
h3{color:#81D4FA;margin:1.5rem 0 .75rem}
h4{color:#CE93D8;margin:1rem 0 .5rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin:1rem 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1rem}
table{width:100%;border-collapse:collapse;margin:1rem 0}
th,td{border:1px solid var(--border);padding:.75rem;text-align:left;font-size:.95rem}
th{background:#0a3d5c;color:var(--accent)}
pre{background:#1e1e1e;padding:1rem;border-radius:8px;overflow-x:auto;margin:.5rem 0}
code{color:#89DDFF;font-size:.9rem}
svg text{font-family:'Segoe UI',system-ui,sans-serif}
.tradeoff-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.pro{border-left:4px solid #4CAF50;padding-left:1rem}
.con{border-left:4px solid #f44336;padding-left:1rem}
details{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;margin:.5rem 0}
summary{cursor:pointer;font-weight:600;color:var(--accent)}
.step{margin:.5rem 0;padding:.5rem 1rem;border-left:3px solid var(--accent2)}
.tag-pk{background:#E91E63;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
.tag-fk{background:#2196F3;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
.tag-idx{background:#FF9800;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
.tag-shard{background:#9C27B0;color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem}
</style>
</head>
<body>

<h1>üì∫ DirecTV App ‚Äî Live TV & Streaming Platform</h1>
<p>Design a TV streaming application that delivers live satellite/streaming channels, on-demand content, DVR recording, and multi-device viewing with a unified electronic program guide (EPG).</p>

<h2>üìã Functional Requirements</h2>
<div class="card">
<ul>
<li><strong>Live TV streaming</strong> ‚Äî stream 300+ live channels with &lt;3s channel switch time</li>
<li><strong>Electronic Program Guide (EPG)</strong> ‚Äî browseable schedule grid with 14-day lookback and 7-day lookahead</li>
<li><strong>Cloud DVR</strong> ‚Äî record live programs to cloud storage, manage recordings, series recording rules</li>
<li><strong>On-demand library</strong> ‚Äî browse/search 50K+ movies and shows with personalized recommendations</li>
<li><strong>Multi-device sync</strong> ‚Äî seamless handoff between TV, mobile, tablet, web (resume where you left off)</li>
<li><strong>Parental controls</strong> ‚Äî content ratings filter, PIN-locked channels, viewing time limits</li>
<li><strong>Authentication & entitlements</strong> ‚Äî verify subscription tier, regional blackout enforcement, concurrent stream limits</li>
</ul>
</div>

<h2>üìã Non-Functional Requirements</h2>
<div class="card">
<ul>
<li><strong>Low latency</strong> ‚Äî live TV latency &lt;5s behind actual broadcast, channel switch &lt;3s</li>
<li><strong>Availability</strong> ‚Äî 99.99% for live streams, especially during major events (Super Bowl, Olympics)</li>
<li><strong>Scale</strong> ‚Äî 15M+ subscribers, 5M+ concurrent viewers during peak (Sunday NFL)</li>
<li><strong>Quality</strong> ‚Äî adaptive bitrate 480p to 4K HDR, Dolby Atmos audio</li>
<li><strong>DRM</strong> ‚Äî content protection (Widevine, FairPlay, PlayReady) per studio licensing</li>
<li><strong>Compliance</strong> ‚Äî FCC blackout rules, regional sports network restrictions, Ad insertion for live</li>
</ul>
</div>

<h2>üîÑ Flow 1: Live TV Channel Streaming</h2>
<svg viewBox="0 0 1050 320" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="a1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#00A3E0"/></marker></defs>
<rect x="20" y="50" width="110" height="50" rx="8" fill="#2E7D32"/><text x="75" y="80" text-anchor="middle" fill="white" font-size="12">Satellite Feed</text>
<rect x="170" y="50" width="130" height="50" rx="8" fill="#1565C0"/><text x="235" y="70" text-anchor="middle" fill="white" font-size="12">Ingest & Transcode</text><text x="235" y="85" text-anchor="middle" fill="white" font-size="10">(MPEG-TS ‚Üí HLS)</text>
<rect x="345" y="50" width="130" height="50" rx="8" fill="#E65100"/><text x="410" y="70" text-anchor="middle" fill="white" font-size="12">Origin Server</text><text x="410" y="85" text-anchor="middle" fill="white" font-size="10">(manifest + segments)</text>
<rect x="520" y="50" width="120" height="50" rx="8" fill="#607D8B"/><text x="580" y="80" text-anchor="middle" fill="white" font-size="12">CDN Edge</text>
<rect x="690" y="50" width="120" height="50" rx="8" fill="#2E7D32"/><text x="750" y="80" text-anchor="middle" fill="white" font-size="12">Client Player</text>
<rect x="345" y="170" width="130" height="50" rx="8" fill="#6A1B9A"/><text x="410" y="190" text-anchor="middle" fill="white" font-size="12">SCTE-35 Ad</text><text x="410" y="205" text-anchor="middle" fill="white" font-size="10">Insertion (SSAI)</text>
<rect x="520" y="170" width="120" height="50" rx="8" fill="#1565C0"/><text x="580" y="190" text-anchor="middle" fill="white" font-size="12">Entitlements</text><text x="580" y="205" text-anchor="middle" fill="white" font-size="10">Service</text>
<rect x="690" y="170" width="120" height="50" rx="8" fill="#4E342E"/><text x="750" y="190" text-anchor="middle" fill="white" font-size="12">DRM License</text><text x="750" y="205" text-anchor="middle" fill="white" font-size="10">Server</text>
<line x1="130" y1="75" x2="165" y2="75" stroke="#00A3E0" stroke-width="2" marker-end="url(#a1)"/>
<line x1="300" y1="75" x2="340" y2="75" stroke="#00A3E0" stroke-width="2" marker-end="url(#a1)"/>
<line x1="475" y1="75" x2="515" y2="75" stroke="#00A3E0" stroke-width="2" marker-end="url(#a1)"/>
<line x1="640" y1="75" x2="685" y2="75" stroke="#00A3E0" stroke-width="2" marker-end="url(#a1)"/>
<line x1="410" y1="100" x2="410" y2="165" stroke="#FF6B00" stroke-width="2" marker-end="url(#a1)"/>
<line x1="750" y1="100" x2="750" y2="165" stroke="#FF6B00" stroke-width="2" marker-end="url(#a1)"/>
<line x1="640" y1="195" x2="685" y2="195" stroke="#FF6B00" stroke-width="2" marker-end="url(#a1)"/>
<text x="420" y="140" fill="#aaa" font-size="10">ad markers</text>
<text x="760" y="140" fill="#aaa" font-size="10">license request</text>
</svg>

<div class="step"><strong>Step 1:</strong> Satellite/fiber feed received at ingest facility. MPEG-TS demuxed, transcoded to multiple ABR profiles (HLS/DASH)</div>
<div class="step"><strong>Step 2:</strong> Live segments (2-6s each) pushed to origin server with rolling manifest updates</div>
<div class="step"><strong>Step 3:</strong> SCTE-35 markers in stream trigger server-side ad insertion (SSAI) for personalized ads</div>
<div class="step"><strong>Step 4:</strong> Client requests manifest from CDN edge, plays segments. DRM license fetched on first play</div>
<div class="step"><strong>Step 5:</strong> Entitlements Service validates subscription tier and blackout rules before granting access</div>

<details><summary>Deep Dive: HLS Live Streaming Architecture</summary>
<div class="card">
<pre><code>// HLS (HTTP Live Streaming) for live TV:
// Segments: 6-second CMAF (Common Media Application Format) chunks
// Low-latency HLS (LL-HLS): partial segments of ~200ms

// Manifest structure:
#EXTM3U
#EXT-X-STREAM-INF:BANDWIDTH=2000000,RESOLUTION=1280x720
  channel_123/720p/playlist.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080
  channel_123/1080p/playlist.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=15000000,RESOLUTION=3840x2160
  channel_123/4k/playlist.m3u8

// Per-quality playlist (rolling window):
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:48291
#EXTINF:6.006,
  segment_48291.ts
#EXTINF:6.006,
  segment_48292.ts
// ... rolling 3-5 segments for live edge

// Channel switch optimization:
// 1. Start with lowest quality (instant start)
// 2. ABR algorithm switches up within 2-3 segments
// 3. Pre-fetch neighboring channel manifests
// 4. Keep low-quality stream for recently-watched channels in buffer
// Goal: &lt;2s perceived switch time</code></pre>
</div>
</details>

<details><summary>Deep Dive: Server-Side Ad Insertion (SSAI)</summary>
<div class="card">
<pre><code>// SSAI replaces broadcast ads with personalized digital ads
// Advantages over client-side: no ad blockers, seamless stitching

// Flow:
// 1. Encoder detects SCTE-35 markers in MPEG-TS stream
//    (SCTE-35 = industry standard for ad signaling)
// 2. Ad decision server called with user profile + context
// 3. Ad creative pre-transcoded to match stream bitrate profiles
// 4. Manifest manipulated to splice ad segments inline
// 5. Client sees continuous stream (no buffering at ad breaks)

// Personalization signals:
{
  "user_id": "u_123",
  "geo": {"dma": "501", "zip": "10001"},  // Nielsen DMA
  "device": "roku_ultra",
  "channel": "ESPN",
  "program": "NFL_Sunday",
  "ad_pod_duration": 120,  // seconds
  "content_rating": "TV-PG"
}

// Revenue: targeted ads command 3-5x CPM vs broadcast ads
// Compliance: maintain ad load limits per FCC/contractual rules</code></pre>
</div>
</details>

<h2>üîÑ Flow 2: Cloud DVR Recording</h2>
<svg viewBox="0 0 1000 280" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="a2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#FF6B00"/></marker></defs>
<rect x="20" y="60" width="120" height="50" rx="8" fill="#2E7D32"/><text x="80" y="90" text-anchor="middle" fill="white" font-size="12">User Sets Record</text>
<rect x="190" y="60" width="130" height="50" rx="8" fill="#1565C0"/><text x="255" y="80" text-anchor="middle" fill="white" font-size="12">DVR Scheduler</text><text x="255" y="95" text-anchor="middle" fill="white" font-size="10">Service</text>
<rect x="370" y="60" width="130" height="50" rx="8" fill="#6A1B9A"/><text x="435" y="80" text-anchor="middle" fill="white" font-size="12">Live Ingest</text><text x="435" y="95" text-anchor="middle" fill="white" font-size="10">Capture</text>
<rect x="550" y="60" width="130" height="50" rx="8" fill="#4E342E"/><text x="615" y="80" text-anchor="middle" fill="white" font-size="12">Object Storage</text><text x="615" y="95" text-anchor="middle" fill="white" font-size="10">(S3 / GCS)</text>
<rect x="730" y="60" width="130" height="50" rx="8" fill="#00695C"/><text x="795" y="80" text-anchor="middle" fill="white" font-size="12">Recording</text><text x="795" y="95" text-anchor="middle" fill="white" font-size="10">Metadata DB</text>
<rect x="370" y="180" width="130" height="50" rx="8" fill="#1565C0"/><text x="435" y="200" text-anchor="middle" fill="white" font-size="12">Copy-on-Write</text><text x="435" y="215" text-anchor="middle" fill="white" font-size="10">Deduplication</text>
<line x1="140" y1="85" x2="185" y2="85" stroke="#FF6B00" stroke-width="2" marker-end="url(#a2)"/>
<line x1="320" y1="85" x2="365" y2="85" stroke="#FF6B00" stroke-width="2" marker-end="url(#a2)"/>
<line x1="500" y1="85" x2="545" y2="85" stroke="#FF6B00" stroke-width="2" marker-end="url(#a2)"/>
<line x1="680" y1="85" x2="725" y2="85" stroke="#FF6B00" stroke-width="2" marker-end="url(#a2)"/>
<line x1="435" y1="110" x2="435" y2="175" stroke="#81D4FA" stroke-width="2" marker-end="url(#a2)"/>
<text x="450" y="150" fill="#aaa" font-size="10">shared segments</text>
</svg>

<div class="step"><strong>Step 1:</strong> User schedules recording (single episode or series rule). DVR Scheduler persists rule</div>
<div class="step"><strong>Step 2:</strong> At scheduled time, Live Ingest Capture writes encrypted segments to object storage</div>
<div class="step"><strong>Step 3:</strong> Copy-on-write deduplication: if 10K users record same show, store ONE copy, create per-user metadata pointers</div>
<div class="step"><strong>Step 4:</strong> Recording metadata (start/end times, segment manifest, user_id) saved to Recording DB</div>
<div class="step"><strong>Step 5:</strong> Playback: generate user-specific manifest with their ad insertions, serve from CDN</div>

<details><summary>Deep Dive: Cloud DVR Deduplication</summary>
<div class="card">
<pre><code>// Cloud DVR economics depend on deduplication:
// Without dedup: 1M users √ó 50 recordings √ó 2GB each = 100 PB!
// With dedup: store unique content ONCE = ~500TB

// Implementation: Copy-on-Write references
// Physical storage: one copy per (channel, timeslot)
// Per-user: metadata pointer + custom ad manifest

recordings_physical: {
  id: "rec_phys_espn_20250209_1300",
  channel_id: "espn",
  start_time: "2025-02-09T13:00:00Z",
  end_time: "2025-02-09T16:30:00Z",
  segments: ["s3://dvr/espn/20250209/seg_0001.ts", ...],
  total_size_gb: 8.5
}

recordings_user: {
  user_id: "u_123",
  physical_recording_id: "rec_phys_espn_20250209_1300",
  user_start_offset: 0, // user might set to record from beginning
  user_end_offset: 0,
  ad_manifest_id: "adm_u123_espn_sb", // personalized ads
  watched_position: 3600, // resume point (seconds)
  expires_at: "2025-05-09T16:30:00Z" // 90-day retention
}

// Storage savings: 95-99% reduction via deduplication
// Cost: ~$0.02/GB/month for S3 Standard</code></pre>
</div>
</details>

<h2>üîÑ Flow 3: EPG (Electronic Program Guide) & Search</h2>
<svg viewBox="0 0 1000 280" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="a3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#00A3E0"/></marker></defs>
<rect x="20" y="60" width="110" height="50" rx="8" fill="#2E7D32"/><text x="75" y="90" text-anchor="middle" fill="white" font-size="12">Client App</text>
<rect x="180" y="60" width="130" height="50" rx="8" fill="#1565C0"/><text x="245" y="80" text-anchor="middle" fill="white" font-size="12">EPG Service</text><text x="245" y="95" text-anchor="middle" fill="white" font-size="10">(schedule API)</text>
<rect x="360" y="30" width="130" height="50" rx="8" fill="#00695C"/><text x="425" y="60" text-anchor="middle" fill="white" font-size="12">Redis EPG Cache</text>
<rect x="360" y="100" width="130" height="50" rx="8" fill="#4E342E"/><text x="425" y="130" text-anchor="middle" fill="white" font-size="12">Schedule DB</text>
<rect x="550" y="60" width="130" height="50" rx="8" fill="#6A1B9A"/><text x="615" y="80" text-anchor="middle" fill="white" font-size="12">Gracenote /</text><text x="615" y="95" text-anchor="middle" fill="white" font-size="10">TMS Data Feed</text>
<rect x="180" y="190" width="130" height="50" rx="8" fill="#1565C0"/><text x="245" y="220" text-anchor="middle" fill="white" font-size="12">Search Service</text>
<rect x="360" y="190" width="130" height="50" rx="8" fill="#4E342E"/><text x="425" y="220" text-anchor="middle" fill="white" font-size="12">Elasticsearch</text>
<line x1="130" y1="85" x2="175" y2="85" stroke="#00A3E0" stroke-width="2" marker-end="url(#a3)"/>
<line x1="310" y1="70" x2="355" y2="55" stroke="#00A3E0" stroke-width="2" marker-end="url(#a3)"/>
<line x1="310" y1="100" x2="355" y2="125" stroke="#00A3E0" stroke-width="2" marker-end="url(#a3)"/>
<line x1="490" y1="55" x2="545" y2="75" stroke="#81D4FA" stroke-width="2" marker-end="url(#a3)"/>
<line x1="490" y1="125" x2="545" y2="95" stroke="#81D4FA" stroke-width="2" marker-end="url(#a3)"/>
<line x1="130" y1="95" x2="175" y2="215" stroke="#FF6B00" stroke-width="2" marker-end="url(#a3)"/>
<line x1="310" y1="215" x2="355" y2="215" stroke="#FF6B00" stroke-width="2" marker-end="url(#a3)"/>
</svg>

<div class="step"><strong>Step 1:</strong> Gracenote/TMS provides program schedule data (updated every 15 min). Ingested into Schedule DB</div>
<div class="step"><strong>Step 2:</strong> EPG Service caches schedule data in Redis (key: channel_id + date, TTL: 1 hour)</div>
<div class="step"><strong>Step 3:</strong> Client requests EPG grid for visible channels + time window. Server returns paginated schedule</div>
<div class="step"><strong>Step 4:</strong> Search queries hit Elasticsearch (title, actor, genre, keyword across live + on-demand catalog)</div>

<h2>üèóÔ∏è Combined Architecture</h2>
<svg viewBox="0 0 1100 500" style="width:100%;background:#111;border-radius:12px;margin:1rem 0">
<defs><marker id="ac" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#00A3E0"/></marker></defs>
<text x="550" y="25" text-anchor="middle" fill="#00A3E0" font-size="16" font-weight="bold">DirecTV Streaming Architecture</text>
<rect x="20" y="50" width="120" height="40" rx="8" fill="#2E7D32"/><text x="80" y="75" text-anchor="middle" fill="white" font-size="11">Client Devices</text>
<rect x="200" y="50" width="130" height="40" rx="8" fill="#E65100"/><text x="265" y="75" text-anchor="middle" fill="white" font-size="11">API Gateway / LB</text>
<rect x="400" y="40" width="130" height="35" rx="8" fill="#1565C0"/><text x="465" y="63" text-anchor="middle" fill="white" font-size="11">Auth & Entitlements</text>
<rect x="400" y="85" width="130" height="35" rx="8" fill="#1565C0"/><text x="465" y="108" text-anchor="middle" fill="white" font-size="11">EPG Service</text>
<rect x="400" y="130" width="130" height="35" rx="8" fill="#1565C0"/><text x="465" y="153" text-anchor="middle" fill="white" font-size="11">DVR Service</text>
<rect x="400" y="175" width="130" height="35" rx="8" fill="#1565C0"/><text x="465" y="198" text-anchor="middle" fill="white" font-size="11">Catalog / Search</text>
<rect x="400" y="220" width="130" height="35" rx="8" fill="#1565C0"/><text x="465" y="243" text-anchor="middle" fill="white" font-size="11">Playback Service</text>
<rect x="620" y="50" width="130" height="40" rx="8" fill="#6A1B9A"/><text x="685" y="75" text-anchor="middle" fill="white" font-size="11">Live Ingest Pipeline</text>
<rect x="620" y="110" width="130" height="40" rx="8" fill="#607D8B"/><text x="685" y="135" text-anchor="middle" fill="white" font-size="11">CDN (Akamai)</text>
<rect x="620" y="170" width="130" height="40" rx="8" fill="#4E342E"/><text x="685" y="195" text-anchor="middle" fill="white" font-size="11">DRM License Server</text>
<rect x="620" y="230" width="130" height="40" rx="8" fill="#E65100"/><text x="685" y="255" text-anchor="middle" fill="white" font-size="11">SSAI Ad Server</text>
<rect x="830" y="50" width="140" height="40" rx="8" fill="#4E342E"/><text x="900" y="75" text-anchor="middle" fill="white" font-size="11">Object Storage (DVR)</text>
<rect x="830" y="110" width="140" height="40" rx="8" fill="#4E342E"/><text x="900" y="135" text-anchor="middle" fill="white" font-size="11">PostgreSQL / Cassandra</text>
<rect x="830" y="170" width="140" height="40" rx="8" fill="#00695C"/><text x="900" y="195" text-anchor="middle" fill="white" font-size="11">Redis Cluster</text>
<rect x="830" y="230" width="140" height="40" rx="8" fill="#4E342E"/><text x="900" y="255" text-anchor="middle" fill="white" font-size="11">Elasticsearch</text>
<rect x="200" y="370" width="130" height="40" rx="8" fill="#6A1B9A"/><text x="265" y="395" text-anchor="middle" fill="white" font-size="11">Recommendation ML</text>
<rect x="400" y="370" width="130" height="40" rx="8" fill="#6A1B9A"/><text x="465" y="395" text-anchor="middle" fill="white" font-size="11">Analytics Pipeline</text>
<rect x="620" y="370" width="130" height="40" rx="8" fill="#1565C0"/><text x="685" y="395" text-anchor="middle" fill="white" font-size="11">Concurrency Mgr</text>
<line x1="140" y1="70" x2="195" y2="70" stroke="#00A3E0" stroke-width="2" marker-end="url(#ac)"/>
<line x1="330" y1="70" x2="395" y2="57" stroke="#00A3E0" stroke-width="2" marker-end="url(#ac)"/>
<line x1="330" y1="70" x2="395" y2="102" stroke="#00A3E0" stroke-width="2" marker-end="url(#ac)"/>
<line x1="530" y1="57" x2="615" y2="70" stroke="#00A3E0" stroke-width="2" marker-end="url(#ac)"/>
<line x1="530" y1="243" x2="615" y2="135" stroke="#81D4FA" stroke-width="2" marker-end="url(#ac)"/>
<line x1="750" y1="70" x2="825" y2="70" stroke="#FF6B00" stroke-width="2" marker-end="url(#ac)"/>
<line x1="750" y1="135" x2="825" y2="135" stroke="#FF6B00" stroke-width="2" marker-end="url(#ac)"/>
<line x1="750" y1="195" x2="825" y2="195" stroke="#FF6B00" stroke-width="2" marker-end="url(#ac)"/>
<line x1="750" y1="255" x2="825" y2="255" stroke="#FF6B00" stroke-width="2" marker-end="url(#ac)"/>
</svg>

<h2>üíæ Database Schema</h2>
<div class="grid">
<div class="card">
<h3>PostgreSQL ‚Äî Core Entities</h3>
<pre><code>CREATE TABLE users (
  id UUID PRIMARY KEY, -- <span class="tag-pk">PK</span>
  account_id UUID NOT NULL, -- <span class="tag-fk">FK</span> household account
  email VARCHAR(255) UNIQUE,
  subscription_tier VARCHAR(20) NOT NULL, -- 'entertainment','choice','ultimate'
  max_concurrent_streams INT DEFAULT 3,
  parental_pin_hash VARCHAR(64),
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE channels (
  id SERIAL PRIMARY KEY, -- <span class="tag-pk">PK</span>
  call_sign VARCHAR(10) NOT NULL, -- 'ESPN', 'HBO'
  name VARCHAR(100) NOT NULL,
  tier_required VARCHAR(20) NOT NULL, -- <span class="tag-idx">IDX</span>
  category VARCHAR(30), -- 'sports','movies','news'
  hls_origin_url TEXT NOT NULL,
  logo_url TEXT
);

CREATE TABLE schedule (
  id BIGSERIAL PRIMARY KEY,
  channel_id INT NOT NULL REFERENCES channels(id), -- <span class="tag-fk">FK</span>
  program_title VARCHAR(255) NOT NULL,
  start_time TIMESTAMPTZ NOT NULL, -- <span class="tag-idx">IDX</span>
  end_time TIMESTAMPTZ NOT NULL,
  rating VARCHAR(10), -- 'TV-PG', 'TV-MA'
  description TEXT,
  series_id VARCHAR(50), -- <span class="tag-idx">IDX</span>
  episode_num VARCHAR(20),
  gracenote_id VARCHAR(30) -- <span class="tag-idx">IDX</span>
);
-- <span class="tag-idx">IDX</span>: (channel_id, start_time) for EPG queries</code></pre>
</div>
<div class="card">
<h3>Cassandra ‚Äî DVR & Playback</h3>
<pre><code>-- DVR Recordings (Cassandra for write-heavy, time-series)
CREATE TABLE dvr_recordings (
  user_id UUID,        -- <span class="tag-shard">PARTITION KEY</span>
  recording_id UUID,
  channel_id INT,
  program_title TEXT,
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  physical_recording_id UUID, -- dedup reference
  ad_manifest_url TEXT,
  watched_position INT,  -- seconds, for resume
  expires_at TIMESTAMP,
  PRIMARY KEY (user_id, recording_id)
) WITH default_time_to_live = 7776000; -- 90 days

-- Watch History / Resume Points
CREATE TABLE watch_progress (
  user_id UUID,         -- <span class="tag-shard">PARTITION KEY</span>
  content_id TEXT,      -- channel_id or vod_asset_id
  content_type TEXT,    -- 'live' | 'vod' | 'dvr'
  position_seconds INT,
  duration_seconds INT,
  last_updated TIMESTAMP,
  device_id TEXT,
  PRIMARY KEY (user_id, content_id)
);

-- Concurrent stream tracking (Redis better for this)
-- Key: account:{account_id}:streams
-- Value: SET of {device_id, stream_url, started_at}
-- SCARD for count check, SADD/SREM for manage</code></pre>
</div>
</div>

<h2>‚ö° Cache & CDN Deep Dive</h2>
<div class="card">
<table>
<tr><th>Layer</th><th>What</th><th>Strategy</th><th>TTL</th></tr>
<tr><td>CDN Edge (Akamai)</td><td>HLS segments + manifests</td><td>Pull-through, segment TTL = segment duration</td><td>6-10s (live), 24h (VOD)</td></tr>
<tr><td>Redis EPG Cache</td><td>Schedule grid data</td><td>Pre-computed per channel+day</td><td>1 hour</td></tr>
<tr><td>Redis Session</td><td>Auth tokens, entitlements</td><td>Write-through on login</td><td>30 min</td></tr>
<tr><td>Client Buffer</td><td>Video segments</td><td>ABR buffer: 30s ahead for live</td><td>Until played</td></tr>
<tr><td>Catalog Cache</td><td>VOD metadata, images</td><td>LRU, invalidate on catalog update</td><td>6 hours</td></tr>
</table>
<h4>CDN for Live Streaming</h4>
<pre><code>// Live HLS segment caching at CDN edge:
// Challenge: 300 channels √ó 5 quality levels √ó 6s segments
// = new segment every 6s per rendition = massive origin load

// Solution: CDN shield layer
// Edge ‚Üí Shield (regional) ‚Üí Origin
// Shield absorbs concurrent requests for same segment
// Request coalescing: 10K edge requests ‚Üí 1 origin request

// Manifest caching: very short TTL (1-2s) or server push
// Segment caching: TTL = segment duration (6s)
// Stale-while-revalidate for smooth playback</code></pre>
</div>

<h2>üìà Scaling Considerations</h2>
<div class="card">
<ul>
<li><strong>Super Bowl problem:</strong> 5M+ concurrent viewers on one channel. CDN pre-warms edge caches, dedicated origin capacity, regional failover. Predictive scaling based on event schedule.</li>
<li><strong>Concurrent stream enforcement:</strong> Redis SET per account tracks active streams. SCARD check before granting new stream. Challenge: device crash doesn't send stop ‚Üí heartbeat timeout (30s) cleans stale entries.</li>
<li><strong>EPG data volume:</strong> 300 channels √ó 24h √ó 14 days lookback = ~100K schedule entries. Redis can hold entire EPG in memory (~500MB). Shard by channel range.</li>
<li><strong>Regional blackout:</strong> Geo-IP lookup + blackout rules engine. Override CDN routing for blacked-out regions. Must handle VPN detection for sports blackouts.</li>
</ul>
</div>

<h2>‚öñÔ∏è Tradeoffs</h2>
<div class="tradeoff-grid">
<div class="card pro"><h4>SSAI (Server-Side Ads)</h4><ul><li>Ad-blocker resistant</li><li>Seamless stitching (no buffering)</li><li>Unified QoS metrics</li></ul></div>
<div class="card con"><h4>SSAI (Server-Side Ads)</h4><ul><li>Per-viewer manifest = higher origin load</li><li>Less interactive than CSAI</li><li>Complex CDN caching (personalized manifests uncacheable)</li></ul></div>
<div class="card pro"><h4>Cloud DVR (Copy-on-Write)</h4><ul><li>95%+ storage savings via dedup</li><li>Instant "recording" (just metadata)</li><li>No per-user storage limits needed</li></ul></div>
<div class="card con"><h4>Cloud DVR (Copy-on-Write)</h4><ul><li>Complex rights management per user</li><li>Ad replacement rules vary per user</li><li>Regulatory: some markets require unique copies</li></ul></div>
</div>

<h2>üîÑ Alternative Approaches</h2>
<div class="grid">
<div class="card"><h4>ATSC 3.0 (NextGen TV)</h4><p>IP-based broadcast standard replacing satellite. Combines over-the-air broadcast with internet delivery. Supports 4K HDR, immersive audio, targeted OTA ads. Hybrid approach: broadcast popular channels OTA, niche channels via IP.</p></div>
<div class="card"><h4>WebRTC for Ultra-Low Latency</h4><p>Sub-second latency for sports betting / interactive use cases. Replace HLS (3-30s latency) with WebRTC (&lt;500ms). Trade scalability (WebRTC needs media server per viewer) for interactivity. Use selectively for specific premium features.</p></div>
</div>

<h2>üìö Additional Information</h2>
<div class="card">
<ul>
<li><strong>CMAF (Common Media Application Format):</strong> unified segment format for both HLS and DASH. Single encoding pipeline serves Apple and non-Apple devices.</li>
<li><strong>Widevine L1/L3:</strong> L1 = hardware-backed DRM (required for HD/4K on Android/Chrome). L3 = software only (SD max). FairPlay for Apple, PlayReady for Windows.</li>
<li><strong>QoE metrics:</strong> time-to-first-frame, buffering ratio, bitrate stability, channel switch time. Tracked via client beacons to analytics pipeline (Conviva/NPAW).</li>
<li><strong>Failover:</strong> multi-CDN strategy (Akamai + CloudFront). Real-time CDN health monitoring. Client-side CDN switching on error (manifest contains alternate CDN URLs).</li>
</ul>
</div>

</body>
</html>
