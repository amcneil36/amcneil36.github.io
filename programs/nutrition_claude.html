<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Nutrition Tracker</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3347;
    --text: #e4e6f0;
    --text-dim: #8b8fa3;
    --accent: #6c8cff;
    --accent-hover: #8aa4ff;
    --danger: #ff6b6b;
    --danger-hover: #ff8787;
    --success: #51cf66;
    --green-dim: #2b4a2e;
    --radius: 10px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
  }

  .app {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
    padding-bottom: 100px;
  }

  header {
    text-align: center;
    padding: 20px 0 12px;
  }

  header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }

  header p {
    color: var(--text-dim);
    font-size: 13px;
    margin-top: 4px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border-radius: var(--radius);
    padding: 4px;
    margin-bottom: 20px;
  }

  .tab-btn {
    flex: 1;
    padding: 10px 0;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: var(--accent);
    color: #fff;
  }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 14px;
    color: var(--text);
  }

  /* Forms */
  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input, select {
    width: 100%;
    padding: 10px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
    appearance: none;
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b8fa3' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
  }

  input:focus, select:focus {
    border-color: var(--accent);
  }

  .form-row {
    margin-bottom: 12px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .form-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover, .btn-primary:active {
    background: var(--accent-hover);
  }

  .btn-danger {
    background: var(--danger);
    color: #fff;
  }

  .btn-danger:hover, .btn-danger:active {
    background: var(--danger-hover);
  }

  .btn-outline {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .btn-outline:hover, .btn-outline:active {
    border-color: var(--text-dim);
    color: var(--text);
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
    width: auto;
  }

  /* Food library list */
  .food-list {
    list-style: none;
  }

  .food-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }

  .food-item:last-child { border-bottom: none; }

  .food-item-name {
    font-weight: 600;
    font-size: 15px;
  }

  .food-item-meta {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .food-item-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .icon-btn {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: transparent;
    color: var(--text-dim);
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .icon-btn:hover { border-color: var(--text-dim); color: var(--text); }
  .icon-btn.danger:hover { border-color: var(--danger); color: var(--danger); }

  /* Log table */
  .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -16px;
    padding: 0 16px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 500px;
  }

  th {
    text-align: left;
    padding: 8px 10px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
  }

  td {
    padding: 10px 10px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tr.total-row td {
    font-weight: 700;
    border-top: 2px solid var(--accent);
    border-bottom: none;
    color: var(--accent);
    padding-top: 12px;
  }

  .delete-log-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .delete-log-btn:hover { color: var(--danger); }

  /* Date navigation */
  .date-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .date-nav button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    width: 36px;
    height: 36px;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .date-nav button:hover { border-color: var(--accent); }

  .date-nav .date-label {
    font-weight: 700;
    font-size: 15px;
    min-width: 140px;
    text-align: center;
  }

  /* Serving info line */
  .serving-info {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
    font-style: italic;
  }

  /* Amount mode toggle */
  .mode-toggle {
    display: flex;
    gap: 4px;
    background: var(--bg);
    border-radius: 8px;
    padding: 3px;
    margin-bottom: 8px;
  }

  .mode-toggle button {
    flex: 1;
    padding: 6px 0;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mode-toggle button.active {
    background: var(--surface2);
    color: var(--text);
  }

  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--text-dim);
    font-size: 14px;
  }

  .empty-state .emoji {
    font-size: 32px;
    margin-bottom: 8px;
    display: block;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--success);
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 999;
    pointer-events: none;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    width: 100%;
    max-width: 440px;
    max-height: 85vh;
    overflow-y: auto;
  }

  .modal-title {
    font-size: 17px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }

  .modal-actions .btn { flex: 1; }

  /* Responsive helpers */
  @media (max-width: 400px) {
    .form-grid, .form-grid-3 {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>ü•ó Nutrition Tracker</h1>
    <p>Track what you eat, every day</p>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="log">Daily Log</button>
    <button class="tab-btn" data-tab="foods">My Foods</button>
  </div>

  <!-- DAILY LOG TAB -->
  <div id="tab-log" class="tab-panel active">
    <div class="date-nav">
      <button id="prev-day">‚Äπ</button>
      <span class="date-label" id="date-label"></span>
      <button id="next-day">‚Ä∫</button>
    </div>

    <div class="card">
      <div class="card-title">Log a Meal</div>
      <div class="form-row">
        <label for="log-food-select">Food</label>
        <select id="log-food-select">
          <option value="">‚Äî Select a food ‚Äî</option>
        </select>
      </div>
      <div class="form-row">
        <label>Amount</label>
        <div class="mode-toggle">
          <button class="active" id="mode-grams-btn">Grams</button>
          <button id="mode-serving-btn">Servings</button>
        </div>
        <div id="grams-input-wrap">
          <input type="number" id="log-grams" placeholder="e.g. 100" inputmode="decimal" min="0" step="any">
        </div>
        <div id="serving-input-wrap" style="display:none;">
          <input type="number" id="log-servings" placeholder="e.g. 2" inputmode="decimal" min="0" step="any">
          <div class="serving-info" id="serving-info-text"></div>
        </div>
      </div>
      <button class="btn btn-primary" id="log-btn">+ Add to Log</button>
    </div>

    <div class="card">
      <div class="card-title">Today's Intake</div>
      <div class="table-wrap">
        <table id="log-table">
          <thead>
            <tr>
              <th>Food</th>
              <th>Grams</th>
              <th>Cal</th>
              <th>Fat</th>
              <th>Carbs</th>
              <th>Protein</th>
              <th>Sugar</th>
              <th>Fiber</th>
              <th>Sodium</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="log-body"></tbody>
        </table>
      </div>
      <div class="empty-state" id="log-empty">
        <span class="emoji">üçΩÔ∏è</span>
        Nothing logged yet. Add some food above!
      </div>
    </div>
  </div>

  <!-- MY FOODS TAB -->
  <div id="tab-foods" class="tab-panel">
    <div class="card">
      <div class="card-title">Add New Food</div>
      <div class="form-row">
        <label for="food-name">Food Name</label>
        <input type="text" id="food-name" placeholder="e.g. Egg">
      </div>
      <div class="form-row">
        <label for="food-serving-size">Serving Size (grams)</label>
        <input type="number" id="food-serving-size" placeholder="e.g. 50" inputmode="decimal" min="0" step="any">
      </div>
      <p style="color:var(--text-dim);font-size:12px;margin-bottom:10px;margin-top:2px;">Enter nutrition facts <strong>per serving</strong> (the serving size above).</p>
      <div class="form-grid">
        <div class="form-row">
          <label for="food-cal">Calories</label>
          <input type="number" id="food-cal" placeholder="0" inputmode="decimal" min="0" step="any">
        </div>
        <div class="form-row">
          <label for="food-fat">Fat (g)</label>
          <input type="number" id="food-fat" placeholder="0" inputmode="decimal" min="0" step="any">
        </div>
        <div class="form-row">
          <label for="food-carbs">Carbs (g)</label>
          <input type="number" id="food-carbs" placeholder="0" inputmode="decimal" min="0" step="any">
        </div>
        <div class="form-row">
          <label for="food-protein">Protein (g)</label>
          <input type="number" id="food-protein" placeholder="0" inputmode="decimal" min="0" step="any">
        </div>
        <div class="form-row">
          <label for="food-sugar">Sugar (g)</label>
          <input type="number" id="food-sugar" placeholder="0" inputmode="decimal" min="0" step="any">
        </div>
        <div class="form-row">
          <label for="food-fiber">Fiber (g)</label>
          <input type="number" id="food-fiber" placeholder="0" inputmode="decimal" min="0" step="any">
        </div>
      </div>
      <div class="form-row">
        <label for="food-sodium">Sodium (mg)</label>
        <input type="number" id="food-sodium" placeholder="0" inputmode="decimal" min="0" step="any">
      </div>
      <button class="btn btn-primary" id="save-food-btn">Save Food</button>
    </div>

    <div class="card">
      <div class="card-title">My Food Library</div>
      <ul class="food-list" id="food-list"></ul>
      <div class="empty-state" id="foods-empty">
        <span class="emoji">üìù</span>
        No foods yet. Add one above!
      </div>
    </div>
  </div>
</div>

<!-- Edit Food Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title">Edit Food</div>
    <input type="hidden" id="edit-food-id">
    <div class="form-row">
      <label for="edit-food-name">Food Name</label>
      <input type="text" id="edit-food-name">
    </div>
    <div class="form-row">
      <label for="edit-food-serving-size">Serving Size (grams)</label>
      <input type="number" id="edit-food-serving-size" inputmode="decimal" min="0" step="any">
    </div>
    <p style="color:var(--text-dim);font-size:12px;margin-bottom:10px;margin-top:2px;">Nutrition facts <strong>per serving</strong>.</p>
    <div class="form-grid">
      <div class="form-row">
        <label for="edit-food-cal">Calories</label>
        <input type="number" id="edit-food-cal" inputmode="decimal" min="0" step="any">
      </div>
      <div class="form-row">
        <label for="edit-food-fat">Fat (g)</label>
        <input type="number" id="edit-food-fat" inputmode="decimal" min="0" step="any">
      </div>
      <div class="form-row">
        <label for="edit-food-carbs">Carbs (g)</label>
        <input type="number" id="edit-food-carbs" inputmode="decimal" min="0" step="any">
      </div>
      <div class="form-row">
        <label for="edit-food-protein">Protein (g)</label>
        <input type="number" id="edit-food-protein" inputmode="decimal" min="0" step="any">
      </div>
      <div class="form-row">
        <label for="edit-food-sugar">Sugar (g)</label>
        <input type="number" id="edit-food-sugar" inputmode="decimal" min="0" step="any">
      </div>
      <div class="form-row">
        <label for="edit-food-fiber">Fiber (g)</label>
        <input type="number" id="edit-food-fiber" inputmode="decimal" min="0" step="any">
      </div>
    </div>
    <div class="form-row">
      <label for="edit-food-sodium">Sodium (mg)</label>
      <input type="number" id="edit-food-sodium" inputmode="decimal" min="0" step="any">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" id="edit-cancel-btn">Cancel</button>
      <button class="btn btn-primary" id="edit-save-btn">Save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(function() {
  // ---------- DATA LAYER ----------
  const FOODS_KEY = 'nt_foods';
  const LOG_KEY   = 'nt_log';

  function loadFoods() {
    try { return JSON.parse(localStorage.getItem(FOODS_KEY)) || []; }
    catch { return []; }
  }

  function saveFoods(foods) {
    localStorage.setItem(FOODS_KEY, JSON.stringify(foods));
  }

  function loadLog() {
    try { return JSON.parse(localStorage.getItem(LOG_KEY)) || {}; }
    catch { return {}; }
  }

  function saveLog(log) {
    localStorage.setItem(LOG_KEY, JSON.stringify(log));
  }

  function getLogForDate(dateStr) {
    const log = loadLog();
    return log[dateStr] || [];
  }

  function setLogForDate(dateStr, entries) {
    const log = loadLog();
    if (entries.length === 0) {
      delete log[dateStr];
    } else {
      log[dateStr] = entries;
    }
    saveLog(log);
  }

  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  // ---------- DATE HELPERS ----------
  let currentDate = new Date();

  function toDateStr(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function formatDateLabel(d) {
    const today = new Date();
    const todayStr = toDateStr(today);
    const dateStr = toDateStr(d);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = toDateStr(yesterday);

    if (dateStr === todayStr) return 'Today';
    if (dateStr === yesterdayStr) return 'Yesterday';
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  }

  // ---------- DOM REFS ----------
  const $tabBtns        = document.querySelectorAll('.tab-btn');
  const $tabLog         = document.getElementById('tab-log');
  const $tabFoods       = document.getElementById('tab-foods');
  const $dateLabel      = document.getElementById('date-label');
  const $prevDay        = document.getElementById('prev-day');
  const $nextDay        = document.getElementById('next-day');
  const $logSelect      = document.getElementById('log-food-select');
  const $logGrams       = document.getElementById('log-grams');
  const $logServings    = document.getElementById('log-servings');
  const $logBtn         = document.getElementById('log-btn');
  const $logBody        = document.getElementById('log-body');
  const $logEmpty       = document.getElementById('log-empty');
  const $logTable       = document.getElementById('log-table');
  const $modeGramsBtn   = document.getElementById('mode-grams-btn');
  const $modeServingBtn = document.getElementById('mode-serving-btn');
  const $gramsWrap      = document.getElementById('grams-input-wrap');
  const $servingWrap    = document.getElementById('serving-input-wrap');
  const $servingInfo    = document.getElementById('serving-info-text');
  const $foodName       = document.getElementById('food-name');
  const $foodServing    = document.getElementById('food-serving-size');
  const $foodCal        = document.getElementById('food-cal');
  const $foodFat        = document.getElementById('food-fat');
  const $foodCarbs      = document.getElementById('food-carbs');
  const $foodProtein    = document.getElementById('food-protein');
  const $foodSugar      = document.getElementById('food-sugar');
  const $foodFiber      = document.getElementById('food-fiber');
  const $foodSodium     = document.getElementById('food-sodium');
  const $saveFoodBtn    = document.getElementById('save-food-btn');
  const $foodList       = document.getElementById('food-list');
  const $foodsEmpty     = document.getElementById('foods-empty');
  const $editModal      = document.getElementById('edit-modal');
  const $editId         = document.getElementById('edit-food-id');
  const $editName       = document.getElementById('edit-food-name');
  const $editServing    = document.getElementById('edit-food-serving-size');
  const $editCal        = document.getElementById('edit-food-cal');
  const $editFat        = document.getElementById('edit-food-fat');
  const $editCarbs      = document.getElementById('edit-food-carbs');
  const $editProtein    = document.getElementById('edit-food-protein');
  const $editSugar      = document.getElementById('edit-food-sugar');
  const $editFiber      = document.getElementById('edit-food-fiber');
  const $editSodium     = document.getElementById('edit-food-sodium');
  const $editCancel     = document.getElementById('edit-cancel-btn');
  const $editSave       = document.getElementById('edit-save-btn');
  const $toast          = document.getElementById('toast');

  let amountMode = 'grams'; // 'grams' or 'servings'

  // ---------- TOAST ----------
  let toastTimer;
  function showToast(msg) {
    clearTimeout(toastTimer);
    $toast.textContent = msg;
    $toast.classList.add('show');
    toastTimer = setTimeout(() => $toast.classList.remove('show'), 2000);
  }

  // ---------- TABS ----------
  $tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      $tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $tabLog.classList.toggle('active', tab === 'log');
      $tabFoods.classList.toggle('active', tab === 'foods');
    });
  });

  // ---------- DATE NAV ----------
  function renderDate() {
    $dateLabel.textContent = formatDateLabel(currentDate);
  }

  $prevDay.addEventListener('click', () => {
    currentDate.setDate(currentDate.getDate() - 1);
    renderDate();
    renderLog();
  });

  $nextDay.addEventListener('click', () => {
    currentDate.setDate(currentDate.getDate() + 1);
    renderDate();
    renderLog();
  });

  // ---------- AMOUNT MODE TOGGLE ----------
  $modeGramsBtn.addEventListener('click', () => {
    amountMode = 'grams';
    $modeGramsBtn.classList.add('active');
    $modeServingBtn.classList.remove('active');
    $gramsWrap.style.display = '';
    $servingWrap.style.display = 'none';
  });

  $modeServingBtn.addEventListener('click', () => {
    amountMode = 'servings';
    $modeServingBtn.classList.add('active');
    $modeGramsBtn.classList.remove('active');
    $gramsWrap.style.display = 'none';
    $servingWrap.style.display = '';
    updateServingInfo();
  });

  $logSelect.addEventListener('change', () => {
    updateServingInfo();
  });

  function updateServingInfo() {
    const foodId = $logSelect.value;
    if (!foodId) { $servingInfo.textContent = ''; return; }
    const food = loadFoods().find(f => f.id === foodId);
    if (food && food.servingSize) {
      $servingInfo.textContent = `1 serving = ${food.servingSize}g`;
    } else {
      $servingInfo.textContent = 'No serving size defined for this food.';
    }
  }

  // ---------- RENDER FOOD SELECT ----------
  function renderFoodSelect() {
    const foods = loadFoods();
    const val = $logSelect.value;
    $logSelect.innerHTML = '<option value="">‚Äî Select a food ‚Äî</option>';
    foods.sort((a, b) => a.name.localeCompare(b.name)).forEach(f => {
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = f.name;
      $logSelect.appendChild(opt);
    });
    if (val) $logSelect.value = val;
  }

  // ---------- RENDER FOOD LIBRARY ----------
  function renderFoodLibrary() {
    const foods = loadFoods();
    $foodList.innerHTML = '';
    $foodsEmpty.style.display = foods.length ? 'none' : '';

    foods.sort((a, b) => a.name.localeCompare(b.name)).forEach(f => {
      const li = document.createElement('li');
      li.className = 'food-item';
      const servingText = f.servingSize ? ` ¬∑ Serving: ${r(f.servingSize)}g` : '';
      li.innerHTML = `
        <div>
          <div class="food-item-name">${esc(f.name)}</div>
          <div class="food-item-meta">Per serving${servingText}: ${r(f.cal)} cal ¬∑ ${r(f.fat)}f ¬∑ ${r(f.carbs)}c ¬∑ ${r(f.protein)}p</div>
        </div>
        <div class="food-item-actions">
          <button class="icon-btn edit-food-btn" data-id="${f.id}" title="Edit">‚úé</button>
          <button class="icon-btn danger delete-food-btn" data-id="${f.id}" title="Delete">‚úï</button>
        </div>`;
      $foodList.appendChild(li);
    });

    document.querySelectorAll('.edit-food-btn').forEach(btn =>
      btn.addEventListener('click', () => openEditModal(btn.dataset.id))
    );
    document.querySelectorAll('.delete-food-btn').forEach(btn =>
      btn.addEventListener('click', () => deleteFood(btn.dataset.id))
    );
  }

  // ---------- SAVE FOOD ----------
  $saveFoodBtn.addEventListener('click', () => {
    const name = $foodName.value.trim();
    if (!name) { showToast('Enter a food name'); return; }
    const servingSize = parseFloat($foodServing.value) || 0;
    if (!servingSize || servingSize <= 0) { showToast('Enter a serving size'); return; }

    const food = {
      id: generateId(),
      name,
      servingSize: parseFloat($foodServing.value) || 0,
      cal:     parseFloat($foodCal.value) || 0,
      fat:     parseFloat($foodFat.value) || 0,
      carbs:   parseFloat($foodCarbs.value) || 0,
      protein: parseFloat($foodProtein.value) || 0,
      sugar:   parseFloat($foodSugar.value) || 0,
      fiber:   parseFloat($foodFiber.value) || 0,
      sodium:  parseFloat($foodSodium.value) || 0,
    };

    const foods = loadFoods();
    foods.push(food);
    saveFoods(foods);

    [$foodName, $foodServing, $foodCal, $foodFat, $foodCarbs, $foodProtein, $foodSugar, $foodFiber, $foodSodium].forEach(el => el.value = '');

    renderFoodLibrary();
    renderFoodSelect();
    showToast(`${food.name} saved!`);
  });

  // ---------- DELETE FOOD ----------
  function deleteFood(id) {
    if (!confirm('Delete this food?')) return;
    let foods = loadFoods();
    const removed = foods.find(f => f.id === id);
    foods = foods.filter(f => f.id !== id);
    saveFoods(foods);
    renderFoodLibrary();
    renderFoodSelect();
    if (removed) showToast(`${removed.name} deleted`);
  }

  // ---------- EDIT MODAL ----------
  function openEditModal(id) {
    const food = loadFoods().find(f => f.id === id);
    if (!food) return;
    $editId.value       = food.id;
    $editName.value     = food.name;
    $editServing.value  = food.servingSize || '';
    $editCal.value      = food.cal || '';
    $editFat.value      = food.fat || '';
    $editCarbs.value    = food.carbs || '';
    $editProtein.value  = food.protein || '';
    $editSugar.value    = food.sugar || '';
    $editFiber.value    = food.fiber || '';
    $editSodium.value   = food.sodium || '';
    $editModal.classList.add('active');
  }

  $editCancel.addEventListener('click', () => $editModal.classList.remove('active'));
  $editModal.addEventListener('click', (e) => {
    if (e.target === $editModal) $editModal.classList.remove('active');
  });

  $editSave.addEventListener('click', () => {
    const id = $editId.value;
    const name = $editName.value.trim();
    if (!name) { showToast('Enter a food name'); return; }

    const foods = loadFoods();
    const idx = foods.findIndex(f => f.id === id);
    if (idx === -1) return;

    foods[idx] = {
      ...foods[idx],
      name,
      servingSize: parseFloat($editServing.value) || 0,
      cal:     parseFloat($editCal.value) || 0,
      fat:     parseFloat($editFat.value) || 0,
      carbs:   parseFloat($editCarbs.value) || 0,
      protein: parseFloat($editProtein.value) || 0,
      sugar:   parseFloat($editSugar.value) || 0,
      fiber:   parseFloat($editFiber.value) || 0,
      sodium:  parseFloat($editSodium.value) || 0,
    };

    saveFoods(foods);
    $editModal.classList.remove('active');
    renderFoodLibrary();
    renderFoodSelect();
    renderLog();
    showToast(`${name} updated!`);
  });

  // ---------- LOG FOOD ----------
  $logBtn.addEventListener('click', () => {
    const foodId = $logSelect.value;
    if (!foodId) { showToast('Select a food first'); return; }

    const food = loadFoods().find(f => f.id === foodId);
    if (!food) { showToast('Food not found'); return; }

    let grams;
    let servingsLogged;
    if (amountMode === 'grams') {
      grams = parseFloat($logGrams.value);
      if (!grams || grams <= 0) { showToast('Enter grams'); return; }
      servingsLogged = (food.servingSize > 0) ? grams / food.servingSize : null;
    } else {
      servingsLogged = parseFloat($logServings.value);
      if (!servingsLogged || servingsLogged <= 0) { showToast('Enter servings'); return; }
      if (!food.servingSize || food.servingSize <= 0) {
        showToast('No serving size defined for this food');
        return;
      }
      grams = servingsLogged * food.servingSize;
    }

    const dateStr = toDateStr(currentDate);
    const entries = getLogForDate(dateStr);
    entries.push({
      id: generateId(),
      foodId: food.id,
      foodName: food.name,
      grams,
    });
    setLogForDate(dateStr, entries);

    $logGrams.value = '';
    $logServings.value = '';
    renderLog();
    showToast(`${food.name} logged!`);
  });

  // ---------- RENDER LOG TABLE ----------
  function renderLog() {
    const dateStr = toDateStr(currentDate);
    const entries = getLogForDate(dateStr);
    const foods = loadFoods();

    $logBody.innerHTML = '';
    $logEmpty.style.display = entries.length ? 'none' : '';
    $logTable.style.display = entries.length ? '' : 'none';

    if (!entries.length) return;

    const totals = { cal: 0, fat: 0, carbs: 0, protein: 0, sugar: 0, fiber: 0, sodium: 0, grams: 0 };

    entries.forEach(entry => {
      const food = foods.find(f => f.id === entry.foodId);
      const servSize = food ? (food.servingSize || 1) : 1;
      const mult = entry.grams / servSize;
      const cal     = food ? food.cal * mult : 0;
      const fat     = food ? food.fat * mult : 0;
      const carbs   = food ? food.carbs * mult : 0;
      const protein = food ? food.protein * mult : 0;
      const sugar   = food ? food.sugar * mult : 0;
      const fiber   = food ? food.fiber * mult : 0;
      const sodium  = food ? food.sodium * mult : 0;

      totals.grams += entry.grams;
      totals.cal += cal;
      totals.fat += fat;
      totals.carbs += carbs;
      totals.protein += protein;
      totals.sugar += sugar;
      totals.fiber += fiber;
      totals.sodium += sodium;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(entry.foodName)}</td>
        <td>${r(entry.grams)}</td>
        <td>${r(cal)}</td>
        <td>${r(fat)}g</td>
        <td>${r(carbs)}g</td>
        <td>${r(protein)}g</td>
        <td>${r(sugar)}g</td>
        <td>${r(fiber)}g</td>
        <td>${r(sodium)}mg</td>
        <td><button class="delete-log-btn" data-date="${dateStr}" data-id="${entry.id}" title="Remove">‚úï</button></td>`;
      $logBody.appendChild(tr);
    });

    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
      <td>Total</td>
      <td>${r(totals.grams)}</td>
      <td>${r(totals.cal)}</td>
      <td>${r(totals.fat)}g</td>
      <td>${r(totals.carbs)}g</td>
      <td>${r(totals.protein)}g</td>
      <td>${r(totals.sugar)}g</td>
      <td>${r(totals.fiber)}g</td>
      <td>${r(totals.sodium)}mg</td>
      <td></td>`;
    $logBody.appendChild(totalRow);

    document.querySelectorAll('.delete-log-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const d = btn.dataset.date;
        const id = btn.dataset.id;
        let entries = getLogForDate(d);
        entries = entries.filter(e => e.id !== id);
        setLogForDate(d, entries);
        renderLog();
        showToast('Entry removed');
      });
    });
  }

  // ---------- HELPERS ----------
  function r(n) {
    if (n === 0) return '0';
    if (Math.abs(n) >= 100) return Math.round(n).toString();
    const s = n.toFixed(1);
    return s.endsWith('.0') ? s.slice(0, -2) : s;
  }

  function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // ---------- INIT ----------
  renderDate();
  renderFoodSelect();
  renderFoodLibrary();
  renderLog();
})();
</script>
</body>
</html>
